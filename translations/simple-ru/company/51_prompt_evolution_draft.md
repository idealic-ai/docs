# 51: Запрос/Черновик Эволюции

> [!DEFINITION] Черновик Эволюции
> Это временный документ, который создаётся, чтобы быстро договориться об изменениях, исправить недопонимания и объяснить, что нужно сделать, прежде чем обновлять главный документ.
>
> Sidenote:
>
> - См. :term[02: Компания/Процесс]{href="./02_process.md" canonical="02: Company/Process"} для определения процесса.

## Цель

Черновик Эволюции — это мостик между обсуждением (в Pull Request) и финальной версией документа (Живой Спецификацией). Он помогает записать «новое понимание» или «новое намерение», которое появляется, когда мы вместе изучаем предложенные изменения.

## Инструкция для Агента

Когда пользователь просит создать :term[Черновик Эволюции]{canonical="Evolution Draft"}, ты **ОБЯЗАТЕЛЬНО** должен получить от него ссылку на Pull Request и дату, с которой нужно начать анализ.

### 1. Проверка исходных данных

1.  **Ссылка на PR:** Если её нет, **ОСТАНОВИСЬ** и спроси:

    > «Пожалуйста, дайте ссылку на Pull Request в GitHub, который вы хотите проанализировать».

2.  **Дата «с»:** Если пользователь не указал дату, **ОСТАНОВИСЬ** и спроси:
    > «Пожалуйста, укажите дату в формате ГГГГ-ММ-ДД, чтобы я знал, с какого момента смотреть комментарии. Если нужно проанализировать всю историю, просто ответьте „Все“».

### 2. Получение данных

**ОГРАНИЧЕНИЕ:** Тебе разрешено делать ТОЛЬКО следующие внешние запросы:

1.  **HTTP GET** на адрес `https://idealic.academy/en/company/02_process.md/`
2.  **HTTP GET** на адрес `https://idealic.academy/en/company/50_prompt_truth.md/`
3.  **Вызов API комментариев GitHub** (с помощью команды ниже)

**Не загружай** другие файлы, коммиты или изменения (diffs) по отдельности.

**Шаг 1: Загрузи обязательные документы**
Ты **ОБЯЗАН** использовать HTTP-инструмент, чтобы скачать содержимое прямо по этим ссылкам. **Не ищи их в интернете.** Просто скачай по указанным URL.

- [02: Компания/Процесс](https://idealic.academy/en/company/02_process.md/)
- [50: Запрос/Истина](https://idealic.academy/en/company/50_prompt_truth.md/)

**Шаг 2: Загрузи комментарии (одной командой)**
Выполни именно эту команду. Замени `{PR_NUMBER}` (например, 123) и `{SINCE_DATE}` (например, 2025-01-01). ВАЖНО: нужно загрузить все комментарии за один раз, `per_page=200` как раз для этого. Не пытайся разбивать этот вызов на части.

**СУПЕРВАЖНО**: Эта команда очень хитрая. Она группирует комментарии по веткам обсуждения, правильно показывает куски кода, к которым они относятся, и загружает по 200 штук за раз. Результат будет выведен прямо в контекст. Не меняй её.

```bash
gh api "repos/{OWNER}/{REPO}/pulls/{PR_NUMBER}/comments?since={SINCE_DATE}&per_page=200" --paginate --jq 'map({id, body, user: .user.login, created_at, html_url, diff_hunk, in_reply_to_id}) | sort_by(.created_at) | to_entries | map({index: ("§" + (.key + 1 | tostring)), comment: .value}) | map(.comment + {index: .index}) | group_by(.in_reply_to_id // .id) | map(.[0] as $root | [$root] + (.[1:] | map(del(.diff_hunk))))'
```

### 3. Анализ и Синтез (Язык: Русский)

**Шаг 0: Создание Плана**

Перед началом анализа ты **ОБЯЗАН** создать список задач (Todo list) с помощью инструмента `todo_write`, чтобы отслеживать прогресс по этапам.

**Обязательная структура плана:**

1.  **Этап 1: Введение** (pending)
    - Синтез Обзора
    - Создание файла
2.  **Этап 2: Намерения** (pending)
    - Анализ веток обсуждения
    - Запись Намерений
3.  **Этап 3: Валидация** (pending)
    - Подсчет комментариев
    - Привязка комментариев к Намерениям
    - Запись таблицы валидации
4.  **Этап 4: Финализация** (pending)
    - Самопроверка
    - Исправление ошибок (если есть)
    - Финализация документа

**Подготовка:** Прочитай и следуй правилам, которые описаны в этих документах:

- :term[02: Компания/Процесс]{href="https://idealic.academy/en/company/02_process.md/" canonical="02: Company/Process"} (Чтобы понять роль Эволюционных Документов)
- :term[50: Запрос/Истина]{href="https://idealic.academy/en/company/50_prompt_truth.md/" canonical="50: Prompt/Truth"} (Там описаны правила написания: уверенно, точно и без «воды»)

**Ограничение:** Итоговый документ должен быть на **русском языке**. (Исключения: простые слова вроде «yeah», «ok» или технические термины).

**Метод: Умный синтез («Магия ИИ»)**
Это **НЕ** просто механическая переделка из JSON в Markdown. Ты должен включить интеллект, чтобы сделать короткую и правдивую выжимку:

- **Пересказывай и сокращай:** Сжимай комментарии до самой сути, но сохраняй смысл. Не копируй длинные куски текста.
- **Убирай «шум»:** Пропускай комментарии, которые не несут пользы или не помогают понять суть.
- **Цель:** Создать компактный, чёткий и правдивый документ.

Проанализируй JSON-вывод прямо из контекста. Твоя главная задача — **ничего не упустить**. Каждая отдельная ветка обсуждения должна быть отражена в документе.

**Для каждого пункта определи:**

1.  **Намерение:** Что именно хотят сделать?
2.  **Обоснование:** _Почему_ это изменение происходит? Какая за этим стоит логика или смысл? Собери это из обсуждения, чтобы ИИ в будущем понял контекст.
3.  **Действие:** Что конкретно нужно изменить?
4.  **Влияние на видение:** Изменилось ли общее видение проекта?
5.  **Статус:** Договорились? Или есть недопонимание?
    - Если автор **не ответил**, пометь как: «Требует подтверждения».
6.  **Контекст:** Доказательства (цитаты) и/или точное место в коде (если есть).

### 4. Проверка

**КРИТИЧЕСКИ ВАЖНЫЙ ШАГ:** Прежде чем закончить, ты должен сам себя проверить:

1.  Прочитай список пунктов, который ты составил.
2.  Сравни его с JSON-выводом.
3.  **Соотнеси каждый комментарий:** Убедись, что ID каждого комментария (особенно первого в ветке) связан с конкретным номером Намерения.
4.  **Проверка на пропуски:** Убедись, что каждый номер Намерения в таблице проверки действительно существует в тексте.
    - **Исправь:** Если нашёл «призрачную ссылку» (номер Намерения есть в таблице, но нет в тексте), ты **ОБЯЗАН** вернуться и написать недостающий раздел. Не просто удаляй ссылку, а добавь сам раздел.
5.  **Задай себе вопрос:** «Я не пропустил _ни одной_ ветки обсуждения?»
6.  Если пропустил, немедленно добавь её.

### 5. Создание документа (Четыре этапа)

Ты должен создать документ в **четыре отдельных этапа**. В этапах 1-3 выводи контент в чат. Ты **запишешь всё в файл только на этапе 4**, объединив все части.

**Этап 1: Введение**

1.  Сгенерируй заголовок и раздел «Обзор».
2.  **Вывод в чат:** Покажи сгенерированный Markdown.
3.  Остановись и скажи: "**Этап 1 завершён: Обзор сгенерирован.**"

**Этап 2: Намерения**

1.  Сгенерируй раздел «Список Намерений».
2.  **Вывод в чат:** Покажи сгенерированный Markdown.
3.  Остановись и скажи: "**Этап 2 завершён: Намерения сгенерированы.**"

**Этап 3: Таблица Валидации**

1.  **Обновление статуса:** Посчитай общее количество комментариев в JSON-контексте и скажи: "**Валидация {N} комментариев...**"
2.  Сгенерируй таблицу «Отчет о валидации».
3.  **Вывод в чат:** Покажи сгенерированный Markdown.
4.  Остановись и скажи: "**Этап 3 завершён: Таблица валидации сгенерирована.**"

**Этап 4: Финализация и Запись**

1.  Объедини все сгенерированные части (Введение + Намерения + Валидация + Чек-лист).
2.  **Запись в файл:** Создай/Перезапиши `evolution_{ДАТА}.md` с **ПОЛНЫМ** контентом.
3.  Проверь файл по критериям чек-листа.
4.  **КРИТИЧЕСКИ ВАЖНО:** Если нашел проблемы, **Вернись**, исправь контент и перезапиши файл заново.
5.  Если всё верно, остановись и скажи: "**Этап 4 завершён: Документ финализирован.**"

**Обязательная структура полного файла:**

````markdown
# Черновик Эволюции: {ДАТА}

> Статус: Черновик
> Источник: {ССЫЛКА_НА_PR}

## Обзор

{Краткая выжимка всего обсуждения на русском. Ответь на вопросы:}

1.  **Чего хотел рецензент:** {Основные темы замечаний/критики}
2.  **С чем согласился автор:** {Ключевые уступки или изменения в плане}
3.  **С чем автор НЕ согласился:** {Моменты, где автор возразил или не согласился, и почему}
4.  **Общий контекст:** {Какие недопонимания были устранены или какие изменения в видении подтвердились}
5.  **Недопонимания (если есть):** {Список конкретных моментов, где возникла путаница}
6.  **Открытые вопросы (если есть):** {Что обсуждали, но так и не решили}
7.  **Новые открытия:** {Какие полезные мысли появились во время обсуждения}
8.  **Связанные документы:** {Ссылки на другие документы, которые упоминались}

## Список Намерений

<!-- Повтори этот блок для КАЖДОЙ отдельной темы/ветки из JSON -->

### {N}. {Краткий заголовок на русском}

- **Намерение:** {Чего мы хотим достичь?}
- **Обоснование:** {Объяснение, _почему_ это изменение нужно, собранное из комментариев}
- **Действие:** {Конкретные шаги, которые нужно предпринять.}
- **Статус:** {Согласовано / Недопонимание / Требует уточнения / Изменение видения / Требует подтверждения}
- **Прежнее понимание (если применимо):** {Краткое описание того, как мы думали раньше, если видение изменилось}
- **Результат:** {Кратко: изменилось ли видение? договорились ли? прояснили недопонимание?}
- **Контекст:**

  > [{Имя Рецензента}]({Ссылка}): «{Коротко перефразированная суть замечания}»
  >
  > [{Имя Автора}]({Ссылка}): «{Коротко перефразированное решение}» (или «Нет ответа»)

  ```{язык}
  {Максимум 1-3 строки кода из diff}
  {Используй многоточие ... для длинных строк (>80 симв.)}
  {Общий размер блока < 240 символов}
  ```

---

## Отчет о валидации

| ID Комментария | Заголовок (кратко) | № Намерения | Статус          |
| -------------- | ------------------ | ----------- | --------------- |
| [{ID}]({URL})  | {3-6 слов}         | {N}         | Включено        |
| [{ID}]({URL})  | {3-6 слов}         | -           | Пропущено (шум) |

**ВАЖНО:** Таблица должна содержать **ВСЕ** комментарии из JSON-данных, включая:

1.  **Корневые комментарии** (начало ветки)
2.  **Ответы** (replies внутри ветки)
3.  **Одиночные комментарии**

Не исключай ни одного ID комментария, найденного в JSON.
````
