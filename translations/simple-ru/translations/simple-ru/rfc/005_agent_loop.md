# 005: Агент/Цикл

> **Цикл:** Представь, что агент — это робот, который выполняет большую задачу по частям. Цикл — это его рабочий процесс: он смотрит на задачу (`Запрос`), получает список шагов (`Вызовы`), выполняет их, а потом смотрит, что получилось, и снова спрашивает, что делать дальше. И так по кругу, пока вся работа не будет сделана. — [Глоссарий](./000_glossary.md)

> Sidenote:
>
> - Требуется:
>   - [001: Агент/Запрос](./001_agent_request.md)
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

Этот документ объясняет, как устроен **Цикл** агента. Это как внутренний моторчик, который позволяет ему думать и действовать, чтобы решать сложные задачи шаг за шагом.

## Цикл выполнения

> Sidenote:
>
> ```mermaid
> graph TD
>     Start((Старт)) --> AssembleContext(Собрать информацию)
>     AssembleContext --> InvokeRequest(Сделать запрос)
>     InvokeRequest --> HasCalls{В решении есть команды?}
>     HasCalls -- Нет --> Stop((Конец))
>     HasCalls -- Да --> HITL{Контроль человеком}
>     HITL -- Одобрено --> ExecuteCalls(Выполнить команды)
>     ExecuteCalls -- Результаты --> AssembleContext
>     HITL -- Исправлено --> AssembleContext
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```

Цикл — это основной способ, которым агент работает самостоятельно. Давай разберём его по шагам, как будто мы собираем модель из LEGO.

1.  **Сбор информации:** Прежде чем начать строить, ты высыпаешь все детали на стол и смотришь, что у тебя есть. Агент делает то же самое: он собирает всю информацию — какая у него цель, что он уже успел сделать (`Состояние`) и какие у него есть «суперсилы» (`Инструменты`).

2.  **Отправка запроса:** Когда все «детали» перед ним, агент обращается к своему «мозгу» с **[Запросом](./001_agent_request.md)**. Это как спросить у очень умного друга: «Смотри, вот цель и вот мои инструменты. Какой следующий шаг?»

3.  **Получение команд:** В ответ на `Запрос` «мозг» присылает решение, в котором есть список дел — это **[Вызовы](./004_agent_call.md)**. Каждый `Вызов` — это простая команда, например, «открой калькулятор» или «найди в интернете смешного котика». Команд может быть несколько, одна или вообще ни одной.

4.  **Выполнение и обратная связь:**
    - Если в решении есть `Вызовы` (команды), агент их выполняет.
    - Что бы ни получилось в результате (например, калькулятор открылся или нашлась картинка с котиком), агент добавляет эту информацию в свою «копилку знаний». Это помогает ему на следующем круге быть умнее.

5.  **Завершение:** А что, если «мозг» не прислал ни одной команды? Это сигнал, что работа сделана! Или что агент сделал всё, что мог. Тогда он останавливается. Цикл завершён.

## Человек-в-деле (контроль человеком)

Самое крутое в этом Цикле — то, что ты можешь присматривать за агентом, как капитан за своим кораблём. Агент сначала не делает, а *планирует*, что будет делать (`Вызовы`), и показывает тебе этот план. В этот момент у тебя есть шанс вмешаться.

- **Одобрение:** Перед тем, как выполнить команды, система может показать их тебе и спросить: «Всё правильно? Продолжаем?» Это как если бы друг хотел отправить сообщение и сначала показал его тебе, чтобы убедиться, что всё в порядке.

- **Исправление:** Ты можешь сказать: «Подожди, давай вот тут поменяем». Ты можешь подправить план агента или даже дать ему совсем другое задание. Это делает работу с агентом безопасной и позволяет вам работать как одна команда.

Агент даже может учиться на твоих исправлениях (об этом мы поговорим в документе **[012: Агент/План](./012_agent_plan.md)**). Так он становится умнее и в следующий раз постарается не сделать ту же ошибку. Ты как будто его тренируешь!