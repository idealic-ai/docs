# 009: Агент/Состояние

> [!DEFINITION] [Сообщение о Состоянии](./000_glossary.md)
> Это специальное сообщение с данными, которое хранит «живую», постоянно меняющуюся память для всей задачи. Его можно представить как набор заметок на полях, которые помогают выполнять сложные, многошаговые действия, требующие помнить предыдущие шаги.

> Sidenote:
> - Требуется:
>   - [004: Агент/Вызов](./004_agent/call.md)
>   - [006: Агент/Данные](./006_agent/data.md)
> - Открывает возможности для:
>   - [010: Агент/План](./010_agent/plan.md)
> - Дополняется:
>   - [011: Агент/Инстансинг](./011_agent/instancing.md)
>   - [012: Агент/Делегат](./012_agent/delegate.md)
>   - [013: Агент/Области видимости](./013_agent/scopes.md)

Этот документ описывает **сообщение о Состоянии** — особый вид сообщения `Data`, который служит постоянной памятью для агента, пока тот выполняет свою работу. Если [Переменные](./008_agent_variables.md) — это «провода», соединяющие инструменты, то `Состояние` — это «блокнот для записей», куда агент записывает результаты и хранит их между шагами.

Объект `Состояние` — это главный источник правды о том, что сейчас происходит с задачей. Именно благодаря ему система такая надёжная и может продолжать работу после сбоя. Он как «сохранение» в игре: если что-то прервётся, агент может посмотреть на последнее сохранённое `Состояние` и точно понять, на чём он остановился, чтобы спокойно продолжить с того же места.

## Направляем рабочий процесс с помощью Схемы

Для `Состояния` можно задать `схему` — это не обязательно, но очень полезно. Схема — это как инструкция или чертёж, который описывает, какие данные мы ожидаем увидеть в памяти. Она подсказывает, как инструменты будут общаться между собой и в каком порядке работать.

Это создаёт мощную обратную связь для ИИ: зная, какая информация должна храниться в `Состоянии`, он лучше понимает, какие вызовы инструментов (`Tool Calls`) нужно создать и в какие ячейки памяти (`_outputPath`) положить результаты. Это помогает агенту действовать правильно и делать то, что от него ожидают.

> Sidenote:
> - [008: Агент/Переменные](./008_agent_variables.md)

## Многошаговые Инструменты

Главная задача `Состояния` — позволить разным `Инструментам` обмениваться информацией в рамках одного непрерывного процесса. Это как раз и есть та самая «память»: один `Инструмент` может записать свой результат в этот общий «блокнот», а другой `Инструмент` на следующем шаге — прочитать эту запись и использовать её в своей работе. Так создаются цепочки инструментов, где результат одного становится началом для другого, и всё это происходит без потери информации.

## План и его Выполнение

Сочетание записи в состояние (через `_outputPath`) и чтения из него (через **ссылки на переменные**) — это ключевой механизм, который позволяет разделить планирование и исполнение.

Это значит, что агент может сначала составить полный план действий — как схему, где все шаги-инструменты соединены ссылками, — и только потом начать их выполнять. Такую схему можно проверить, использовать повторно и даже «проиграть в уме», что идеально подходит для работы с ИИ.

Гибкость системы в том, что мы можем контролировать, что пойдёт на вход и что получится на выходе. Разработчик может либо позволить ИИ самому решать, какие данные откуда брать (**ссылки на переменные**) и куда сохранять (**`_outputPath`**), либо задать их жёстко, чтобы процесс был предсказуемым и надёжным.

> [!HEADSUP] Внимание!
> Создание `Вызовов Инструментов`, которые связаны друг с другом через `Состояние`, — это и есть процесс планирования. Наша система даёт для этого всё необходимое: постоянное `Состояние` служит блокнотом, `ссылки на переменные` и `_outputPath` — проводами, а **Цикл** агента — мотором, который всё это повторяет. Вместе они позволяют агенту построить полную схему потока данных, что по сути и является **Планом**.
>
> > Sidenote:
> >
> > - [005: Агент/Цикл](./005_agent_loop.md)
> > - [010: Агент/План](./010_agent_plan.md)

## Как это работает с другими частями системы

- **Вызов:** Система `Вызовов` тесно связана с `Состоянием` через специальное свойство `_outputPath`. Это свойство превращает обычный вызов инструмента в действие, которое изменяет память. Указывая `_outputPath`, `Вызов` говорит системе: «Результат моей работы положи вот в эту ячейку `Состояния`». Так агент шаг за шагом записывает итоги своих действий, создавая цепочку событий.

  > Sidenote:
  > - [004: Агент/Вызов](./004_agent_call.md)

- **Данные:** `Состояние` — это, по сути, особый случай использования системы `Данных`. Это сообщение `Data` с пометкой `kind: "state"`. Оно использует все возможности `Данных` для создания постоянной памяти агента. Свойство `schema` задаёт ожидаемую структуру этой памяти, служа чертежом для ИИ. А способность системы `Данных` объединять информацию позволяет обновлять `Состояние` по частям, собирая все изменения в единую картину.

  > Sidenote:
  > - [006: Агент/Данные](./006_agent_data.md)

- **Области видимости (Scopes):** `Области видимости` — это основной способ передать `Состояние` инструменту, который работает в изолированной среде, например, **Делегату**. Когда `Вызов` передаётся на исполнение Делегату, в свойстве `_scopes` можно указать, что `состояние` должно быть доступно в его «чистой комнате». Это позволяет изолированным инструментам безопасно и контролируемо читать и изменять основное состояние процесса.

  > Sidenote:
  > - [013: Агент/Области видимости](./013_agent_scopes.md)

- **Инстансинг:** `Состояние` полностью совместимо с системой `Инстансинга`. Когда один запрос обрабатывает сразу несколько задач (`Инстансов`), у каждой из них есть своё собственное, изолированное `Состояние`, помеченное уникальным ключом `_instance`. Ссылки на переменные (например, `†state.currentUser.id`) автоматически направляются к правильному `Состоянию` нужного `Инстанса`. Это позволяет одному общему `Плану` работать параллельно с множеством разных данных, не боясь их перепутать.

  > Sidenote:
  > - [011: Агент/Инстансинг](./011_agent_instancing.md)

- **План:** Хотя `Состояние` полезно и для простых цепочек инструментов, вся его мощь раскрывается, когда оно становится основой для системы `Планов`. В `Плане` весь процесс представляется в виде схемы, где узлы — это `Вызовы Инструментов`. `Состояние` служит связующим звеном — «дорожками» — между этими узлами. Оно позволяет одному узлу записать что-то в переменную, а другим — прочитать её, создавая сложные сценарии, например, с условиями (если... то...) или параллельными задачами.

  > Sidenote:
  > - [010: Агент/План](./010_agent_plan.md)

## От одного Состояния к оркестрованным процессам

Сообщение `Состояние` даёт нам механизм для управления памятью в рамках одного процесса. Имея постоянный «блокнот» и «провода» для соединения инструментов, мы можем создавать и выполнять сложные, многошаговые задачи.

Следующий документ, **[010: Агент/План](./010_agent_plan.md)**, расскажет о системе, которая управляет этими процессами, представляя их в виде схемы из `Вызовов Инструментов`.
