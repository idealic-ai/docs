# 851: Пакет/Покерный Движок

> [!DEFINITION] [Покерный Движок](./000_glossary.md)
> Это «мозг» для любой пошаговой игры, не только для покера. Он управляет всем процессом игры от начала до конца. В его основе лежит набор чётких правил, которые позволяют разным частям игры — логике, данным и командам — работать вместе, не мешая друг другу.

> Sidenote:
> - Используется в:
>   - :term[850: Пакет/Игровой Сервис]{href="./850_package_game_service.md"}
> - Отображается с помощью:
>   - :term[852: Пакет/Покерный Интерфейс]{href="./852_package_poker_ui.md"}

**Покерный Движок** (`@idealic/poker-engine`) — это набор инструментов для создания и управления играми в покер. Представь его как невидимого дилера и судью в одном лице, который управляет игрой от начала до конца. Хоть он и создан для покера, его идеи можно использовать для любой другой пошаговой игры.

## Надёжность

Движок сделан очень тщательно. Сначала мы описали все возможные правила и ситуации на бумаге, а потом воплотили их в коде. Его работу проверяют около **3000 тестов**, которые охватывают всё: от обычной игры до очень редких и сложных случаев, вроде разделения банка между несколькими игроками. Это гарантирует, что он работает как часы.

Кроме того:

- **Хаос-тестирование:** Мы постоянно проверяем весь игровой процесс, создавая случайные и непредсказуемые ситуации. Это как тренировка в самых жёстких условиях, чтобы убедиться, что движок не сломается.
- **Проверен временем:** Логика движка основана на системе, совместимой с форматом раздач **PokerStars**. Мы «скормили» ему данные о более чем **10 миллионах** реальных сыгранных партий, чтобы убедиться, что он всё понимает и делает правильно.

## Принципы Устройства

Движок построен на шести главных правилах:

1.  **Ничего не стирается:** Любое изменение в игре создаёт новую запись, а не меняет старую. Это гарантирует, что мы всегда можем посмотреть всю историю ходов.
2.  **Предсказуемость:** Если начать игру с одними и теми же условиями, она всегда будет идти абсолютно одинаково. Это позволяет точно воспроизводить любую раздачу.
3.  **Сначала проверка — потом действие:** Прежде чем выполнить ход, движок всегда проверяет, можно ли его сделать по правилам. Это защищает игру от ошибок.
4.  **Каждый делает своё дело:** Данные, правила игры и команды игроков чётко разделены. Это делает систему аккуратной и понятной.
5.  **Всё через команды:** Любые изменения в игре происходят только через стандартные команды. Это как протокол матча, где записан каждый ход.
6.  **Единый язык:** Все части системы общаются друг с другом на одном универсальном языке, что делает их работу слаженной.

## Модель «Отделов»

Представь, что движок — это офис с четырьмя отделами, каждый из которых отвечает за свою задачу. Они общаются между собой на едином языке.

### 1. Отдел Состояния (Память Игры)

**`Poker.State`** — это главный архив, где хранится вся история игры.

- **Универсальная запись:** Может записать историю любой пошаговой игры (покер, шахматы и т.д.) как последовательность действий.
- **Источник правды:** Содержит всю информацию, чтобы в любой момент восстановить игру с нуля.
- **Чистые данные:** Это просто данные, которые нельзя изменить напрямую, можно только добавить новую запись.
- **Разные точки зрения:** Может показывать каждому игроку только то, что ему положено видеть (например, скрывать чужие карты).

### 2. Отдел Игры (Судья)

**`Poker.Game`** — это судья и распорядитель, который оживляет игру.

- **Живая игра:** Берёт сухие записи из архива и превращает их в живую игру, за которой можно следить.
- **Следит за правилами:** Проверяет все ходы, не даёт нарушать правила и двигает игру вперёд.
- **Швейцарский нож:** Помогает управлять временем, следить за игроками и анализировать ситуацию за столом.
- **Двигатель прогресса:** Главная его задача — выполнять команды игроков и обновлять состояние игры.

### 3. Отдел Команд (Переводчик)

**`Poker.Command`** — это переводчик между игроком и движком.

- **Слой-переводчик:** Превращает действия игрока (например, клик по кнопке «Пас») в понятную для движка команду.
- **Знает ситуацию:** Смотрит на текущее состояние игры, чтобы предлагать только возможные ходы (например, сам рассчитает правильный размер ставки «ва-банк»).
- **Разделение:** Отделяет то, что видит игрок, от внутренней «кухни» самого движка.

### 4. Отдел Форматов (Архивариус)

**`Poker.Format`** — это специалист по упаковке и распаковке данных.

- **Упаковка/распаковка:** Эффективно «запаковывает» данные об игре для отправки по сети или сохранения, а потом «распаковывает» их обратно.
- **Чтение истории:** Умеет читать текстовые файлы с историей раздач (например, от PokerStars) и превращать их в понятную для движка структуру.

## Статистика и Аналитика

В движке есть специальный отдел **`Poker.Stats`** для глубокого анализа игры.

- **Философия:** Он различает **статистику** (простой подсчёт действий в реальном времени, например, «попытался сделать 3-бет») и **метрики** (сложные выводы на основе этих данных, например, «как часто он делает 3-бет»).
- **Учёт позиции:** Он понимает, где сидит игрок за столом, и считает статистику для каждой ситуации отдельно (например, ставка в позиции и без позиции).
- **Сводные отчёты:** Умеет собирать данные по игрокам, по раундам торгов или по всему столу для создания отчётов.

## Архитектура Системы

### Кто за что отвечает?

Покерный Движок работает сразу в двух местах: на твоём компьютере (клиенте) и на сервере.

- **На клиенте:** Помогает быстро отображать игру и позволяет тебе делать ходы.
- **На сервере:** Выступает главным судьёй. Он проверяет все действия, следит за честностью и отвечает за случайное перемешивание карт.

### С чем он работает?

- **Бэкенд:** **[@idealic/game-service](../game-service/README.md)** — сервис, который управляет игровыми сессиями, сохраняет данные и обеспечивает связь.
- **Фронтенд:** **[@idealic/poker-ui](../poker-ui/README.md)** — интерфейс, который рисует игровой стол на основе данных от движка.

## Жизненный Цикл Игры

Игра в движке — это как общение по рации: запрос-ответ.

1.  **Сбор игроков:** Игроки хотят сесть за стол. Система находит им место, и игра ждёт, пока не соберётся хотя бы двое.
2.  **Начало раздачи:** Сервер создаёт новую игру, «тасует» колоду, раздаёт карты, сохраняет и отправляет всем игрокам информацию.
3.  **Ходы игроков:** Игрок отправляет свой ход -> Движок его обрабатывает -> Новое состояние игры сохраняется и рассылается всем.
4.  **Завершение раздачи:** Раздача заканчивается, движок определяет победителя, передаёт фишку дилера следующему и готовится к новой раздаче.
5.  **Управление игроками:** Если кто-то хочет выйти, уйти в паузу или вернуться, его просьба будет обработана перед началом следующей раздачи.
6.  **Режим ожидания:** Игра останавливается, если за столом остаётся меньше двух активных игроков.
7.  **Тайм-ауты:** Система периодически проверяет, не затянул ли кто-то с ходом. Если да, она делает за него стандартное действие (например, «пас»), чтобы игра не стояла на месте.

## Ключевые Возможности

- **Управление состоянием:** Честная раздача карт, отслеживание сложных ставок и автоматическое разделение побочных банков.
- **Соблюдение правил:** Строгая проверка правил ставок, переходов между раундами и определение победителя на вскрытии.
- **Управление игроками:** Отслеживание позиций за столом (Баттон, Малый и Большой блайнды), размеров стеков и истории ходов.
- **Процесс игры:**
  - **Крупье:** Координирует взаимодействие между автоматическими действиями дилера и ходами игроков.
  - **Дилер:** «Робот», который автоматически раздаёт карты и открывает карты на столе.
  - **Вскрытие:** Мгновенно определяет силу комбинаций и находит победителя с помощью специальных таблиц.

## Формат Команд

Все события в игре записываются в виде простого и понятного текста:

- **Игрок:** `'p1 f'` (Игрок 1 сбросил карты), `'p2 cc 20'` (Игрок 2 уравнял ставку 20), `'p3 cbr 100'` (Игрок 3 повысил до 100).
- **Дилер:** `'d dh p1 AsKs'` (Дилер раздал игроку 1 Туза и Короля пик), `'d db AhKhQh'` (Дилер выложил на стол Туза, Короля и Даму червей).
- **Другое:** `'p4 m Привет!'` (Игрок 4 отправил сообщение).

Этот удобный для чтения формат используется и для обмена данными, и для записи истории игры.
