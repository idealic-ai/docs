# 005: Агент/Цикл

> [!DEFINITION] [Цикл](./000_glossary.md)
> Последовательность `Запросов`, направленная на достижение цели. Агент продолжает вызывать `Запросы`, обрабатывать полученные `Вызовы` и добавлять результат обратно в контекст для следующего `Запроса` до тех пор, пока `Вызовы` не перестанут создаваться.

> Sidenote:
> - Требуется:
>   - [001: Агент/Запрос](./001_agent_request.md)
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

Этот документ описывает **цикл исполнения** — то, что позволяет агенту выполнять задачи в несколько шагов, раз за разом делая [001: Агент/Запрос](./001_agent_request.md). Именно этот повторяющийся процесс — собрать информацию, использовать инструмент, получить результат и снова собрать информацию — обычно и называют «агентом».

## Цикл исполнения

> Sidenote:
> ```mermaid
> graph TD
>     Start((Старт)) --> ContextAssembly(1. Сбор контекста)
>     ContextAssembly --> RequestInvocation(2. Отправка запроса)
>     RequestInvocation --> CallProcessing(3. Обработка вызовов)
>     CallProcessing --> HasCalls{Есть вызовы?}
>     HasCalls -- Нет --> Termination((5. Завершение))
>     HasCalls -- Да --> HITL{Контроль человека}
>     HITL -- Одобрено --> Execution(4. Исполнение и обратная связь)
>     Execution -- Результаты --> ContextAssembly
>     HITL -- Исправлено --> ContextAssembly
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```

Цикл исполнения — это главный механизм, который позволяет агенту самостоятельно выполнять многошаговые задачи. Представь, что это его внутренний распорядок дня:

1.  **Сбор контекста:** Всё начинается со сбора информации. Агент смотрит на главную цель, текущую ситуацию (`Состояние`) и всё остальное, что может быть полезно. Как будто перед готовкой ты выкладываешь на стол все нужные ингредиенты.
2.  **Отправка запроса:** Агент отправляет [001: Агент/Запрос](./001_agent_request.md) со всей собранной информацией и списком доступных ему «инструментов» (`Tools`). Он как бы спрашивает у своего «мозга»: «Что делать дальше?»
3.  **Обработка вызовов:** В ответ на `Запрос` приходит `решение`, в котором содержится список из одного или нескольких [004: Агент/Вызов](./004_agent_call.md). Важно: на этом этапе `Вызовы` — это только *предложения*, что нужно сделать. Сами действия ещё не выполнены.
4.  **Исполнение и обратная связь:**
    -   Если `решение` содержит `Вызовы`, цикл их выполняет. Для `Явных` вызовов это означает запуск соответствующего кода `Действия`.
    -   Результаты этих действий (что получилось) добавляются обратно в общую копилку информации для следующего шага.
5.  **Завершение:** Если `решение` не содержит `Вызовов`, агент считает, что его цель достигнута, и цикл останавливается. Работа сделана!

## Контроль со стороны человека (Human-in-the-Loop, HITL)

Главная особенность этого цикла в том, что он очень удобен для контроля со стороны человека. Поскольку агент сначала *предлагает* действия (`Вызовы`), а только потом их *выполняет*, у человека есть возможность вмешаться:

-   **Одобрение:** Перед тем как выполнить `Вызовы`, система может показать их человеку и спросить: «Всё верно? Делаем?» Можно настроить систему так, чтобы она всегда ждала подтверждения от человека, как бы делая паузу.
-   **Исправление:** Человек может изменить детали `Вызова` (например, параметры) или вовсе заменить одно действие другим.

Важно понимать, что сам протокол не диктует, *как именно* это делать. Система просто создаёт «окошко» между предложением и действием. А разработчики уже могут использовать его как угодно: от простого ручного подтверждения до сложных автоматических проверок.

Это очень важно для безопасности и для совместной работы, когда агент выступает в роли помощника. Корректировки и подсказки человека могут использоваться в [010: Агент/План](./010_agent_plan.md), чтобы агент мог улучшать свою стратегию на основе человеческого опыта.

## Роль данных в цикле

Сам по себе цикл — это просто порядок действий. Его настоящая сила раскрывается благодаря данным, которые через него проходят. Состояние, входные данные и результаты каждого шага — всё это позволяет агенту не терять нить повествования, учиться и выполнять сложные, многошаговые планы.

Следующий документ, [006: Агент/Данные](./006_agent_data.md), расскажет о том, как происходит управление этими данными.
