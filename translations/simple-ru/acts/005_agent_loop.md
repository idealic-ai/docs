# 005: Агент/Цикл

> [!DEFINITION] :term[Цикл]
> Это как серия шагов (:term[Запросов]), которые агент делает, чтобы достичь своей цели. Агент снова и снова отправляет :term[Запросы], выполняет команды (:term[Вызовы]), которые получает в ответ, и использует результат для следующего шага. Он продолжает так делать, пока не решит, что задача выполнена и больше команд не нужно.

> Sidenote:
> - Требуется:
>   - :term[001: Агент/Запрос]{href="./001_agent_request.md"}
>   - :term[002: Агент/Инструмент]{href="./002_agent_tool.md"}
>   - :term[004: Агент/Вызов]{href="./004_agent_call.md"}

Этот документ объясняет, что такое :term[Цикл выполнения]. Это механизм, который позволяет агенту решать сложные задачи, состоящие из нескольких шагов, повторяя :term[Запросы] снова и снова. Именно этот процесс — сбор информации, использование инструментов и получение обратной связи — и делает машину «агентом».

## Цикл выполнения

> Sidenote:
> ```mermaid
> graph TD
>     Start((Старт)) --> SchemaComposition(1. Сборка схемы)
>     SchemaComposition --> ContextAssembly(2. Сбор контекста)
>     ContextAssembly --> RequestInvocation(3. Отправка Запроса)
>     RequestInvocation --> CallProcessing(4. Обработка Вызовов)
>     CallProcessing --> HasCalls{Есть вызовы?}
>     HasCalls -- Да --> HITL{Человек-в-цикле}
>     HITL -- Одобрено --> Execution(5. Выполнение и обратная связь)
>     Execution -- Результаты --> ContextAssembly
>     HITL -- Исправлено --> ContextAssembly
>     HasCalls -- Нет --> Termination(6. Завершение)
>     Termination --> OutputGeneration(7. Формирование результата)
>     OutputGeneration --> End((Конец))
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```

Цикл выполнения — это главный способ, которым агент действует самостоятельно, шаг за шагом. Вот как он работает:

1.  **Сборка схемы:** В самом начале мы говорим циклу, как должен выглядеть конечный результат — это называется *схема вывода*. Эта схема автоматически объединяется со схемами всех доступных :term[инструментов], создавая единый «план действий» для :term[Запроса], как описано в :term[202: Композиция схем инструментов]{href="./002_agent_tool.md#composing-schemas-for-the-llm"}.
2.  **Сбор контекста:** Цикл начинается со сбора всей начальной информации: цели, которую поставил пользователь, и любых других важных данных.
3.  **Отправка Запроса:** Он отправляет :term[Запрос] с текущим контекстом и собранной на первом шаге схемой.
4.  **Обработка Вызовов:** В ответ на :term[Запрос] приходит объект :term[Решение], в котором есть список команд — :term[Вызовов] — в поле `calls`. Важно: на этом этапе это просто план, команды еще не выполнены.
5.  **Выполнение и обратная связь:**
    - Если в списке `calls` есть команды, цикл их выполняет. Для :term[явных вызовов] это значит, что запускается соответствующий код :term[Действия].
    - Результаты выполнения этих команд добавляются в общий контекст для следующего круга цикла.
6.  **Завершение:** Если список `calls` пуст, агент считает, что цель достигнута, и цикл останавливается.
7.  **Формирование результата:** После остановки в поле `output` объекта :term[Решение] находится конечный результат, соответствующий той самой схеме, которую задал пользователь. Это позволяет агенту не просто выполнять действия, но и выдавать итоговый ответ в нужном виде. Содержимое `output` может быть краткой выжимкой или анализом информации, собранной за весь цикл. Например, агент для анализа данных может сделать несколько шагов обработки (каждый — это :term[Вызов]), а в конце вернуть готовый отчет в поле `output`.

## :term[Человек-в-цикле] (:term[HITL])

Одна из ключевых особенностей :term[Цикла выполнения] — это возможность для человека контролировать процесс. Так как цикл сначала предлагает план действий (:term[Вызовы]), а только потом их выполняет, у пользователя есть шанс вмешаться:

- **Подтверждение:** Перед тем как выполнить :term[Вызовы], система может показать их человеку и спросить разрешения. Можно настроить цикл так, чтобы он ставился на паузу и ждал подтверждения от пользователя.
- **Исправление:** Пользователь может изменить параметры :term[Вызова] или даже заменить одну команду на другую.

Важно понимать, что эти конкретные способы контроля (:term[HITL]) не являются обязательной частью протокола. Архитектура просто создает «паузу» между предложением и действием, что даёт разработчикам свободу встраивать любой вид контроля: от простого ручного одобрения до сложных автоматических проверок.

Эта возможность очень важна для безопасности и для совместной работы, где агент выступает в роли помощника. Корректировки и подсказки от человека могут быть учтены в общем :term[Плане], позволяя агенту улучшать свою стратегию на основе человеческого опыта.

## Роль данных в цикле

:term[Цикл выполнения] создаёт структуру для поведения агента, но его настоящая сила — в данных, которые циркулируют внутри. За управление этими данными отвечает :term[тип сообщения Data], о котором мы поговорим в документе :term[006: Агент/Данные]{href="./006_agent_data.md"}.
