# 005: Агент/Цикл

> [!DEFINITION] [Цикл](./000_glossary.md)
> Это последовательность Запросов (`Request`), направленных на достижение цели. Агент продолжает вызывать Запросы (`Request`), обрабатывать полученные в результате Вызовы (`Call`) и передавать результат обратно в контекст для следующего Запроса, пока Вызовы (`Call`) не перестанут генерироваться.

> Sidenote:
> - Требует:
>   - [001: Агент/Запрос](./001_agent_request.md)
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

Этот документ описывает **цикл выполнения** — главный механизм, который позволяет агенту выполнять задачи из нескольких шагов, раз за разом обращаясь к [001: Агент/Запрос](./001_agent_request.md). Этот повторяющийся процесс сборки информации (контекста), использования инструментов и анализа результатов — и есть то, что обычно называют «агентом».

## Цикл выполнения

> Sidenote:
> ```mermaid
> graph TD
>     Start((Старт)) --> SchemaComposition(1. Сборка Схемы)
>     SchemaComposition --> ContextAssembly(2. Сборка Контекста)
>     ContextAssembly --> RequestInvocation(3. Вызов Запроса)
>     RequestInvocation --> CallProcessing(4. Обработка Вызовов)
>     CallProcessing --> HasCalls{Есть Вызовы?}
>     HasCalls -- Да --> HITL{Контроль Человеком}
>     HITL -- Одобрено --> Execution(5. Выполнение и Обратная связь)
>     Execution -- Результаты --> ContextAssembly
>     HITL -- Скорректировано --> ContextAssembly
>     HasCalls -- Нет --> Termination(6. Завершение)
>     Termination --> OutputGeneration(7. Формирование Результата)
>     OutputGeneration --> End((Конец))
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```

Цикл выполнения — это основной способ для агента действовать самостоятельно, шаг за шагом. Вот как он работает:

1.  **Сборка схемы:** Перед началом циклу говорят, как должен выглядеть финальный результат (это называется _схема вывода_). Эта схема автоматически объединяется со схемами всех доступных [Инструментов](./002_agent_tool.md), создавая единые «правила игры» для `Запроса`, как описано в разделе [Компоновка схем инструментов](./002_agent_tool.md#composing-schemas-for-the-llm).
2.  **Сборка контекста:** Цикл начинается со сбора всей начальной информации: цели, которую поставил пользователь, и других важных данных. Это его «рабочий стол».
3.  **Вызов Запроса:** Агент делает [001: Агент/Запрос](./001_agent_request.md), передавая ему собранный контекст и общую схему из предыдущего шага.
4.  **Обработка Вызовов:** В ответ на `Запрос` приходит объект `solution` (решение), который содержит список из нуля или более [004: Агент/Вызов](./004_agent_call.md) в свойстве `calls`. Важный момент: на этом этапе `Вызовы` — это всего лишь *предложения*, что нужно сделать. Сами действия ещё не выполнены.
5.  **Выполнение и обратная связь:**
    - Если в `solution` есть `Вызовы`, цикл выполняет их. Для `Явных` `Вызовов` это означает запуск соответствующего кода `Действия`.
    - Результаты этих `Вызовов` добавляются обратно в контекст для следующего круга цикла.
6.  **Завершение:** Если `Запрос` вернул пустой список `calls`, агент считает, что достиг цели, и цикл останавливается.
7.  **Формирование результата:** После остановки цикла в поле `output` (вывод) объекта `solution` находится окончательный результат, который соответствует той самой схеме, что задал пользователь. Этот механизм позволяет агенту не просто выполнять действия, но и создавать структурированный финальный ответ. Содержимое `output` может быть краткой выжимкой или анализом всей информации, собранной за время работы цикла. Например, агент для анализа данных может сделать несколько шагов обработки (каждый — это `Вызов`), а затем использовать поле `output`, чтобы вернуть итоговый отчёт в формате JSON.

## Человек в цикле (Human-in-the-Loop, HITL)

Ключевая особенность цикла выполнения — он естественным образом позволяет человеку контролировать процесс. Поскольку цикл разделяет создание `Вызовов` (планирование действий) и их выполнение, у пользователя появляется возможность вмешаться:

- **Подтверждение:** Перед выполнением `Вызовов` система может показать их человеку для одобрения. Можно настроить механизм выполнения так, чтобы он делал паузу (например, через специальную функцию-callback), пока не получит согласие от человека.
- **Исправление:** Пользователь может изменить параметры `Вызова` или даже заменить его на другой.

Важно понимать, что эти конкретные способы контроля не являются частью основного протокола. Архитектура просто разделяет «предложение» и «действие», давая разработчикам свободу встраивать любой тип контроля: от простого ручного подтверждения до сложной автоматической системы с таймерами.

Эта возможность критически важна для безопасности и совместной работы, где агент выступает в роли помощника. Корректировки и обратная связь от пользователя могут быть учтены в [010: Агент/План](./010_agent_plan.md), позволяя агенту улучшать свою стратегию на основе человеческого ввода.

## Роль данных в цикле

Цикл выполнения создаёт каркас для поведения агента, но его настоящая сила — в данных, которые текут внутри него. Контекст, входные и выходные данные на каждом шаге позволяют агенту сохранять «память», учиться и выполнять сложные многошаговые планы.

Следующий документ, [006: Агент/Данные](./006_agent_data.md), расскажет о том, как происходит управление этими данными.