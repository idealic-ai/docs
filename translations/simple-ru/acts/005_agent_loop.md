# 005: Агент/Цикл

> **Цикл:** Последовательность `Запросов`, направленная на достижение цели. Агент продолжает отправлять `Запросы`, обрабатывать полученные `Вызовы` и добавлять результат в контекст для следующего `Запроса` до тех пор, пока `Вызовы` не перестанут генерироваться. — [Словарь](./000_glossary.md)

> Sidenote:
> - Требуется:
>   - [001: Агент/Запрос](./001_agent_request.md)
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

Этот документ объясняет **цикл выполнения** — это то, что позволяет агенту (умной программе) выполнять задачи, состоящие из нескольких шагов. Он делает это, раз за разом отправляя [001: Агент/Запрос](./001_agent_request.md). Весь этот процесс — сбор информации, использование инструментов и получение обратной связи — и есть то, что мы называем «агентом».

## Цикл выполнения

> Sidenote:
> ```mermaid
> graph TD
>     Start((Начало)) --> ContextAssembly(1. Сборка контекста)
>     ContextAssembly --> RequestInvocation(2. Отправка Запроса)
>     RequestInvocation --> CallProcessing(3. Обработка Вызовов)
>     CallProcessing --> HasCalls{Есть Вызовы?}
>     HasCalls -- Нет --> Termination((5. Завершение))
>     HasCalls -- Да --> HITL{Контроль человека}
>     HITL -- Одобрено --> Execution(4. Выполнение и обратная связь)
>     Execution -- Результаты --> ContextAssembly
>     HITL -- Исправлено --> ContextAssembly
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```

Представь, что агент — это робот-помощник, которому ты дал задание, например, «закажи пиццу». Он не делает всё сразу, а действует по кругу, шаг за шагом. Этот круг и называется циклом выполнения.

1.  **Сборка контекста:** Сначала робот собирает всю нужную информацию: «Какую пиццу любит хозяин? Какой у нас адрес? Есть ли скидки?». Это называется «контекст».
2.  **Отправка Запроса:** Собрав информацию, он как бы спрашивает у своего «мозга» ([001: Агент/Запрос](./001_agent_request.md)): «Окей, вот всё, что я знаю. Какие мои следующие действия?».
3.  **Обработка Вызовов:** Мозг отвечает списком команд, которые называются [004: Агент/Вызов](./004_agent_call.md). Например: «открой сайт пиццерии», «найди „Пепперони“», «добавь в корзину». Важно: на этом этапе робот ещё ничего не сделал, он только составил план действий.
4.  **Выполнение и обратная связь:**
    -   Если в плане есть действия (`Вызовы`), робот начинает их выполнять одно за другим.
    -   Результаты каждого действия (например, «сайт открылся», «пицца добавлена в корзину») он запоминает и добавляет к общей информации (контексту) для следующего шага.
5.  **Завершение:** Когда мозг в ответ на очередной запрос не присылает никаких команд (`Вызовов`), это значит, что задача выполнена. Цикл останавливается. Пицца заказана!

## Человек в цикле (контроль)

Одна из самых крутых особенностей этого цикла — возможность для человека вмешаться и всё проконтролировать. Поскольку агент сначала составляет план действий (`Вызовы`), а только потом их выполняет, у нас появляется «пауза» для проверки.

- **Подтверждение:** Перед тем как робот начнёт выполнять команды, система может показать их тебе и спросить: «Всё верно? Продолжаем?». Цикл остановится и будет ждать твоего разрешения.
- **Исправление:** Ты можешь изменить план: например, поменять пиццу «Пепперони» на «Маргариту» или добавить ещё одну команду, например, «применить купон на скидку».

Сама система не навязывает, как именно это делать. Она просто даёт возможность разделить «планирование» и «действие». Это очень важно для безопасности и для задач, где агент работает как твой помощник. Твои подсказки и исправления помогают агенту учиться и составлять более точные планы в будущем (об этом в [012: Агент/План](./012_agent_plan.md)).

## Роль данных в цикле

Цикл выполнения — это как скелет, который задаёт поведение агента. А настоящая его сила — в данных, которые циркулируют внутри этого цикла, как кровь. Вся информация — что нужно сделать, что уже сделано, какие результаты получены — позволяет агенту не сбиваться с пути, помнить контекст и выполнять сложные, многошаговые задачи.

В следующем документе, [006: Агент/Данные](./006_agent_data.md), мы разберёмся, как агент управляет всей этой информацией.
