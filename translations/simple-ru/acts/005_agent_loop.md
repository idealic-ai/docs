# 005: Агент/Цикл

> **Цикл:** Это как последовательность `Запросов`, чтобы достичь какой-то цели. Агент делает `Запрос`, обрабатывает полученные в ответ `Вызовы` (команды), а результат добавляет в «память» для следующего шага. Он повторяет это до тех пор, пока не решит, что задача выполнена и новых `Вызовов` больше нет. — [Глоссарий](./000_glossary.md)

> Sidenote:
> - Требуется:
>   - [001: Агент/Запрос](./001_agent_request.md)
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

Этот документ рассказывает про **цикл выполнения**. Он позволяет агенту (нашей умной программе) выполнять сложные задачи, состоящие из нескольких шагов. Агент раз за разом делает [001: Агент/Запрос](./001_agent_request.md). Этот процесс, где он собирает информацию, использует инструменты и смотрит на результат, как раз и делает его «агентом» — самостоятельным помощником.

## Цикл Выполнения

> Sidenote:
> ```mermaid
> graph TD
>     Start((Старт)) --> ContextAssembly(1. Сбор Контекста)
>     ContextAssembly --> RequestInvocation(2. Запрос)
>     RequestInvocation --> CallProcessing(3. Обработка Вызовов)
>     CallProcessing --> HasCalls{Есть Вызовы?}
>     HasCalls -- Нет --> Termination((5. Конец))
>     HasCalls -- Да --> HITL{Контроль Человека}
>     HITL -- Одобрено --> Execution(4. Исполнение)
>     Execution -- Результаты --> ContextAssembly
>     HITL -- Исправлено --> ContextAssembly
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```

Цикл выполнения — это главный способ, которым агент действует сам по себе, шаг за шагом. Представь себе, что агент — это повар, который готовит блюдо по рецепту, но может сам принимать решения на каждом шаге.

1.  **Сбор Контекста:** Повар смотрит, что у него есть: какие продукты (это `Состояние`), какой рецепт (цель), что уже готово.
2.  **Запрос:** Повар думает: «Так, что мне делать дальше?» Он отправляет [001: Агент/Запрос](./001_agent_request.md) к своему «мозгу», описывая ситуацию и спрашивая, какими «инструментами» воспользоваться.
3.  **Обработка Вызовов:** Мозг отвечает: «Возьми нож и нарежь овощи». Эти инструкции — это [004: Агент/Вызовы](./004_agent_call.md). Важно: на этом этапе он ещё ничего не сделал, а только *предложил*, что нужно сделать.
4.  **Исполнение и Результат:**
    - Если мозг дал команды (`Вызовы`), повар их выполняет. Например, берёт настоящий нож (`Активность`) и режет овощи.
    - Нарезанные овощи — это результат. Он добавляет их на стол (в «контекст») для следующего шага.
5.  **Завершение:** Если мозг отвечает «команд больше нет», значит, блюдо готово. Повар останавливается, цикл завершён.

## Человек в цикле (Контроль со стороны человека)

Одна из самых крутых вещей в этом цикле — он позволяет человеку легко вмешаться и помочь.
Поскольку агент сначала *предлагает* действия (`Вызовы`), а только потом их *выполняет*, мы можем вставить паузу между этими шагами:

- **Подтверждение:** Перед тем как повар возьмётся за нож, система может показать его план тебе и спросить: «Ты уверен, что нужно резать именно так?». Цикл остановится и будет ждать твоего «Да».
- **Исправление:** Ты можешь сказать: «Нет, режь не кубиками, а соломкой» или «Лучше сначала вскипяти воду». Можно изменить команду или даже заменить её на другую.

Важно понимать: сам протокол не заставляет использовать эту паузу. Он просто создаёт возможность для этого. Разработчики могут сами решить, как именно человек будет вмешиваться: будет ли это просто кнопка «Одобрить» или сложная система проверки.

Это очень важно для безопасности и совместной работы, когда агент выступает в роли помощника. Твои подсказки и исправления могут быть использованы в [012: Агент/План](./012_agent_plan.md), чтобы агент учился и действовал умнее в следующий раз.

## Роль Данных в Цикле

Сам по себе цикл — это просто скелет. Настоящую силу ему придают данные, которые через него проходят: информация о задаче, результатах прошлых шагов и текущем состоянии. Именно эти данные позволяют агенту «помнить» контекст, учиться и выполнять сложные многошаговые планы.

Следующий документ, [006: Агент/Данные](./006_agent_data.md), расскажет, как мы управляем всеми этими данными.
