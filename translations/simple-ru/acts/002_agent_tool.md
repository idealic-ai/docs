# 002: Агент/Инструмент

> [!DEFINITION] [Инструмент](./000_glossary.md)
> Это как инструкция для способности, которой может воспользоваться агент. Она подаётся большому искусственному интеллекту (ИИ) как часть запроса и работает как понятное меню возможных действий. ИИ активирует инструмент, создавая `Вызов` с конкретными параметрами. Этот вызов затем выполняется либо «в уме» самим ИИ, либо с помощью специальной функции в коде (`Действие`).

> Sidenote:
> - Требуется: [001: Агент/Запрос](./001_agent_request.md)
> - Дополняется: [003: Агент/Действие](./003_agent_activity.md)

`Инструмент` — это интерфейс на основе схемы, который описывает способность агента в чёткой и понятной форме. Это как кирпичик, из которых строятся все действия агента. Он помогает ИИ понять, какие «кнопки» у него есть, и выбрать нужную.

## Что такое Инструменты?

**Инструменты — это основа** всей системы действий агента. Они дают ему новую суперспособность: **выбирать действие в зависимости от ситуации**. Это позволяет агентам подбирать и выполнять подходящие действия в нужный момент.

Что дают Инструменты:

- **Понятные интерфейсы**: Описанные в схемах способности, которые агенты могут найти и понять.
- **Надёжность типов**: Чёткие правила о том, какие данные нужны на входе и что будет на выходе.
- **Сочетаемость**: Это как кубики конструктора, которые можно соединять для создания сложных действий.
- **Работа с ИИ**: Схемы, которые языковые модели могут анализировать и выбирать.

Когда агент заполняет все нужные параметры для Инструмента, он создаёт **Вызов** — это как бы «заявка на использование» Инструмента со всеми заполненными полями, готовая к выполнению.

> Sidenote:
> [004: Агент/Вызов](./004_agent_call.md)
>

## Когда использовать систему Инструментов

Используйте систему Инструментов, когда вам нужно, чтобы агенты:

- **Выбирали действия на лету**, исходя из ситуации.
- **Выбирали из нескольких способностей**, чтобы достичь цели.
- **Использовали разные способы** для выполнения одной и той же задачи (например, разные поисковые системы).
- **Сочетали размышления ИИ с чёткими правилами** при принятии решений.

## Как устроена система Инструментов

### Главный принцип: Схема как интерфейс

Система Инструментов построена на простом правиле: **Инструменты — это просто схемы**, которые описывают интерфейсы, но не заставляют использовать конкретный способ их выполнения. Это разделение «что делать» от «как делать» — ключ к гибкости всей системы.

Схема `Инструмента` — это обычный объект JSON Schema. Любое поле без знака подчёркивания в начале считается параметром инструмента. Система использует специальные мета-поля (с `_` в начале) для системных настроек, которые управляют тем, как инструмент будет опознан и выполнен.

Схема Инструмента полностью описывает его интерфейс:

> Sidenote:
> Дополнения:
>
> - **`_activity`**: Связывает инструмент с функцией в коде для явного выполнения. ([003: Агент/Действие](./003_agent_activity.md))
> - **`_delegate`**: Передаёт выполнение инструмента независимому внешнему исполнителю. ([012: Агент/Делегат](./012_agent_delegate.md))
> - **`_outputPath`**: Делает инструмент «запоминающим», сохраняя его результат в специальном объекте состояния. ([009: Агент/Состояние](./009_agent_state.md))
> - **`_instance`**: Направляет выполнение инструмента на конкретный экземпляр, если их несколько. ([011: Агент/Экземплирование](./011_agent_instancing.md))

- **`title`**: Понятное человеку название схемы (необязательно).
- **`description`**: Объяснение того, что делает инструмент.
- **`parameters`**: Поля без знака подчёркивания определяют, какие данные нужны инструменту.
- **`_tool`**: Уникальное имя для идентификации инструмента.
- **`_output`**: Описывает, как должен выглядеть результат работы инструмента.
- **`_reasoningForCall`**: Поле, которое система добавляет, чтобы агент объяснил, почему он выбрал этот инструмент.

Более сложные системы могут управлять целыми цепочками задач, состоянием и правилами выполнения, опираясь на эти простые элементы.

## Определение Инструмента

Инструменты описываются с помощью схем JSON. В примере ниже показан `Инструмент` для анализа тональности текста. Он рассчитан на скрытое выполнение, то есть ИИ сам поймёт, как его выполнить, используя свои знания языка — для этого не нужна внешняя программа.

```typescript
Tool.register('sentimentAnalysis', {
  type: 'object',
  description: 'Анализирует тональность текста',
  properties: {
    _tool: { type: 'string', const: 'sentimentAnalysis' },
    text: { type: 'string', description: 'Текст для анализа' },
    _output: {
      type: 'object',
      properties: {
        sentiment: { type: 'string' },
        confidence: { type: 'number' },
      },
    },
  },
});
```

## Сборка схем для ИИ

Агент не просто использует инструменты — часто ему нужно выдать финальный, структурированный ответ после выполнения задачи. Для этого система берёт схемы всех доступных `Инструментов` и объединяет их со схемой, описывающей финальный результат (схема `output`). Так получается одна большая общая схема, которая отправляется ИИ в `Запросе`.

Благодаря этому у ИИ появляется выбор, как ответить. В зависимости от задачи, он может:

- **Сделать только `вызовы`:** Если для решения задачи нужны промежуточные шаги, ИИ будет вызывать один или несколько инструментов, а поле `output` оставит пустым (`null`).
- **Сформировать только `output`:** Если на запрос можно ответить сразу, без инструментов, ИИ предоставит финальный результат в поле `output`, а `вызовы` оставит пустыми.
- **Сделать и то, и другое:** Иногда ИИ может выполнить действие и сразу же выдать финальный ответ за один шаг.

Этот механизм позволяет использовать один и тот же гибкий интерфейс как для простых, моментальных ответов, так и для сложных задач с несколькими инструментами. Разработчик просто предоставляет схемы `Инструментов` и схему ответа, а система сама собирает их в структуру, удобную для ИИ.

Пример ниже показывает, как собираются вместе схема `Инструмента` и схема ответа.

::::columns
:::column{title="Настройки агента"}

```typescript
Agent.Request(
  config, // Настройки запроса (например, модель, температура)
  {
    // Схема ответа
    type: 'object',
    properties: {
      summary: { type: 'string' },
    },
    required: ['summary'],
  },
  [
    // Контекст
    {
      type: 'tool',
      tool: {
        greetUser: {
          type: 'object',
          properties: {
            userName: { type: 'string' },
          },
          required: ['userName'],
        },
      },
    },
    { type: 'text', text: 'здесь какой-то запрос' },
  ]
);
```

:::
:::column{title="Собранная схема (для ИИ)"}

```json
{
  "type": "object",
  "properties": {
    "calls": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "_tool": { "const": "greetUser" },
          "userName": { "type": "string" }
        },
        "required": ["_tool", "userName"]
      }
    },
    "output": {
      "type": ["object", "null"],
      "properties": {
        "summary": { "type": 'string' }
      },
      "required": ["summary"],
      "additionalProperties": false
    }
  },
  "required": ["calls", "output"]
}
```

:::
::::

## Улучшение Инструментов с помощью мета-свойств

Описание инструмента можно улучшить не только в его основной схеме, но и в момент его вызова. Это другой способ «собирать» поведение, когда к одному инструменту добавляются новые возможности.

Когда агент решает использовать инструмент, он создаёт `Вызов` — конкретный «заказ» на использование этого инструмента. `Вызов` содержит параметры, но его можно дополнить специальными мета-свойствами (с `_` в начале), которые дают дополнительные инструкции системе. Эти свойства управляют тем, как именно будет выполнен инструмент.

> Sidenote:
> - [004: Агент/Вызов](./004_agent_call.md)

Этот механизм позволяет использовать простую базовую схему инструмента множеством мощных и гибких способов. `Вызов` становится подробной инструкцией, которая говорит не только *что* делать (какой инструмент и с какими параметрами), но и *как* это делать (с помощью мета-свойств). Осталось только понять, какими способами `Вызов` может быть выполнен.

## Скрытое и Явное выполнение

Когда `Вызов` создан, системе нужно его выполнить. Схема `Инструмента` — это просто описание, в ней нет кода для выполнения. Вместо этого выполнение может происходить двумя способами. По умолчанию используется **скрытое выполнение**: ИИ сам «додумывает», какой должен быть результат, что идеально подходит для задач, связанных с текстом или знаниями. Для действий, требующих взаимодействия с внешним миром — например, вызова API или доступа к базе данных — `Инструмент` нужно связать с реальной функцией в коде. Такое явное исполнение называется **Действием**.

Разделение интерфейса `Инструмента` от его реализации в виде `Действия` — это ключевой принцип дизайна. Это позволяет описывать способности агента абстрактно, в то время как код, который их выполняет, можно менять или обновлять независимо. Следующий документ, **[003: Агент/Действие](./003_agent_activity.md)**, расскажет, как `Действия` обеспечивают конкретную логику для `Инструментов`.

> Sidenote:
> - [003: Агент/Действие](./003_agent_activity.md).
