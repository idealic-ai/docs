# 017: Агент/Советник

> [!DEFINITION] [Советник](./000_glossary.md)
> Специализированное контекстное сообщение (с `kind: "advisor"`), которое определяет роль или модель для анализа. Оно даёт агенту указание сгенерировать структурированное «мнение» или оценку уверенности _прежде чем_ выбрать :term[Инструмент]{canonical="Tool"} или создать :term[Результат]{canonical="Output"}.

> Sidenote:
> - Требует:
>   - :term[001: Агент/Запрос]{href="./001_agent_request.md"}
> - Улучшает:
>   - :term[002: Агент/Инструмент]{href="./002_agent_tool.md"}
>   - :term[010: Агент/Цикл]{href="./010_agent_loop.md"}

**Протокол Советника** заставляет систему работать по принципу «сначала подумай, потом сделай». Регистрируя **Советников**, агент оценивает ситуацию через определённые стратегические «очки» — например, «Архитектора Безопасности» или «Продакт-менеджера» — прежде чем приступить к Действию.

## Ненаправленное мышление

Размышления без чёткой структуры (например, по принципу «потока сознания») часто хаотичны. Агенты бродят без карты, смешивая в одну шумную кучу сбор информации, рассуждения и принятие решений.

Такое отсутствие структуры раздувает контекст лишними рассуждениями. Размышления без ориентиров заставляют агента колебаться, что ведёт к смене мнений и снижению точности. Непредсказуемость этого процесса ухудшает как скорость, так и надёжность. Более того, решения, основанные на неструктурированном тексте, трудно сопоставлять; абзац общих мыслей не даёт никаких количественных зацепок для взвешивания конкурирующих приоритетов.

Протокол Советника формализует часть процесса рассуждений, чтобы решить эти проблемы. Он структурирует оценку, делая её предсказуемой и точной. Эта структура также улучшает пользовательский опыт. Вместо того чтобы прятать «стены текста», система может представлять структурированные, взвешенные выводы, которые ясно подчёркивают расхождения во мнениях, сильные предпочтения и чёткие рекомендации. Это создаёт лучшую экосистему для принятия решений и значительно улучшает отчётность.

Протокол Советника не заменяет скрытые рассуждения; он структурирует определённую их часть. Он фиксирует процесс оценки как осязаемый артефакт — взвешенное мнение, — который служит прямым входом для принятия решений.

## Разные точки зрения и взвешивание инструментов

Регистрируя нескольких Советников, система заставляет агента оценивать ситуацию с конкурирующих точек зрения (например, «Риск» против «Возможности»). Это расхождение фиксируется через **Взвешенный Выбор Инструментов**, где Советники выдают явные «запросы» или оценки уверенности для конкретных :term[Инструментов]{canonical="Tool"}.

Агент собирает эти взвешенные голоса от своего совета. Он не просто «выбирает» инструмент; он согласовывает вектор расходящихся мнений для достижения консенсуса. Активация инструмента становится просчитанным решением, основанным на конкурирующих советах.

## Сообщение Советника

**Сообщение Советника** определяет, через какие «очки» агент смотрит на проблему.

- **`id`**: Уникальный идентификатор советника (например, `"securityArchitect"`).
- **`role`**: Описание области знаний и точки зрения советника.
- **`schema`**: JSON Schema, определяющая структуру совета. Это позволяет получать конкретные количественные данные (например, оценки риска, бюджетные оценки) или структурные значения, выходящие за рамки стандартного голосования за инструменты.
- **`on`**: Определяет стратегию участия.
- **`scopes`**: Массив ключей контекста (например, `["input", "state"]`), которые фокусируют анализ советника.
- **`isInstanced`**: Логический флаг (по умолчанию `false`). Если `true`, определение советника включает свойство `_instance`, обеспечивая индивидуальную консультацию для каждого экземпляра в пакете.

## Стратегии выполнения

Свойство `on` контролирует участие:

- **`start` (В начале)**: Высказывает мнение только в начале диалога, чтобы задать направление.
- **`finish` (При завершении)**: К нему обращаются при определении, нужно ли останавливать цикл.
- **`request` (Постоянно)**: Предоставляет мнение в начале, в конце и на каждой итерации. Идеально для наблюдателей за безопасностью или ключевых стратегических советников.
- **`null` / `undefined` (По требованию)**: Молчит, пока его явно не вызовут. Система предоставляет мета-инструмент `ConsultAdvisor`, позволяющий ИИ вызывать этих советников по требованию в неоднозначных ситуациях.

## Порядок консультирования

Когда Советники активны, ИИ генерирует их структурированный вывод _в первую очередь_, в рамках того же окна генерации. Он примеряет на себя роли советников для анализа состояния или голосования за действия. Затем Агент немедленно использует этот вывод для принятия окончательного решения о том, какой :term[Инструмент]{canonical="Tool"} вызвать.

Количественные данные, такие как «запросы», кодируются как **Встроенный JSON** в строковом поле, чтобы избежать разрастания схемы, сохраняя при этом строгость.

::::columns
:::column{title="Регистрация Советников"}

```json
[
  {
    "type": "advisor",
    "id": "riskAnalyst",
    "on": "request",
    "scopes": ["†state.deploymentHistory"],
    "role": "Анализируй риски и голосуй за действия по развертыванию.",
    "schema": {
      "type": "object",
      "properties": {
        "thought": { "type": "string", "description": "Оценка рисков развертывания." }
      },
      "required": ["thought"]
    }
  }
]
```

:::
:::column{title="Ответ ИИ"}

Поле `calls` содержит JSON-строку, как определено в системной инструкции.

```json
{
  "advisors": [
    {
      "id": "riskAnalyst",
      "thought": "Новая функция прошла модульные тесты, но не прошла интеграционные. Высокий риск регрессии.",
      "calls": "{\"deploy\": 10, \"rollback\": 5, \"delay\": 95}"
    }
  ],
  "calls": [
    {
      "_tool": "delay",
      "_reasoningForCall": "Аналитик рисков настоятельно рекомендует отложить из-за недостаточного тестирования."
    }
  ]
}
```

:::
::::

## Взаимодействие с другими системами

- **:term[Инструмент]{canonical="Tool"}:** Советники не выполняют действия, они за них голосуют. Возможность `advisors` структурно похожа на вызов инструмента в схеме вывода, но она представляет собой мета-действие — «мыслительный процесс», — которое строго предшествует выполнению любого реального :term[Инструмента]{canonical="Tool"}. Такое разделение гарантирует, что советы собираются до принятия обязательств.

  > Sidenote:
  > - :term[002: Агент/Инструмент]{href="./002_agent_tool.md"}

- **:term[Цикл]{canonical="Loop"}:** Свойство `on` интегрирует советников в жизненный цикл агента. Советники с `on: request` действуют как постоянные наблюдатели, работая на каждом шаге цикла. Те, у кого `on: null` (по требованию), действуют как предохранительные клапаны, к которым можно обратиться, когда агент сталкивается с неопределенностью или трудными решениями во время выполнения.

  > Sidenote:
  > - :term[010: Агент/Цикл]{href="./010_agent_loop.md"}

- **:term[План]{canonical="Plan"}:** Советы имеют решающее значение на этапе планирования. Консультируясь с советниками с `on: start` или `on: request`, агент может согласовать свою первоначальную стратегию и последующие шаги с консенсусом специализированных ролей, гарантируя, что :term[План]{canonical="Plan"} будет надёжным и хорошо продуманным с самого начала.

  > Sidenote:
  > - :term[012: Агент/План]{href="./012_agent_plan.md"}

- **:term[Экземплирование]{canonical="Instancing"}:** Советники поддерживают пакетное выполнение. Установив `isInstanced: true`, советник начинает учитывать экземпляры. Система будет генерировать советы, специфичные для каждого контекста (определяемого по `_instance`), гарантируя, что каждый элемент в пакете будет оценен советником индивидуально.

  > Sidenote:
  > - :term[013: Агент/Экземплирование]{href="./013_agent_instancing.md"}

- **:term[Области видимости]{canonical="Scopes"}:** Свойство `scopes` в сообщении Советника предоставляет способ сфокусировать его внимание. В отличие от строгой изоляции данных, наблюдаемой в Делегатах, здесь области видимости действуют как **мягкие указания**. Они инструктируют конкретного советника уделить приоритетное внимание анализу перечисленных ключей контекста (например, `["†state.deploymentHistory"]`), обеспечивая «разделение ответственности» на этапе консультирования, не блокируя при этом доступ к более широкому контексту.

  > Sidenote:
  > - :term[015: Агент/Области видимости]{href="./015_agent_scopes.md"}
