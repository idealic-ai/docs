# 005: Агент/Данные

> [!DEFINITION] [Сообщение с данными](./000_glossary.md)
> Это как стикер с заметкой для агента. На нём есть сами `данные` (информация) и, по желанию, `схема` (объяснение, что эта информация означает). Этот стикер не выкидывают сразу, а сохраняют на протяжении всей работы агента, чтобы у него был постоянный доступ к важной информации для решения сложных задач.

> Sidenote:
> - Требует:
>   - [001: Агент/Запрос](./001_agent_request.md)
> - Позволяет создать:
>   - [006: Агент/Ввод](./006_agent_input.md)
>   - [009: Агент/Состояние](./009_agent_state.md)
> - Дополняется:
>   - [010: Агент/Цикл](./010_agent_loop.md)
>   - [012: Агент/Экземплирование](./012_agent_instancing.md)

Протокол :term[Данных]{canonical="Data"} — это как основной язык для общения с информацией. Он помогает раскладывать её по полочкам и объяснять, что она означает. Другие части системы, например :term[Ввод]{canonical="Input"} и :term[Состояние]{canonical="State"}, используют его, чтобы управлять данными в «рабочем пространстве» агента. В отличие от обычных сообщений, которые появляются и тут же исчезают, сообщения с :term[Данными]{canonical="Data"} остаются надолго. Это как доска с заметками, на которую агент может смотреть, выполняя сложную задачу из нескольких шагов.

## Сообщение с данными

> Sidenote:
> - [001: Агент/Запрос](./001_agent_request.md)

Сообщение с :term[Данными]{canonical="Data"} — это простой, но очень полезный способ добавить в :term[Запрос]{canonical="Request"} понятную и упорядоченную информацию. Это как контейнер с несколькими отделениями:

- **`data`**: Сама информация (например, текст, число, объект или список).
- **`schema`**: Необязательная инструкция или «чертёж», который объясняет, как устроены `данные`.
- **`kind`**: Необязательная метка, которая говорит о роли сообщения (например, `"state"` — «состояние» или `"input"` — «ввод»). Это помогает системе и ИИ понимать, с каким типом данных они работают.

Когда у данных есть `schema` (инструкция), они становятся понятными для машины. `schema` объясняет ИИ, что означает каждое поле, какого оно типа и какие у него есть правила. Это не только помогает ИИ лучше думать, но и служит документацией для людей, показывая, что можно изменить или настроить.

## Слияние и идентичность

Этот протокол умеет работать с несколькими сообщениями с :term[Данными]{canonical="Data"} одновременно. Если система видит, что несколько сообщений относятся к одному и тому же (например, несколько частей одной и той же информации), она их объединяет в одно целое. Это очень удобно, когда нужно, например, применить несколько небольших изменений к одному большому файлу.

Чтобы понять, какие сообщения нужно объединить, система смотрит на их метку `kind`. Например, все сообщения с меткой `kind: "state"` будут считаться частью одного целого. Другие протоколы, такие как :term[Экземплирование]{canonical="Instancing"}, могут добавлять свои правила, чтобы создавать отдельные рабочие пространства и не смешивать данные из разных задач.

> Sidenote:
> - [012: Агент/Экземплирование](./012_agent_instancing.md)

Когда система получает несколько таких сообщений, которые можно объединить (например, несколько кусочков «состояния»), она может поступить двумя способами. Первый — сама склеить их в один большой и понятный объект, прежде чем показывать ИИ. Это упрощает работу для модели. Второй — ИИ может сам мысленно «сложить» эти кусочки у себя в голове, понимая, что они описывают одну и ту же вещь с разных сторон.

:::::details{title="Пример того, как ИИ видит сообщения с данными" open=false}

- Обычное текстовое сообщение (`text`) передаётся как есть.
- Сообщения с данными (`data`) объединяются и превращаются в одно текстовое сообщение.

::::columns
:::column{title="Как выглядит код"}

```typescript
Agent.Request(config, schema, [
  {
    type: 'text',
    // Обнови город пользователя на Остин
    text: "Update the user's city to Austin",
  },

  // Схема передаётся ИИ, чтобы он понял смысл данных
  {
    type: 'data',
    kind: 'user',
    description: 'Представляет текущего пользователя.',
    data: { name: 'John Doe' },
    schema: {
      type: 'object',
      properties: {
        name: { type: 'string' },
        age: { type: 'number' },
        city: { type: 'string' },
      },
    },
  },

  // Второе сообщение 'user' сольётся с первым
  {
    type: 'data',
    kind: 'user',
    data: { age: 30 },
  },
]);
```

:::
:::column{title="Что видит ИИ"}

```typescript
[
  {
    role: 'user',
    content: {
      type: 'text',
      text: "Update the user's city to Austin",
    },
  },
  {
    role: 'user',
    content: {
      type: 'text',
      text: `
        ## Data: ¶user
        {
          "name": "John Doe",
          "age": 30
        }
        Represents the current user.
        Schema for ¶user:
        {
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "age": { "type": "number" },
            "city": { "type": "string" }
          }
        }`,
    },
  },
];
```

:::
::::
:::::

## Специализация сообщений с данными

Обычное сообщение с :term[Данными]{canonical="Data"} — это универсальный инструмент. Другие части системы используют его для своих нужд, просто присваивая ему определённую метку `kind`.

- **:term[Сообщения с входными данными]{canonical="Input Message"}:** Это сообщение с :term[Данными]{canonical="Data"} и меткой `kind: 'input'`. Оно объявляет, какие параметры принимает :term[Запрос]{canonical="Request"}, превращая его в многоразовый компонент, похожий на функцию в программировании.

  > Sidenote:
  > - [006: Агент/Ввод](./006_agent_input.md)

- **:term[Сообщения о состоянии]{canonical="State Message"}:** Это сообщение с :term[Данными]{canonical="Data"} и меткой `kind: 'state'`. Оно хранит «память» агента, которая может меняться со временем. Его `schema` описывает, что именно агент может запоминать и изменять.

  > Sidenote:
  > - [009: Агент/Состояние](./009_agent_state.md)

- **:term[Вывод]{canonical="Final Output"}:** Механизм `_outputPath` создаёт новые сообщения с :term[Данными]{canonical="Data"} для сохранения результатов работы :term[Инструментов]{canonical="Tool Call"}. Когда инструмент завершает свою работу, его результат добавляется в рабочее пространство как новое сообщение (часто с меткой `kind: 'state'`), чтобы его можно было использовать на следующих шагах.

  > Sidenote:
  > - [008: Агент/Вывод](./008_agent_output.md)

- **:term[Экземплирование]{canonical="Instancing"}:** Система :term[Экземплирования]{canonical="Instancing"} использует специальное свойство `_instance`, чтобы различать сообщения с :term[Данными]{canonical="Data"}. Эта метка привязывает сообщение к определённому потоку выполнения, когда нужно запустить много задач параллельно. Сообщения с разными `_instance` не будут смешиваться, что гарантирует порядок.

  > Sidenote:
  > - [012: Агент/Экземплирование](./012_agent_instancing.md)

- **:term[Цикл]{canonical="Loop"}:** :term[Цикл выполнения]{canonical="Execution Loop"} использует сообщения с :term[Данными]{canonical="Data"} для непрерывной работы. В частности, :term[Сообщение о состоянии]{canonical="State Message"} — это главный способ сохранять информацию между шагами :term[Цикла]{canonical="Loop"}.

  > Sidenote:
  > - [010: Агент/Цикл](./010_agent_loop.md)

- **:term[Переменные]{canonical="Variable"}:** Система :term[Переменных]{canonical="Variable"} — главный потребитель сообщений с :term[Данными]{canonical="Data"}. **:term[Ссылки на переменные]{canonical="Variable Reference"}** (выглядят как `†<kind>.<path>`) используются в вызовах :term[Инструментов]{canonical="Call"}, чтобы брать нужные значения из сообщений, например, из :term[входных данных]{canonical="Input Message"} или :term[состояния]{canonical="State Message"}.

  > Sidenote:
  > - [007: Агент/Переменные](./007_agent_variables.md)

## От общих данных к конкретным ролям

Сообщение с :term[Данными]{canonical="Data"} — это универсальный контейнер для информации. Но чтобы агент мог эффективно её использовать, ему нужно понимать, какую роль эти данные играют в процессе. В следующих главах мы расскажем, как этот универсальный контейнер используется для конкретных задач, например, для передачи начальных параметров для работы.

Следующий документ, :term[006: Агент/Ввод]{href="./006_agent_input.md"}, описывает, как сообщение с `Данными` используется для создания структурированного запроса для агента.
