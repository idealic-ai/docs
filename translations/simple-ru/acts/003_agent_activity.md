# Акт 003: Агент/Действие

> [!DEFINITION] [Действие](./000_glossary.md)
> Это конкретная функция (кусочек кода), которая выполняет работу для :term[Инструмента]{canonical="Tool"}. Она нужна для задач, которые нейросеть (LLM) не может сделать сама в уме, например, сходить на другой сайт за информацией, заглянуть в базу данных или выполнить любое другое реальное действие.




Этот документ описывает **Протокол Действий**, который объясняет, как :term[Инструменты]{canonical="Tool"} получают реальный, исполняемый код. Если :term[Инструмент]{canonical="Tool"} — это описание того, *что* можно сделать, то :term[Действие]{canonical="Activity"} — это инструкция, *как* это сделать.

## Архитектура двух реестров

Система агента использует два отдельных списка (реестра), чтобы отделить описание способности от её реального воплощения:

- **:term[Реестр Инструментов]{canonical="Tool"}**: Хранит описание того, как выглядят и что принимают :term[Инструменты]{canonical="Tool"} (их «интерфейс»).
- **:term[Реестр Действий]{canonical="Activity"}**: Хранит сам код (:term[Действия]{canonical="Activity"}), который выполняет работу для :term[Инструментов]{canonical="Tool"}.

Такое разделение делает систему очень гибкой. :term[Инструменты]{canonical="Tool"} могут существовать просто как идея, позволяя нейросети самой придумать результат (скрытое исполнение). Также это позволяет легко менять код :term[Действия]{canonical="Activity"} (например, использовать один для тестирования, а другой — для настоящей работы), не меняя при этом описание самого :term[Инструмента]{canonical="Tool"}.

## Регистрация Действия

Каждое :term[Действие]{canonical="Activity"} регистрируется под уникальным именем, которое связывает его с :term[Инструментом]{canonical="Tool"}.

::::columns
:::column{title="Реализация Действия"}

```typescript
// Регистрируем реализацию Действия.
// По соглашению, Действие можно связать
// с Инструментом с таким же именем.
// Типы данных автоматически берутся из Инструмента.
Activity.register('weatherCheck', async call => {
  const data = await weatherAPI.get(call.location);
  return { temperature: data.temp, conditions: data.desc };
});
```

:::
:::column{title="Схема соответствующего Инструмента"}

```typescript
Tool.register('weatherCheck', {
  type: 'object',
  description: 'Получает текущую погоду для указанного места.',
  properties: {
    _tool: { type: 'string', const: 'weatherCheck' },
    location: { type: 'string' },
    _output: {
      type: 'object',
      properties: {
        temperature: { type: 'number' },
        conditions: { type: 'string' },
      },
      required: ['temperature', 'conditions'],
    },
  },
  required: ['location'],
});
```

:::
::::

## Режимы исполнения: Скрытый и Явный

Система поддерживает два разных способа выполнения :term[Вызова]{canonical="Call"} :term[Инструмента]{canonical="Tool"}:

- **Скрытое исполнение**: Нейросеть использует свои способности к рассуждению. Агент «продумывает» задачу и сам генерирует результат за один шаг. Этот режим используется по умолчанию, если для :term[Инструмента]{canonical="Tool"} не найдено :term[Действие]{canonical="Activity"}.
  > Sidenote:
  > - :term[104: Концепция/Скрытое]{href="./104_concept_latent.md"}
- **Явное исполнение**: :term[Вызов]{canonical="Call"} передаётся на выполнение конкретному коду. Вызывается функция :term[Действия]{canonical="Activity"}, которая и вычисляет результат. Это необходимо для взаимодействия с внешним миром (например, с сайтами, базами данных) или для задач, где нужна точность и предсказуемость.

## Как система решает, какой режим использовать

Чтобы понять, как выполнить :term[Вызов]{canonical="Call"}, система действует без дополнительных настроек. Поле `_activity` в схеме :term[Инструмента]{canonical="Tool"} — это сигнал, что нужно использовать реальный код. Система определяет это поле автоматически по следующим правилам:

1.  **Поле `_activity` задано вручную**: Если в определении :term[Инструмента]{canonical="Tool"} поле `_activity` уже заполнено, система использует это имя для поиска :term[Действия]{canonical="Activity"} в реестре.
2.  **Совпадение по имени (рекомендуемый способ)**: Если поля `_activity` нет, система проверяет, зарегистрировано ли :term[Действие]{canonical="Activity"} с **таким же именем**, как у :term[Инструмента]{canonical="Tool"}. Если да, то поле `_activity` заполняется автоматически.
3.  **Переход в скрытый режим**: Если по первым двум правилам :term[Действие]{canonical="Activity"} не найдено, поле `_activity` остаётся пустым. Это сигнал, что :term[Вызов]{canonical="Call"} нужно выполнить в скрытом режиме (силами нейросети).

Такой подход, основанный на соглашениях, упрощает разработку:

- **Чтобы всё работало без настроек, называйте :term[Действие]{canonical="Activity"} так же, как и ваш :term[Инструмент]{canonical="Tool"}.**
- :term[Инструменты]{canonical="Tool"} без соответствующего :term[Действия]{canonical="Activity"} автоматически и безопасно будут выполняться в скрытом режиме.
- Если вы вручную укажете `_activity` в схеме :term[Инструмента]{canonical="Tool"}, это будет иметь приоритет. Так одно :term[Действие]{canonical="Activity"} сможет обслуживать несколько разных :term[Инструментов]{canonical="Tool"}.

## Зачем вообще разделять Действия?

Если бы описание :term[Инструмента]{canonical="Tool"} и код :term[Действия]{canonical="Activity"} были одним целым, то определение способности было бы навсегда привязано к коду. Чтобы переключиться с ответа нейросети на получение данных с сайта, пришлось бы найти и изменить каждого агента, использующего этот :term[Инструмент]{canonical="Tool"}.

Архитектура с двумя реестрами решает эту проблему. Описания :term[Инструментов]{canonical="Tool"} остаются стабильными, а их реализация может меняться. Агенты всегда взаимодействуют с одним и тем же «интерфейсом» :term[Инструмента]{canonical="Tool"}, не зная, выполняется он скрыто нейросетью или явно с помощью :term[Действия]{canonical="Activity"}. Это значит, что:

- **Изменения в коде не ломают агентов**: Можно переключиться со скрытого режима на явный, не трогая код агента.
- **Можно тестировать разные подходы**: Сравнивать, что работает лучше для одной и той же задачи — рассуждения нейросети или обращение к внешнему сайту.
- **Можно внедрять изменения постепенно**: Запустить новый код :term[Действия]{canonical="Activity"} для части агентов, пока остальные продолжают использовать старый или скрытый режим.

## От описания к действию

Разделяя «что» (:term[Инструмент]{canonical="Tool"}) и «как» (:term[Действие]{canonical="Activity"}), система становится невероятно гибкой. Но это лишь часть истории. Когда у нас есть описания и их реализации, остаётся последний элемент — организация процесса: как управлять этими :term[Вызовами]{canonical="Call"}, исполнять их и выстраивать в нужной последовательности.

Следующий документ, :term[004: Агент/Вызов]{href="./004_agent_call.md"}, расскажет о протоколе, который управляет этим исполнением, превращая абстрактные описания в конкретные действия с состоянием.