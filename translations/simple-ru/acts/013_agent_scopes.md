# 013: Агент/Области видимости

> [!DEFINITION] [Области видимости (Scopes)](./000_glossary.md#scopes)
> Это как выдать «пропуск» для доступа к информации. Вместо того чтобы показывать программе всё подряд, мы даём ей разрешение видеть только определённые, нужные для задачи данные. Свойство `_scopes` работает как список разрешений, который точно определяет, какую информацию может использовать команда (`Call`).

> Sidenote:
> - Требуется:
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

**Протокол Областей видимости** — это основной способ управлять тем, какая информация доступна команде (`Call`) в момент её выполнения. Представь, что агент — это большой и сложный механизм. Команда, которую он выполняет, редко работает в пустоте. Ей часто нужна информация извне: что попросил пользователь, что уже было сделано до этого или какие данные сейчас есть.

Этот протокол — безопасный и понятный способ контролировать поток этой информации. Это как если бы ты дал повару только те ингредиенты, которые нужны для конкретного блюда. Так он не ошибётся, не возьмёт лишнего и быстрее приготовит то, что нужно. Это делает работу ИИ более предсказуемой и дешёвой, а также позволяет создавать независимые и повторно используемые блоки, такие как `Идеи` и `Действия`.

В этом документе мы разберём, как этот протокол работает.

## Предоставление и запрос контекста

В зависимости от настроек в свойстве `_scopes`, информация (контекст) может быть либо выдана заранее, либо запрошена прямо во время работы.

> Sidenote:
> ```mermaid
> graph TD
>     subgraph Контекст-родитель
>         direction LR
>         input("ввод")
>         state("состояние")
>     end
>
>     subgraph Вызов инструмента
>         direction LR
>         filter{{"_scopes: ['ввод']"}}
>     end
>
>     input --> filter
>     state -.-> filter
>
>     subgraph Предоставленный контекст
>         Execute(Выполнить инструмент)
>     end
>
>     filter --> HITL{{Одобрение человеком}}
>     HITL --> Execute
>
>     classDef unused stroke-dasharray: 5, 5, stroke:#aaa, color:#aaa
>     class state unused
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```

- **Статические области (Предоставление контекста)**: Если в `_scopes` указано конкретное значение (`const`), это значит, что контекст **предоставляется** заранее. Программист жёстко прописал, какую именно информацию может видеть инструмент.

  ```json
  {
    "_scopes": {
      "const": ["input"]
    }
  }
  ```
  *Здесь команда может видеть только `input` (входные данные от пользователя) и ничего больше.*

- **Динамические области (Запрос контекста)**: Настройки могут быть более гибкими, позволяя ИИ самому **запрашивать** нужную информацию из списка доступных. ИИ сам решает, что ему нужно для выполнения команды.

  ```json
  {
    "_scopes": {
      "type": "array",
      "items": {
        "enum": ["state", "input"]
      }
    }
  }
  ```
  *А здесь ИИ может попросить доступ либо к `state` (текущее состояние), либо к `input` (входные данные), либо к обоим сразу.*

  Такой способ особенно полезен, когда человек может подтвердить запрос — это даёт дополнительный контроль.

## Роль областей видимости в выполнении команд

Свойство `_scopes` — это главный пульт управления информацией для команды `Call`. Оно работает как фильтр, который пропускает только разрешённые данные. Это помогает сочетать разные способы выполнения команд: от скрытой логики ИИ до чётко прописанных действий.

- **Скрытое исполнение**: В обычном режиме, когда ИИ сам решает, что делать, `_scopes` служат для него «подсказкой». Они помогают ему сфокусироваться на нужных частях информации. Это не строгий запрет, а скорее дружеский совет, который помогает ИИ не отвлекаться на лишнее и работать эффективнее.

  > Sidenote:
  > - [002: Агент/Инструмент](./002_agent_tool.md).

- **Чёткое исполнение (`_activity`)**: Когда команда `Call` запускает конкретное `Действие` (прописанный код), области видимости играют более прямую роль. Вся разрешённая информация передаётся этому `Действию` целиком, как дополнительный набор инструментов. Так у `Действия` есть всё, что ему нужно, даже если ИИ не использовал эти данные для генерации самой команды.

  > Sidenote:
  > - [003: Агент/Действие](./003_agent_activity.md).

- **Инстансинг (`_instance`)**: Когда агент обрабатывает сразу много похожих объектов (например, список писем), области видимости следят за порядком. Протокол гарантирует, что команда, работающая с одним письмом, получит информацию только об этом письме и не заглянет в соседние. Это защищает данные от путаницы.

  > Sidenote:
  > - [011: Агент/Инстансинг](./011_agent_instancing.md)

- **Модульная изоляция (`_module`)**: Когда команда передаётся внешнему `Модулю` для выполнения, области видимости становятся стражниками на входе. Они определяют *весь* контекст, который будет доступен внутри этого модуля. Ничто из внешней среды не попадёт внутрь, если это не было разрешено. Это обеспечивает полную независимость и безопасность модуля.

  > Sidenote:
  > - [012: Агент/Делегирование](./012_agent_delegate.md)

Свойство `_scopes` — это мост, по которому информация поступает к команде `Call`. Когда этот механизм используется для создания полностью изолированной среды, он включает мощный **Протокол делегирования**. Следующий документ, [012: Агент/Делегирование](./012_agent_delegate.md), подробно его описывает.
