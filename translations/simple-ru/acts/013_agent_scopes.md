# 013: Агент/Области видимости

> [!DEFINITION] [Области видимости (Scopes)](./000_glossary.md)
> Представь, что у твоего робота-помощника есть доступ ко всей информации в доме. Области видимости — это как если бы ты дал ему чёткую инструкцию: «Сейчас ты готовишь сэндвич, поэтому можешь смотреть только в холодильник и брать только сыр и хлеб». Это механизм, который создаёт для каждой задачи отдельное, безопасное «поле зрения», показывая только то, что действительно нужно.



**Протокол Областей Видимости** — это основной способ управлять тем, какую информацию видит команда (`Call`), когда выполняется. В сложных системах команды редко работают в пустоте; им часто нужна информация извне — например, что ввёл пользователь, что происходило на предыдущих шагах или какие-то общие данные. Протокол Областей Видимости позволяет надёжно и чётко контролировать этот поток информации.

Ограничивая доступ, мы делаем систему безопаснее, предотвращаем случайные утечки данных и помогаем ИИ-модели (LLM) сосредоточиться. Это делает её работу более предсказуемой и дешёвой. Такой контроль также позволяет создавать независимые и многоразовые модули, как кубики в конструкторе.

## Предоставление и Запрос данных

Существует два способа работы с данными: они могут быть жёстко **предоставлены** заранее или **запрошены** программой в момент выполнения.



- **Статичные Области (Данные предоставлены)**: В этом случае разработчик заранее чётко прописывает, какие именно данные может видеть команда. Это как выдать повару рецепт и корзину с точно отмеренными ингредиентами. Он не может попросить что-то ещё.

  ```json
  {
    "_scopes": {
      "const": ["input"] // Можно видеть только 'input' (входные данные)
    }
  }
  ```

- **Динамичные Области (Данные запрошены)**: Здесь у ИИ есть свобода выбора. Ему дают список разрешённых «ингредиентов», и он сам решает, какие из них ему нужны для выполнения задачи. Это как если бы у повара был доступ к кладовке с несколькими полками, и он сам выбирает, что взять.

  ```json
  {
    "_scopes": {
      "type": "array",
      "items": {
        // Можно выбрать 'state' (состояние) или 'input' (входные данные), или и то и другое
        "enum": ["state", "input"] 
      }
    }
  }
  ```

  Этот способ особенно полезен, когда человек может проверить и одобрить выбор ИИ, что даёт дополнительный контроль.

## Роль Областей Видимости в разных задачах

Области видимости — это главный фильтр, который решает, что увидит команда. Он создаёт для неё ограниченное «поле зрения». Этот механизм работает по-разному в зависимости от того, как выполняется команда — с помощью логики, обработки нескольких объектов сразу или через отдельный модуль.

- **Скрытое исполнение**: В обычном режиме, когда ИИ сам решает, что делать, области видимости работают как **подсказка**. Они помогают модели сосредоточиться на нужных данных и не отвлекаться на лишнюю информацию. Это как выделить маркером самые важные абзацы в учебнике — ученик всё ещё может прочитать весь текст, но подсветка помогает ему не упустить главное.



- **Явное исполнение (`_activity`)**: Когда команда запускает заранее написанную программу (`Activity`), области видимости играют более прямую роль. Все данные, разрешённые в области видимости, передаются этой программе целиком. Это как дать автомату на заводе полный ящик со всеми нужными деталями. ИИ просто нажимает кнопку «старт», а автомат получает всё необходимое для работы.



- **Инстансинг (`_instance`)**: Когда нужно обработать сразу много одинаковых объектов (например, список писем), области видимости следят, чтобы каждая задача видела только свои данные. Это как если бы несколько учеников писали контрольную: области видимости — это перегородки между партами, которые не дают им заглянуть в работу соседа.



- **Модульная изоляция (`_module`)**: Когда одна часть программы поручает задачу другой (модулю), области видимости становятся стражниками на входе. Они создают для модуля абсолютно «чистую комнату», в которой есть только та информация, которую ему разрешили передать. Ничего лишнего из внешнего мира туда не проникает. Это обеспечивает полную независимость и безопасность.



Области видимости — это мост, по которому данные попадают к команде. Как мы видим, когда этот мост ведёт в полностью изолированную «комнату», он позволяет использовать мощный **Протокол Делегирования**. Следующий документ, [012: Агент/Делегирование](./012_agent_delegate.md), описывает его подробнее.