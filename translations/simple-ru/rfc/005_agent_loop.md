# 005: Агент/Цикл

> **Цикл:** Это последовательность шагов (`Запросов`), которые нужны для достижения цели. Представь, что агент — это робот-помощник. Он постоянно делает `Запросы` (спрашивает: «Что делать дальше?»), выполняет полученные команды (`Вызовы`) и использует результат для следующего шага. Так он делает до тех пор, пока не останется ни одной команды, а значит, задача выполнена.
> — [Глоссарий](./000_glossary.md)

> Sidenote: - Требуется:
>   - [001: Агент/Запрос](./001_agent_request.md)
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

Этот документ объясняет **Протокол Цикла** — способ, который позволяет агенту выполнять большие и сложные задачи, делая их шаг за шагом.

## Цикл Выполнения

> Sidenote: ```mermaid
> graph TD
>     Start((Старт)) --> AssembleContext(Собрать Контекст)
>     AssembleContext --> InvokeRequest(Сделать Запрос)
>     InvokeRequest --> HasCalls{В решении есть Вызовы?}
>     HasCalls -- Нет --> Stop((Конец))
>     HasCalls -- Да --> HITL{Человек в Деле}
>     HITL -- Одобрено --> ExecuteCalls(Выполнить Вызовы)
>     ExecuteCalls -- Результаты --> AssembleContext
>     HITL -- Исправлено --> AssembleContext
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```
>

Цикл — это главный моторчик, который позволяет агенту работать самостоятельно. Вот как он крутится:

1.  **Сборка Контекста:** Представь, что ты собираешься печь торт. Сначала ты выкладываешь на стол все ингредиенты, рецепт и посуду. Это и есть «контекст» — всё, что агенту нужно знать для начала работы: какова цель, что уже сделано и какая есть информация.
2.  **Отправка Запроса:** Ты смотришь в рецепт и спрашиваешь себя: «Так, какой первый шаг?». Агент делает то же самое: он отправляет **[Запрос](./001_agent_request.md)**, чтобы понять, какой следующий шаг нужно сделать, имея текущий контекст и доступные `Инструменты`.
3.  **Получение Вызовов:** В ответ рецепт говорит тебе: «Взбей два яйца». `Запрос` возвращает решение, в котором есть список из одного или нескольких конкретных действий — **[Вызовов](./004_agent_call.md)s**.
4.  **Выполнение и Обратная связь:**
    -   Если в решении есть `Вызовы` (действия), агент их выполняет. Например, запускает нужный `Инструмент`.
    -   Результат этого действия (например, взбитые яйца) добавляется обратно в «контекст». Теперь агент знает, что яйца уже взбиты, и может переходить к следующему шагу.
5.  **Завершение:** Если в какой-то момент решение приходит пустым, без единого `Вызова`, это как последняя строчка в рецепте: «Торт готов!». Значит, агент считает, что достиг цели, и цикл останавливается.

## Человек в Деле (Human-in-the-Loop)

Самое классное в этом цикле — то, что у человека всегда есть возможность вмешаться. Поскольку агент сначала решает, *что* делать, а потом уже *делает*, между этими этапами есть небольшая пауза.

В этот момент ты можешь:

-   **Одобрить:** Посмотреть на план агента («смешать муку с сахаром») и сказать: «Да, всё верно, продолжай».
-   **Исправить:** Заметить, что агент хочет добавить слишком много сахара, и поменять количество. Или вообще заменить одно действие на другое.

Это очень важно для безопасности и для тех случаев, когда агент — твой помощник. Он может учиться на твоих поправках, чтобы в будущем планировать свои действия ещё лучше, используя **[План Агента](./012_agent_plan.md)**.
