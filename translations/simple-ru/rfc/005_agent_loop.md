# 005: Агент/Цикл

> **Цикл:** Это последовательность `Запросов`, направленных на достижение цели. Представь, что агент — это повар, который готовит блюдо по рецепту. Он постоянно делает `Запросы` (смотрит на следующий шаг в рецепте), выполняет `Вызовы` (например, «нарезать лук») и использует результат (нарезанный лук) для следующего шага. Так продолжается до тех пор, пока `Вызовы` не закончатся — значит, блюдо готово. — [Глоссарий](./000_glossary.md)

> Sidenote:
>
> - Требуется:
>   - [001: Агент/Запрос](./001_agent_request.md)
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

Этот документ описывает **Протокол Цикла**. Это как набор правил, который помогает агенту выполнять большие и сложные задачи, разбивая их на маленькие шаги и раз за разом делая `Запросы`.

## Цикл выполнения

> Sidenote:
>
> ```mermaid
graph TD
    Start((Начало)) --> AssembleContext(Собрать информацию)
    AssembleContext --> InvokeRequest(Сделать Запрос)
    InvokeRequest --> HasCalls{В решении есть Вызовы?}
    HasCalls -- Нет --> Stop((Конец))
    HasCalls -- Да --> HITL{Контроль человека}
    HITL -- Одобрено --> ExecuteCalls(Выполнить Вызовы)
    ExecuteCalls -- Результаты --> AssembleContext
    HITL -- Исправлено --> AssembleContext
    classDef optional stroke-dasharray: 5, 5
    class HITL optional
```

Цикл Агента — это главный способ, которым он сам, без посторонней помощи, выполняет задачи из нескольких шагов. Это похоже на сборку конструктора LEGO: ты не делаешь всё сразу, а следуешь инструкции шаг за шагом. Вот как работает этот цикл:

1.  **Сбор информации:** Сначала цикл собирает всё, что ему нужно для начала работы. Это как прочитать задание, чтобы понять, что от тебя хотят. Сюда входит цель пользователя, текущая ситуация (`Состояние`) и другие важные детали.
2.  **Отправка Запроса:** Собрав всю информацию, агент делает **[Запрос (001: Агент/Запрос)](./001_agent_request.md)**. По сути, он спрашивает: «Так, исходя из того, что я знаю, и инструментов, которые у меня есть, что мне делать дальше?»
3.  **Получение плана:** В ответ на `Запрос` приходит `решение`. Это как короткий список дел. В этом списке есть один или несколько **[Вызовов (004: Агент/Вызов)](./004_agent_call.md)** — конкретных действий, которые нужно предпринять. Иногда список может быть пустым, и это значит, что работа сделана.
4.  **Работа и обучение:**
    - Если в списке дел (`решении`) есть `Вызовы`, цикл их выполняет. Например, запускает специальный код для какого-то `Действия`.
    - Результаты этих действий (что получилось в итоге) он добавляет обратно в свою «память» (контекст). Так он будет умнее на следующем шаге. Это как смешать муку и яйца: теперь у тебя есть тесто, и это новая информация для следующего шага рецепта.
5.  **Завершение:** Если в ответ на `Запрос` приходит пустой список дел (ноль `Вызовов`), агент понимает, что он закончил. Цикл останавливается. Конструктор LEGO собран!

## Человек в деле (Human-in-the-Loop, HITL)

Самое классное в этом цикле — в нём есть встроенная «кнопка паузы». Агент сначала решает, *что* он хочет сделать (создаёт `Вызовы`), и только потом *делает* это. Этот промежуток между планом и действием даёт человеку шанс вмешаться:

- **Одобрение:** Прежде чем выполнить `Вызовы`, система может показать их тебе и спросить: «Так нормально?»
- **Исправление:** Если тебе не нравится план, ты можешь его изменить. Например, поправить какую-то мелочь или дать совершенно новую команду.

Это очень важно для безопасности, чтобы агент не наделал глупостей. А ещё это отлично подходит для совместной работы, когда агент тебе помогает. Когда ты вносишь исправления, агент может учиться на них с помощью своего **[Плана (012: Агент/План)](./012_agent_plan.md)** и в следующий раз будет действовать ещё лучше.