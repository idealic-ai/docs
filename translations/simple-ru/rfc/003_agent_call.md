# 004: Агент/Вызов

> **Вызов:** Это как будто у тебя есть «Инструмент» (например, форма для заказа пиццы), и ты её заполнил конкретными данными (размер «большой», начинка «пепперони»). Это готовая к исполнению команда, которая говорит, что именно _нужно сделать_.
>
> — [Глоссарий](./000_glossary.md)

> Sidenote:
>
> - Требуется: [Протокол: Идеаторы](./103_concept_ideator.md)
> - Открывает возможности для: [Протокол Импортов](./006_agent_imports.md), [Протокол Инстансинга](./008_agent_instancing.md)

Протокол «Идея» ([Idea Protocol](./101_concept_idea.md)) описывает, как можно упаковать знания или логику в удобный контейнер. Система «Инструментов» ([Tool System](./002_agent_tool.md)) создаёт для агентов понятный язык, чтобы они могли разбираться в своих возможностях. Этот документ описывает **Протокол Вызова (Call)**. Он построен на основе Инструментов и объясняет, как именно происходит действие — где оно выполняется и каким способом.

> Sidenote:
>
> - Требуется
> - [Нормативный Акт 1: Инструмент](/)
> - Открывает возможности для
> - [Нормативный Акт 9: План](/)

**Вызов (Call)** — это конкретный экземпляр Инструмента с уже заданными параметрами, готовый к работе. Если Инструменты описывают, _что можно сделать_ в принципе, то Вызовы определяют, _как это будет исполнено_ прямо сейчас.

## Путь от Идеи к Вызову

Представь себе это как процесс приготовления еды:

1. **Идея**: Это как фотография готового блюда. Она показывает результат — что получилось в итоге.
2. **Инструмент**: Это как пустой бланк рецепта для этого блюда. Мы берём «Идею» (фото блюда) и превращаем её в инструкцию с полями для ингредиентов. Он описывает, что _можно_ приготовить.
3. **Вызов**: Когда наш «повар» (ИИ) решает использовать «Инструмент», он заполняет пустые поля конкретными значениями (например, «мука — 2 стакана», «сахар — 1 стакан»). Так получается **Вызов** — конкретная команда, готовая к исполнению.

Главный принцип: **любую Идею можно превратить в Инструмент, который затем можно использовать как Вызов.**

Чтобы подробно узнать, как входная схема «Идеи» превращается в схему параметров «Инструмента», смотри **[Протокол Ввода](./007_agent_input.md)**.

## Управление исполнением: Область и Метод

Выполнение «Вызова» определяется двумя независимыми параметрами: **Областью** (где он запускается) и **Методом** (как он запускается). Эти параметры задаются с помощью специальных свойств в схеме инструмента, таких как `_module`, `_activity`, `_output`.

### Два измерения исполнения

1. **Область (Inline или Module)**
   Область определяет, где будет выполняться задача: прямо здесь, внутри текущего агента, или где-то в другом месте, в отдельном модуле.
   - **Inline (Здесь)**: Это режим по умолчанию. Вызов обрабатывается немедленно, на месте.
   - **Module (Там)**: Если есть свойство `_module`, то Вызов передаётся для выполнения другому модулю — внешней «Активности» или «Идее».

2. **Метод (Explicit или Latent)**
   Метод определяет, как будет получен результат: с помощью точного компьютерного кода или с помощью креативности ИИ.
   - **Explicit (Точный)**: Если есть свойство `_activity`, результат Вызова создаётся с помощью чёткого программного кода, который всегда даёт предсказуемый ответ.
   - **Latent (Скрытый/Креативный)**: Это поведение по умолчанию, если `_activity` отсутствует. Результат генерируется ИИ, который сам придумывает решение. Для этого требуется свойство `_output`, которое описывает, как должен выглядеть результат.

Этими элементами управления можно по-разному управлять и комбинировать их. Чтобы узнать подробнее, как это работает, смотри **[Протокол Импортов](./008_agent_imports.md)**.

## Идея, Инструмент и Вызов: Разный фокус внимания

Чтобы понять разницу, давай посмотрим, на чём сосредоточен каждый из этих трёх элементов.

- **Идея** — **сосредоточена на результате**. Её главная цель — показать готовую мысль или итог работы. Это запись того, что _было_ или _могло бы_ быть сделано.

- **Инструмент** — **сосредоточен на интерфейсе**. Он описывает, какие данные (параметры) нужны на входе и каким будет результат (`_output`). Это как пустой шаблон для действия, который ждёт, когда его заполнят.

- **Вызов** — **сосредоточен на исполнении**. Это уже готовый к запуску экземпляр Инструмента. Он берёт шаблон Инструмента и заполняет его конкретными значениями, превращаясь в приказ о том, что _нужно сделать_.

## Идея-Контейнер: один миг для принятия решения

Когда агенту нужно принять решение, мы отправляем ИИ специальный запрос в виде особой «Идеи», которую мы называем **Идея-Контейнер**. Она представляет собой один-единственный, самодостаточный момент принятия решения.

Идея-Контейнер упаковывает два ключевых ингредиента, которые нужны ИИ для выбора:

1. **Контекст**: Вся важная информация, которая нужна агенту, например, запрос пользователя, предыдущие действия и другие данные об окружении.
2. **Схема**: В Идее-Контейнере схема в основном нужна для того, чтобы определить «Контейнер» — то есть набор возможных «Инструментов», которые агенту разрешено использовать в данной конкретной ситуации.

ИИ обрабатывает всю эту «Идею» — и контекст, и список доступных инструментов, — а его «решение» (`solution`) и есть результат этого выбора: список из одного или нескольких «Вызовов», которые нужно исполнить.

Такая структура позволяет одной понятной «Идее» описать сложное действие, состоящее из нескольких шагов.

## Шаблоны выполнения Вызовов

Когда Идея-Контейнер создаёт несколько Вызовов, их можно выполнять по-разному, в зависимости от того, что нам нужно:

```typescript
// Выполнить один-единственный Вызов
const result = await Tool(call);

// Запустить все Вызовы и дождаться, пока они ВСЕ завершатся
const results = await Tool.all(calls);

// Запустить все Вызовы, но остановиться, как только ПЕРВЫЙ из них успешно завершится
const result = await Tool.any(calls);

// Запустить все Вызовы, и вернуть результат самого ПЕРВОГО, который завершится (неважно, успешно или с ошибкой). Это как гонка.
const result = await Tool.race(calls);
```

Эти шаблоны дают нам гибкость:

- **Точный контроль**: Обрабатывать вызовы по одному, выполняя между ними свою логику.
- **Пакетная обработка**: Выполнять независимые вызовы одновременно для максимальной скорости.
- **Быстрые стратегии**: Останавливаться после первого успеха (`.any()`) или первого завершения (`.race()`).
- **Операции «всё или ничего»**: Гарантировать, что либо все Вызовы в группе выполнятся успешно, либо ни один (`.all()`), что помогает сохранять целостность данных.