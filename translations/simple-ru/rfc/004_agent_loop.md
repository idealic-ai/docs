# 004: Агент/Цикл

> **Цикл:** Представь, что это как прохождение уровня в видеоигре. Ты делаешь один ход (`Запрос`), чтобы достичь цели. Игра отвечает тебе каким-то событием (`Вызов`). Ты смотришь на это событие и решаешь, каким будет твой следующий ход. И так продолжается, пока ты не пройдёшь уровень и игра не скажет: «Больше ходов не нужно!».
>
> — [Глоссарий](./000_glossary.md)

> Sidenote:
>
> - Требуется:
>   - [Агент: Запрос](./001_agent_request.md)
>   - [Агент: Инструмент](./002_agent_tool.md)
>   - [Агент: Вызов](./003_agent_call.md)

В этом документе мы разберёмся, что такое **Протокол Цикла**. Это специальный набор правил, который помогает нашему агенту (умному помощнику) выполнять сложные задачи, состоящие из нескольких шагов. Он делает это, повторяя раз за разом протокол `Запроса`.

## Цикл выполнения

Цикл Агента — это главный моторчик, который позволяет ему работать самостоятельно и делать много дел по порядку. Вот как это работает, шаг за шагом:

1.  **Сбор информации:** Сначала цикл собирает всё, что ему нужно знать для начала работы. Это как подготовка к заданию: он узнаёт, какая у него цель (что попросил пользователь), в каком состоянии всё находится сейчас (`State`) и любую другую важную информацию. Это его «шпаргалка».
2.  **Отправка `Запроса`:** Имея всю информацию, он отправляет **[Агент: Запрос](./001_agent_request.md)**. Это как сказать: «Окей, вот что я знаю, и вот какие у меня есть инструменты (`Tools`). Что мне делать дальше?»
3.  **Получение плана действий:** В ответ на `Запрос` приходит `solution` (решение). Внутри этого решения — список из одного или нескольких **[Агент: Вызовов](./003_agent_call.md)s**. Иногда список может быть и пустым. `Вызов` — это конкретная команда, которую нужно выполнить.
4.  **Выполнение и запоминание:**
    - Если в «решении» есть `Вызовы` (команды), цикл их выполняет. Например, если команда (`Call`) была `Explicit` (явная), он запускает нужный кусочек кода-действия (`Activity`).
    - Результаты выполнения этих команд он тут же добавляет в свою «шпаргалку» для следующего шага. Это как сделать что-то, увидеть результат и записать его, чтобы учесть в будущем.
5.  **Завершение:** Если в «решении» не оказалось ни одного `Вызова` (список команд пуст), это значит, что агент решил свою задачу. Он считает, что работа сделана, и цикл останавливается. Уровень пройден!

## Контроль со стороны человека (HITL)

Крутая особенность Цикла Агента — это то, что он легко позволяет человеку наблюдать за процессом и вмешиваться. Поскольку цикл сначала придумывает, что делать (`Вызовы`), а только потом это выполняет, у нас появляется возможность поставить его на паузу и спросить у человека:

- **Разрешение:** Прежде чем выполнить команды (`Вызовы`), система может показать их человеку и спросить: «Ты уверен, что это нужно сделать?».
- **Исправление:** Человек может поменять что-то в команде (`Вызове`) или даже заменить её на совсем другую.

Эта возможность очень важна для безопасности — чтобы наш умный помощник не наделал глупостей. А ещё это полезно, когда человек и агент работают вместе, как одна команда. Все поправки и советы от человека агент может использовать в своём **[Агент: Плане](./009_agent_plan.md)**, чтобы в следующий раз действовать ещё умнее.