# 004: Агент/Цикл

> Sidenote:
>
> - Требуется:
>   - [Агент: Запрос](./001_agent_request.md)
>   - [Агент: Инструмент](./002_agent_tool.md)
>   - [Агент: Вызов](./003_agent_call.md)

> **Цикл (Loop):** — это последовательность `Request`ов, направленная на достижение цели. Агент продолжает вызывать `Request`ы, обрабатывать полученные `Call`ы и передавать результат обратно в контекст для следующего `Request`а до тех пор, пока не перестанут генерироваться новые `Call`ы.
>
> — [Глоссарий](./000_glossary.md)

Этот документ описывает **Протокол Цикла (Loop Protocol)**, который позволяет агенту выполнять многошаговые задачи, итеративно вызывая протокол `Request`.

## Цикл выполнения

Цикл Агента — это основной механизм для автономного, многошагового выполнения. Он работает следующим образом:

1.  **Сборка контекста:** Цикл начинается со сборки исходного контекста, который может включать цель пользователя, текущее `State` и другую необходимую информацию.
2.  **Вызов Запроса:** Он вызывает протокол **[Агент: Запрос](./001_agent_request.md)** с текущим контекстом и схемой доступных `Tools`.
3.  **Обработка Вызовов:** `Request` возвращает `solution`, содержащий массив из нуля или более **[Агент: Вызов](./003_agent_call.md)ов**.
4.  **Выполнение и обратная связь:**
    - Если `solution` содержит `Call`ы, цикл выполняет их. Для `Explicit` `Call`ов это означает вызов соответствующего кода `Activity`.
    - Результаты этих `Call`ов добавляются обратно в контекст для следующей итерации.
5.  **Завершение:** Если `solution` не содержит `Call`ов, агент считает свою цель достигнутой, и цикл завершается.

## Участие человека в цикле (Human-in-the-Loop, HITL)

Ключевая особенность Цикла Агента — это естественная поддержка контроля со стороны человека. Поскольку цикл разделяет генерацию `Call`ов и их выполнение, у пользователя появляется возможность вмешаться:

- **Одобрение:** Перед выполнением `Call`ов система может показать их пользователю для получения одобрения.
- **Корректировка:** Пользователь может изменить параметры `Call`а или даже заменить его другим.

Эта возможность крайне важна для безопасности и для совместных задач, где агент выступает в роли помощника. Корректировки и обратная связь от пользователя могут использоваться **[Агентом: План](./009_agent_plan.md)**, что позволяет агенту уточнять свою стратегию на основе человеческого ввода.