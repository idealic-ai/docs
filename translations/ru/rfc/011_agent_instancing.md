# 011: Агент/Инстансинг

> **Инстансинг:** Процесс обработки нескольких независимых `Instances` (каждый со своим `State Object` и уникальным идентификатором) в рамках одного запроса к агенту. — [Глоссарий](./000_glossary.md)

> Sidenote: Требуется [010: Агент/Состояние](./010_agent_state.md). Совместим с [007: Агент/Ввод](./007_agent_input.md), [008: Агент/Импорты](./008_agent_imports.md) и [012: Агент/План](./012_agent_plan.md).

**Протокол Инстансинга** — это ориентированный на данные паттерн, который связывает несколько независимых объектов данных в одном запросе к агенту. Используя архитектуру, управляемую состоянием, агент может одновременно работать с массивом `State Objects`, что значительно повышает пропускную способность и согласованность. Этот протокол является ключом к масштабированию операций агента от обработки отдельных элементов до высоконагруженных потоков данных.

## Механизм Инстансинга

Инстансинг основан на протоколе **[010: Агент/Состояние](./010_agent_state.md)**. Вместо одного `State Object` запрос может содержать их массив, где каждый представляет отдельный `Instance` задачи.

Для управления этими параллельными контекстами каждому сообщению `State` присваивается **уникальный идентификатор** через специальное свойство `_instance`. Эти идентификаторы — короткие уникальные токены (например, `①`, `②`), которые позволяют LLM связывать операции с конкретным `Instance`.

Этот подход дает значительные преимущества:

- **Эффективность**: Увеличивает пропускную способность системы за счет обработки множества инстансов в одном запросе к LLM.
- **Согласованность**: Позволяя LLM видеть несколько связанных инстансов в одном контексте, он может генерировать более согласованные и качественные планы.

## Композиция с Контекстными Сообщениями

Сила протокола заключается в том, как идентификатор `_instance` определяет область действия различных типов контекстных сообщений.

- **State:** Сообщение `State` — ядро протокола. Каждый `Instance` — это отдельный `State Object`, однозначно идентифицируемый свойством `_instance`. Это создает изолированное пространство для последовательности операций, гарантируя, что параллельные рабочие процессы не будут мешать друг другу.

  > Sidenote: [010: Агент/Состояние](./010_agent_state.md)

- **Input:** Сообщение `Input` можно использовать двумя способами. Глобальное сообщение `Input` (без идентификатора `_instance`) предоставляет конфигурацию для всех инстансов в пакете. Целевое сообщение `Input` (с идентификатором `_instance`) предоставляет данные для конкретного `State Object`, переопределяя любые глобальные входные данные.

  > Sidenote: [007: Агент/Ввод](./007_agent_input.md)

- **Imports:** Идентификатор `_instance` обеспечивает критически важную изоляцию данных для `Imports`. Когда `Call` нацелен на конкретный инстанс, его `_imports` также ограничиваются контекстом этого инстанса. Это позволяет `Module` видеть только те данные, которые относятся к его конкретной задаче, даже если он является частью большого запроса с множеством инстансов.

  > Sidenote: [008: Агент/Импорты](./008_agent_imports.md)

## Композиция с Другими Протоколами

Инстансинг интегрируется с протоколами более высокого уровня для управления потоком выполнения.

- **Calls:** Свойство `_instance` в `Call` является основным механизмом, управляющим его выполнением. Оно гарантирует, что все манипуляции с состоянием — будь то запись в `_outputPath` или чтение значения из состояния для использования в качестве входных данных — правильно привязаны к целевому `Instance`.

  > Sidenote: [004: Агент/Вызов](./004_agent_call.md)

- **Plan:** В то время как инстансинг предоставляет механизм для параллельного выполнения задач, `Plan` определяет последовательность выполняемых задач. Один и тот же многократно используемый `Plan` может применяться к каждому `Instance` в запросе, обеспечивая согласованное выполнение сложного, многоэтапного рабочего процесса для большого пакета данных.

  > Sidenote: [012: Агент/План](./012_agent_plan.md)

## От Параллелизма к Планированию

Инстансинг предоставляет механизм для параллельного выполнения задач над множеством независимых состояний. Однако последовательность задач, выполняемых для каждого состояния, часто бывает сложной и требует собственного определения. Для управления этим агенту необходим многократно используемый рабочий процесс, который можно последовательно применять к каждому инстансу.

Следующий документ, **[012: Агент/План](./012_agent_plan.md)**, описывает протокол для создания таких многократно используемых рабочих процессов на основе графов.