# 005: Агент/Цикл

> **Цикл:** Последовательность `Request`, направленная на достижение цели. Агент продолжает вызывать `Request`, обрабатывать полученные `Call` и передавать результат обратно в контекст для следующего `Request` до тех пор, пока `Call` больше не будут генерироваться. — [Глоссарий](./000_glossary.md)

> Sidenote:
> - Требуются:
>   - [001: Агент/Запрос](./001_agent_request.md)
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

Этот документ описывает **цикл исполнения**, который позволяет агенту выполнять многошаговые задачи, итеративно создавая [001: Агент/Запрос](./001_agent_request.md). Этот итеративный процесс сборки контекста, использования инструментов и обратной связи — это то, что обычно подразумевается под словом «агент».

## Цикл Исполнения

> Sidenote:
> ```mermaid
> graph TD
>     Start((Начало)) --> ContextAssembly(1. Сборка Контекста)
>     ContextAssembly --> RequestInvocation(2. Вызов Запроса)
>     RequestInvocation --> CallProcessing(3. Обработка Вызова)
>     CallProcessing --> HasCalls{Есть вызовы?}
>     HasCalls -- Нет --> Termination((5. Завершение))
>     HasCalls -- Да --> HITL{Человек в цикле}
>     HITL -- Одобрено --> Execution(4. Исполнение и Обратная связь)
>     Execution -- Результаты --> ContextAssembly
>     HITL -- Исправлено --> ContextAssembly
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```

Цикл исполнения — это основной механизм для автономного, многошагового выполнения. Он работает следующим образом:

1.  **Сборка Контекста:** Цикл начинается со сборки начального контекста, который может включать цель пользователя, текущее `State` и другую релевантную информацию.
2.  **Вызов Запроса:** Он вызывает [001: Агент/Запрос](./001_agent_request.md) с текущим контекстом и схемой доступных `Tools`.
3.  **Обработка Вызова:** `Request` возвращает `solution`, содержащий массив из нуля или более [004: Агент/Вызов](./004_agent_call.md).
4.  **Исполнение и Обратная связь:**
    - Если `solution` содержит `Call`, цикл их выполняет. Для `Explicit` `Call` это включает вызов соответствующего кода `Activity`.
    - Результаты этих `Call` затем добавляются обратно в контекст для следующей итерации.
5.  **Завершение:** Если `solution` не содержит `Call`, агент считает, что его цель достигнута, и цикл завершается.

## Человек в цикле (Human-in-the-Loop, HITL)

Ключевая особенность цикла исполнения — его естественная поддержка контроля со стороны человека. Поскольку цикл разделяет генерацию `Call` и их исполнение, это создает возможность для вмешательства пользователя:

- **Одобрение:** Перед выполнением `Call` система может представить их пользователю для одобрения.
- **Исправление:** Пользователь может изменить параметры `Call` или даже заменить его другим.

Эта возможность критически важна для безопасности и совместных задач, где агент выступает в роли ассистента. Пользовательские корректировки и обратная связь могут быть использованы [012: Агент/План](./012_agent_plan.md), что позволяет агенту уточнять свою стратегию на основе ввода от человека.

## Роль данных в цикле

Цикл исполнения предоставляет динамическую структуру для поведения агента, но его мощь реализуется через данные, которые циркулируют внутри него. Состояние, входы и выходы, управляемые на каждом цикле, позволяют агенту поддерживать контекст, учиться и выполнять сложные, многошаговые планы.

Следующий документ, [006: Агент/Данные](./006_agent_data.md), рассматривает протоколы для управления этими данными.