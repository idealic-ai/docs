# 005: Агент/Цикл

> **Цикл:** Последовательность `Запросов`, направленных на достижение цели. Агент продолжает вызывать `Запросы`, обрабатывать полученные `Вызовы` и передавать результат обратно в контекст следующего `Запроса` до тех пор, пока `Вызовы` не перестанут генерироваться. — [Глоссарий](./000_glossary.md)

> Sidenote:
> - Требуется:
>   - [001: Агент/Запрос](./001_agent_request.md)
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

Этот документ описывает **Протокол Цикла**, который позволяет агенту выполнять многоэтапные задачи путем итеративного вызова протокола `Запроса`.

## Цикл Выполнения

> Sidenote:
> ```mermaid
> graph TD
>     Start((Начало)) --> AssembleContext(Сборка Контекста)
>     AssembleContext --> InvokeRequest(Вызов Запроса)
>     InvokeRequest --> HasCalls{Решение содержит Вызовы?}
>     HasCalls -- Нет --> Stop((Конец))
>     HasCalls -- Да --> HITL{Контроль со стороны человека}
>     HITL -- Одобрено --> ExecuteCalls(Выполнение Вызовов)
>     ExecuteCalls -- Результаты --> AssembleContext
>     HITL -- Исправлено --> AssembleContext
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```

Цикл Агента — это основной механизм для автономного, многоэтапного выполнения. Он работает следующим образом

1.  **Сборка Контекста:** Цикл начинается со сборки исходного контекста, который может включать цель пользователя, текущее `Состояние` (`State`) и другую важную информацию.
2.  **Вызов Запроса:** Он вызывает протокол **[001: Агент/Запрос](./001_agent_request.md)** с текущим контекстом и схемой доступных `Инструментов` (`Tools`).
3.  **Обработка Вызовов:** `Запрос` возвращает `решение` (`solution`), содержащее массив из нуля или более **[004: Агент/Вызов](./004_agent_call.md)ов**.
4.  **Выполнение и Обратная связь:**
    - Если `решение` содержит `Вызовы`, цикл их выполняет. Для `Явных` (`Explicit`) `Вызовов` это означает запуск соответствующего кода `Действия` (`Activity`).
    - Результаты этих `Вызовов` затем добавляются обратно в контекст для следующей итерации.
5.  **Завершение:** Если `решение` не содержит `Вызовов`, агент считает свою цель достигнутой, и цикл завершается.

## Контроль со стороны человека (HITL)

Ключевая особенность Цикла Агента — это естественная поддержка контроля со стороны человека. Поскольку цикл разделяет генерацию `Вызовов` и их выполнение, у пользователя появляется возможность вмешаться:

- **Одобрение:** Перед выполнением `Вызовов` система может предоставить их пользователю для утверждения.
- **Корректировка:** Пользователь может изменить параметры `Вызова` или даже заменить его другим.

Эта возможность крайне важна для безопасности и для совместных задач, где агент выступает в роли ассистента. Корректировки и обратная связь от пользователя могут быть учтены **[Планом](./012_agent_plan.md)** (`Plan`), что позволяет агенту совершенствовать свою стратегию на основе вклада человека.