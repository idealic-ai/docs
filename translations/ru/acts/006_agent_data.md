# 006: Агент/Данные

> [!DEFINITION] [Сообщение с данными](./000_glossary.md)
> Постоянное контекстное сообщение, содержащее значение `data` и необязательную `schema`. Оно сохраняется на протяжении всего цикла выполнения агента для обеспечения стабильного, структурированного контекста.

> Sidenote:
>
> - Требуется:
>   - [001: Агент/Запрос](./001_agent_request.md)
> - Включает:
>   - [007: Агент/Ввод](./007_agent_input.md)
>   - [009: Агент/Состояние](./009_agent_state.md)
> - Дополняется:
>   - [005: Агент/Цикл](./005_agent_loop.md)
>   - [011: Агент/Экземплирование](./011_agent_instancing.md)

Этот документ описывает :term[протокол данных]{canonical="Data"}, низкоуровневый шаблон для предоставления структурированной, самоописываемой информации. Он служит основополагающим механизмом, используемым другими подсистемами, такими как :term[Ввод]{canonical="Input"} и :term[Состояние]{canonical="State"}, для управления структурированными данными в `context` агента. В отличие от временных сообщений, сообщения с :term[Данными]{canonical="Data"} являются постоянными и сохраняются между итерациями :term[цикла выполнения]{canonical="Execution Loop"} агента, обеспечивая стабильный контекст для многошаговых задач.

## Сообщение с данными

> Sidenote:
>
> - [001: Агент/Запрос](./001_agent_request.md)

Сообщение с :term[Данными]{canonical="Data"} — это простая, но мощная конструкция для добавления структурированного контекста в :term[Запрос]{canonical="Request"}. Это объект сообщения, который содержит следующие свойства:

- **`data`**: Любое значение JSON (например, строка, число, объект, массив), которое содержит полезную нагрузку.
- **`schema`**: Необязательная JSON Schema, которая определяет структуру и семантическое значение `data`.
- **`kind`**: Необязательная строка, которая идентифицирует роль сообщения (например, `"state"`, `"input"`). Это позволяет системе и LLM различать различные типы данных в одном и том же контексте.

Сочетая данные с необязательной схемой, сообщение с :term[Данными]{canonical="Data"} делает контекст машиночитаемым. `schema` действует как черновик, объясняя LLM, что означает каждое свойство, каков его тип и какие ограничения применяются. Это не только направляет рассуждения LLM, но и служит формой документации, показывая пользователям, что можно изменить или настроить.

## Слияние и идентичность

Протокол предназначен для обработки нескольких сообщений с :term[Данными]{canonical="Data"} в рамках одного `context`. Если система определяет, что несколько сообщений имеют одинаковую идентичность, они объединяются в один целостный объект. Это особенно полезно для сценариев, таких как применение серии исправлений состояния.

Идентичность сообщения в первую очередь определяется его `kind`. Например, все сообщения с `kind: "state"` без каких-либо других отличительных признаков считаются имеющими одинаковую идентичность. Эта идентичность может быть дополнительно уточнена другими протоколами, в первую очередь :term[Экземплированием]{canonical="Instancing"}, которое позволяет выполнять параллельную обработку путем создания различных контекстов.

> Sidenote:
>
> - [011: Агент/Экземплирование](./011_agent_instancing.md)

Когда присутствует несколько объединяемых сообщений (например, несколько объектов `state`, представляющих исправления), система может обработать это двумя способами. Во-первых, :term[цикл выполнения]{canonical="Execution Loop"} агента может явно объединить эти объекты в один целостный объект состояния перед тем, как представить его LLM. Это снижает когнитивную нагрузку на модель. Во-вторых, сама LLM может «мысленно объединить» информацию в своем скрытом пространстве, понимая, что отдельные сообщения представляют разные аспекты одной концепции.

:::::details{title="Пример того, как сообщения с данными видит LLM" open=false}

- Сообщение `text` передается как есть.
- Сообщения `data` объединяются и преобразуются в одно сообщение `text`

::::columns
:::column{title="Как выглядит код"}

```typescript
Agent.Request(config, schema, [
  {
    type: 'text',
    text: "Update the user's city to Austin",
  },

  // Схема сериализуется, чтобы LLM поняла семантику
  {
    type: 'data',
    kind: 'user',
    description: 'Represents the current user.',
    data: { name: 'John Doe' },
    schema: {
      type: 'object',
      properties: {
        name: { type: 'string' },
        age: { type: 'number' },
        city: { type: 'string' },
      },
    },
  },

  // Второе сообщение `user` объединится с первым
  {
    type: 'data',
    kind: 'user',
    data: { age: 30 },
  },
]);
```

:::
:::column{title="Что видит LLM"}

```typescript
[
  {
    role: 'user',
    content: {
      type: 'text',
      text: "Update the user's city to Austin",
    },
  },
  {
    role: 'user',
    content: {
      type: 'text',
      text: `
        ## Data: ¶user
        {
          "name": "John Doe",
          "age": 30
        }
        Represents the current user.
        Schema for ¶user:
        {
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "age": { "type": "number" },
            "city": { "type": "string" }
          }
        }`,
    },
  },
];
```

:::
::::
:::::

## Взаимодействие с другими протоколами

Протокол :term[Данных]{canonical="Data"} является основополагающим шаблоном, который специализируется и расширяется несколькими другими протоколами более высокого уровня.

- **:term[Цикл]{canonical="Loop"}:** :term[Цикл выполнения]{canonical="Execution Loop"} использует сообщения с :term[Данными]{canonical="Data"} для поддержания непрерывности. Сообщение о :term[Состоянии]{canonical="State"}, специализированное сообщение с :term[Данными]{canonical="Data"}, является основным средством для сохранения информации между тактами :term[цикла]{canonical="Loop"}.

  > Sidenote:
  >
  > - [005: Агент/Цикл](./005_agent_loop.md)

- **:term[Состояние]{canonical="State"}:** Протокол :term[Состояния]{canonical="State"} использует сообщение с :term[Данными]{canonical="Data"} для представления постоянной, развивающейся памяти рабочего процесса. `schema` сообщения определяет структуру объекта состояния, включая доступные свойства и :term[переменные]{canonical="Variable"}.

  > Sidenote:
  >
  > - [010: Агент/Состояние](./010_agent_state.md)

- **:term[Экземплирование]{canonical="Instancing"}:** Все сообщения с :term[Данными]{canonical="Data"} подлежат :term[Экземплированию]{canonical="Instancing"}. Свойство `_instance` действует как ключ, который ограничивает данные определенным потоком выполнения в рамках более крупной пакетной операции. Сообщения с :term[Данными]{canonical="Data"} с разными значениями `_instance` не будут объединяться, обеспечивая изоляцию данных между параллельными процессами.

  > Sidenote:
  >
  > - [011: Агент/Экземплирование](./011_agent_instancing.md)

- **:term[Ввод]{canonical="Input"}:** Протокол :term[Ввода]{canonical="Input"} использует сообщение с :term[Данными]{canonical="Data"} для формального объявления параметров, которые принимает :term[Запрос]{canonical="Request"}. Это механизм, который превращает статический :term[Запрос]{canonical="Request"} в повторно используемый, подобный функции компонент.

  > Sidenote:
  >
  > - [007: Агент/Ввод](./007_agent_input.md)

## От данных к динамическим связям

Протокол :term[Данных]{canonical="Data"} предоставляет универсальный контейнер для структурированной информации. Утвердив эту основу, мы теперь можем исследовать, как динамически связывать эти фрагменты данных. Это критически важный шаг, который позволяет агенту создавать рабочие процессы, где вывод одного шага становится вводом для другого.

Следующий документ, :term[008: Агент/Переменные]{href="./008_agent_variables.md"}, описывает протокол, который делает возможными эти динамические связи.
