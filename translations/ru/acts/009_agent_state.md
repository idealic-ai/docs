# 009: Агент/Состояние

> [!DEFINITION] [Сообщение о Состоянии](./000_glossary.md)
> Сообщение типа `Data`, которое представляет собой постоянно обновляемую память рабочего процесса. Оно работает как набор локальных переменных, позволяя выполнять многошаговые операции с сохранением состояния.

> Sidenote:
> - Требуется:
>   - [004: Агент/Вызов](./004_agent/call.md)
>   - [006: Агент/Данные](./006_agent/data.md)
> - Позволяет:
>   - [010: Агент/План](./010_agent/plan.md)
> - Дополняется:
>   - [011: Агент/Экземплирование](./011_agent/instancing.md)
>   - [012: Агент/Делегат](./012_agent/delegate.md)
>   - [013: Агент/ОбластиВидимости](./013_agent/scopes.md)

Этот документ описывает **сообщение о Состоянии** — специализированное сообщение :term[Data]{canonical="Data"}, которое обеспечивает постоянную память для :term[Цикла Выполнения]{canonical="Execution Loop"} агента. В то время как :term[Переменные]{canonical="Variable"} служат «проводами» для соединения инструментов, объект :term[Состояния]{canonical="State"} предоставляет «черновик», где результаты этих соединений сохраняются и поддерживаются на протяжении нескольких шагов.

Объект :term[Состояния]{canonical="State"} выступает источником истины о текущем статусе запроса и является ключом к отказоустойчивости и возобновлению работы. Поскольку он содержит полный контекст рабочего процесса в определенный момент времени, это позволяет приостанавливать и возобновлять процесс. Когда начинается новая итерация, :term[Состояние]{canonical="State"} из предыдущего шага дает LLM четкое понимание того, на чем остановился процесс, что позволяет последующим операциям беспрепятственно продолжить работу.

## Управление рабочим процессом с помощью схемы

Предоставление `schema` для объекта :term[Состояния]{canonical="State"} — это необязательный, но мощный шаг. Схема документирует предполагаемый поток данных, определяя набор ожидаемых свойств. Это неявно определяет взаимодействия между :term[Инструментами]{canonical="Tool"} и намекает на общий процесс. Это создает сильную обратную связь для LLM: зная, какие свойства должно содержать :term[Состояние]{canonical="State"}, она генерирует :term[Вызовы Инструментов]{canonical="Call"} с соответствующими значениями `_outputPath`. Это улучшает результаты, гарантируя, что действия агента структурно корректны и соответствуют желаемому рабочему процессу.

> Sidenote:
> - [008: Агент/Переменные](./008_agent_variables.md)

## Многошаговые инструменты

Основная функция сообщения о :term[Состоянии]{canonical="State"} — позволить различным :term[Инструментам]{canonical="Tool"} обмениваться информацией в рамках одного непрерывного процесса. Оно обеспечивает операции с сохранением состояния, предоставляя общий черновик, где :term[Инструменты]{canonical="Tool"} могут хранить свои результаты.

Это достигается с помощью простого механизма чтения/записи: один :term[Инструмент]{canonical="Tool"} может записать свой результат в объект :term[Состояния]{canonical="State"}, а другой :term[Инструмент]{canonical="Tool"} затем может прочитать эти данные в качестве входных на следующем шаге. Это позволяет создавать цепочки инструментов, где результат работы одного инструмента напрямую используется как входные данные для следующего, и все это без потери контекста между выполнениями.

## Планирование и Выполнение

Сочетание записи в состояние через `_outputPath` и чтения из него с помощью :term[Ссылок на Переменные]{canonical="Variable Reference"} является основным механизмом, который позволяет отделить планирование от выполнения. Это позволяет агенту построить полный граф потока данных — цепочку :term[Вызовов Инструментов]{canonical="Call"}, связанных ссылками, — _до_ запуска любого инструмента.

Этот граф ссылок можно проверять, повторно использовать и даже симулировать, что делает его полностью совместимым со скрытым выполнением LLM. Гибкость этой системы обусловлена возможностью контролировать как входные, так и выходные данные на уровне схемы. Разработчик рабочего процесса может оставить :term[Ссылки на Переменные]{canonical="Variable Reference"} (входные данные) и `_outputPath` (выходные данные) динамическими, чтобы LLM принимала решение, или же задать их жестко для обеспечения надежного потока данных.

> [!HEADSUP] На заметку
> Создание :term[Вызовов Инструментов]{canonical="Call"}, связанных друг с другом через :term[Состояние]{canonical="State"}, является актом планирования. Эта система обеспечивает техническую основу для этого процесса: постоянное :term[Состояние]{canonical="State"} служит черновиком, :term[Ссылки на Переменные]{canonical="Variable Reference"} и `_outputPath` — проводами, а :term[Цикл]{canonical="Loop"} агента — итеративным движком. Вместе эти компоненты позволяют агенту построить полный граф потока данных, что и является сутью :term[Плана]{canonical="Plan"}.
>
> > Sidenote:
> >
> > - [005: Агент/Цикл](./005_agent_loop.md)
> > - [010: Агент/План](./010_agent_plan.md)

## Взаимодействие

- **:term[Вызов]{canonical="Call"}:** Система :term[Вызовов]{canonical="Call"} тесно связана с :term[Состоянием]{canonical="State"} через мета-свойство `_outputPath`. Это свойство превращает :term[Вызов Инструмента]{canonical="Call"}, который в противном случае мог бы быть чистой функцией без состояния, в операцию, изменяющую состояние. Указывая `_outputPath`, :term[Вызов]{canonical="Call"} дает команду движку записать свой результат в объект :term[Состояния]{canonical="State"}, что делает его основным механизмом для записи агентом результатов своих действий. Это взаимодействие позволяет последовательности :term[Вызовов]{canonical="Call"} основываться друг на друге, создавая причинно-следственную цепочку, которая записывается в :term[Состоянии]{canonical="State"}.

  > Sidenote:
  > - [004: Агент/Вызов](./004_agent_call.md)

- **:term[Данные]{canonical="Data"}:** Сообщение о :term[Состоянии]{canonical="State"} по сути является специализированным применением системы сообщений :term[Данных]{canonical="Data"}, используя сообщение :term[Данных]{canonical="Data"} с `kind: "state"`. Оно использует основные возможности сообщений :term[Данных]{canonical="Data"} для создания постоянной памяти для агента. Свойство `schema` используется для определения ожидаемой структуры этой памяти, предоставляя черновик, который направляет действия LLM. Кроме того, критически важны возможности объединения системы :term[Данных]{canonical="Data"}, которые позволяют обновлять :term[Состояние]{canonical="State"} постепенно через серию исправлений, а система сводит их в единое, целостное представление.

  > Sidenote:
  > - [006: Агент/Данные](./006_agent_data.md)

- **:term[ОбластиВидимости]{canonical="Scope"}:** Система :term[Областей Видимости]{canonical="Scope"} является основным механизмом для предоставления объекта :term[Состояния]{canonical="State"} :term[Инструменту]{canonical="Tool"}, работающему в изолированном контексте, например, :term[Делегату]{canonical="Delegate"}. Когда :term[Вызов]{canonical="Call"} делегируется, свойство `_scopes` может указывать, что :term[Состояние]{canonical="State"} должно быть включено в «чистую комнату» делегата. Это позволяет инкапсулированным инструментам читать и взаимодействовать с состоянием основного рабочего процесса контролируемым и явным образом.

  > Sidenote:
  > - [013: Агент/ОбластиВидимости](./013_agent_scopes.md)

- **:term[Экземплирование]{canonical="Instancing"}:** Сообщение о :term[Состоянии]{canonical="State"} полностью совместимо с системой :term[Экземплирования]{canonical="Instancing"}. Когда запрос обрабатывает несколько :term[Экземпляров]{canonical="Instance"}, каждый из них поддерживает свой собственный изолированный объект :term[Состояния]{canonical="State"}, идентифицируемый уникальным ключом `_instance`. :term[Ссылки на Переменные]{canonical="Variable Reference"} (например, `†state.currentUser.id`) автоматически и прозрачно направляются к правильному объекту :term[Состояния]{canonical="State"}, соответствующему :term[Экземпляру]{canonical="Instance"}, на который нацелен :term[Вызов Инструмента]{canonical="Call"}. Это позволяет выполнять один общий `План` для множества различных состояний параллельно с гарантированной изоляцией данных.

  > Sidenote:
  > - [011: Агент/Экземплирование](./011_agent_instancing.md)

- **:term[План]{canonical="Plan"}:** Хотя :term[Состояние]{canonical="State"} позволяет создавать простые последовательности инструментов, его полная мощь раскрывается при использовании в качестве основы системы :term[Планов]{canonical="Plan"}. В сообщении :term[Плана]{canonical="Plan"} рабочий процесс представлен в виде направленного ациклического графа (DAG), где узлами являются :term[Вызовы Инструментов]{canonical="Call"}. Объект :term[Состояния]{canonical="State"} обеспечивает связи — ребра — между этими узлами. Он позволяет одному узлу записывать в переменную, а другим читать из нее, что делает возможными сложные шаблоны, такие как логические ветвления (if-else) или параллельное разветвление.

  > Sidenote:
  > - [010: Агент/План](./010_agent_plan.md)

## От одного Состояния к оркестрованным рабочим процессам

Сообщение о :term[Состоянии]{canonical="State"} предоставляет механизм для управления памятью одного целостного рабочего процесса. Имея постоянный черновик и переменные для соединения инструментов, теперь мы можем проектировать и выполнять сложные многошаговые рабочие процессы.

Следующий документ, :term[010: Агент/План]{href="./010_agent_plan.md"}, описывает систему для оркестрации этих рабочих процессов в виде графа :term[Вызовов Инструментов]{canonical="Call"}.
