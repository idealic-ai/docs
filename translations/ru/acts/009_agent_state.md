# 009: Агент/Состояние

> [!DEFINITION] [Сообщение состояния](./000_glossary.md)
> Постоянное сообщение `Data`, которое представляет собой живую, развивающуюся память рабочего процесса. Оно действует как набор локальных переменных, обеспечивая многошаговые операции с сохранением состояния.

> Sidenote:
> - Требует:
>   - [004: Агент/Вызов](./004_agent_call.md)
>   - [005: Агент/Данные](./005_agent_data.md)
> - Открывает возможности для:
>   - [011: Агент/План](./012_agent_plan.md)
> - Дополняется:
>   - [012: Агент/Экземплирование](./013_agent_instancing.md)
>   - [013: Агент/Делегат](./014_agent_delegate.md)
>   - [014: Агент/Области видимости](./015_agent_scopes.md)

**Сообщение состояния** — это специализированное сообщение :term[данных]{canonical="Data"}, которое обеспечивает постоянную память для :term[цикла выполнения]{canonical="Execution Loop"} агента. В то время как :term[переменные]{canonical="Variable"} служат «проводами» для соединения инструментов, объект :term[состояния]{canonical="State"} предоставляет «черновик», где хранятся и поддерживаются результаты этих соединений на протяжении нескольких шагов.

Объект :term[состояния]{canonical="State"} выступает источником истины о текущем статусе запроса и является ключом к отказоустойчивости и возобновлению работы. Поскольку он фиксирует полный контекст рабочего процесса в определенный момент времени, это позволяет приостанавливать и возобновлять процесс. Когда начинается новая итерация, :term[состояние]{canonical="State"} из предыдущего шага дает LLM четкое понимание того, на чем остановился процесс, обеспечивая бесшовное продолжение работы последующими операциями.

## Управление рабочим процессом с помощью схемы

Предоставление `schema` для объекта :term[состояния]{canonical="State"} — это необязательный, но мощный шаг. Схема документирует предполагаемый поток данных, определяя набор ожидаемых свойств. Это неявно определяет взаимодействия между :term[инструментами]{canonical="Tool"} и намекает на общий процесс. Это создает мощную обратную связь для LLM: зная, какие свойства должно содержать :term[состояние]{canonical="State"}, она направляется на генерацию :term[вызовов инструментов]{canonical="Call"} с соответствующими значениями :term[путей вывода]{canonical="Output Path"}. Это улучшает результаты, гарантируя, что действия агента структурно корректны и соответствуют желаемому рабочему процессу.

> Sidenote:
> - [007: Агент/Переменные](./007_agent_variables.md)
> - [008: Агент/Вывод](./008_agent_output.md)

## Многошаговые инструменты

Основная функция сообщения :term[состояния]{canonical="State"} — позволить различным :term[инструментам]{canonical="Tool"} обмениваться информацией в рамках единого непрерывного процесса. Оно обеспечивает операции с сохранением состояния, предоставляя общий черновик, где :term[инструменты]{canonical="Tool"} могут хранить свои результаты.

Это достигается с помощью простого механизма чтения/записи: один :term[инструмент]{canonical="Tool"} может записать свой вывод в объект :term[состояния]{canonical="State"}, а другой :term[инструмент]{canonical="Tool"} затем может прочитать эти данные в качестве входных на следующем шаге. Это позволяет создавать цепочки инструментов, где вывод одной возможности напрямую используется как ввод для следующей, и все это без потери контекста между выполнениями.

## Планирование и выполнение

Комбинация записи в состояние через :term[путь вывода]{canonical="Output Path"} и чтения из него с помощью :term[ссылок на переменные]{canonical="Variable Reference"} является основным механизмом, который позволяет отделить планирование от выполнения. Это позволяет агенту построить полный граф потока данных — цепочку :term[вызовов инструментов]{canonical="Call"}, связанных ссылками, — _перед_ запуском любого инструмента.

Этот граф ссылок можно проверять, использовать повторно и даже симулировать, что делает его полностью совместимым со скрытым выполнением LLM. Гибкость этой системы обусловлена возможностью контролировать как входы, так и выходы на уровне схемы. Разработчик рабочего процесса может оставить :term[ссылки на переменные]{canonical="Variable Reference"} (входы) и :term[пути вывода]{canonical="Output Path"} (выходы) динамическими, чтобы LLM принимала решение, или же предписать их для обеспечения жесткого и надежного потока данных.

> [!HEADSUP] На заметку
> Создание :term[вызовов инструментов]{canonical="Call"}, связанных друг с другом через :term[состояние]{canonical="State"}, является актом планирования. Эта система обеспечивает техническую основу для этого процесса: постоянное :term[состояние]{canonical="State"} служит черновиком, :term[ссылки на переменные]{canonical="Variable Reference"} и :term[пути вывода]{canonical="Output Path"} — «проводами», а :term[цикл]{canonical="Loop"} агента — итеративным движком. Вместе эти компоненты позволяют агенту построить полный граф потока данных, что и является сущностью :term[плана]{canonical="Plan"}.
>
> > Sidenote:
> >
> > - [010: Агент/Цикл](./010_agent_loop.md)
> > - [011: Агент/План](./012_agent_plan.md)

## Взаимодействие с другими системами

- **:term[Вызов]{canonical="Call"}:** Система :term[вызовов]{canonical="Call"} тесно связана с :term[состоянием]{canonical="State"} через мета-свойство :term[пути вывода]{canonical="Output Path"}. Это свойство превращает :term[вызов инструмента]{canonical="Call"}, который в ином случае мог бы быть чистой функцией без сохранения состояния, в операцию, изменяющую состояние. Указывая :term[путь вывода]{canonical="Output Path"}, :term[вызов]{canonical="Call"} направляет движок записать свой результат в объект :term[состояния]{canonical="State"}, что делает его основным механизмом для агента для записи результатов своих действий. Это взаимодействие позволяет последовательности :term[вызовов]{canonical="Call"} строиться друг на друге, создавая причинно-следственную цепь, которая записывается в :term[состоянии]{canonical="State"}.

  > Sidenote:
  > - [004: Агент/Вызов](./004_agent_call.md)

- **:term[Данные]{canonical="Data"}:** Сообщение :term[состояния]{canonical="State"} по своей сути является специализированным применением системы сообщений :term[данных]{canonical="Data"}, используя сообщение :term[данных]{canonical="Data"} с `kind: "state"`. Оно использует основные возможности сообщений :term[данных]{canonical="Data"} для создания постоянной памяти для агента. Свойство `schema` используется для определения ожидаемой структуры этой памяти, предоставляя черновик, который направляет действия LLM. Кроме того, возможности слияния системы :term[данных]{canonical="Data"} имеют решающее значение, позволяя инкрементально обновлять :term[состояние]{canonical="State"} через серию правок, при этом система преобразует их в единое, согласованное представление.

  > Sidenote:
  > - [005: Агент/Данные](./005_agent_data.md)

- **:term[Области видимости]{canonical="Scope"}:** Система :term[областей видимости]{canonical="Scope"} является основным механизмом для предоставления объекта :term[состояния]{canonical="State"} :term[инструменту]{canonical="Tool"}, работающему в изолированном контексте, например, у :term[делегата]{canonical="Delegate"}. Когда :term[вызов]{canonical="Call"} делегируется, свойство `_scopes` может указывать, что :term[состояние]{canonical="State"} должно быть включено в «чистую комнату» делегата. Это позволяет инкапсулированным инструментам читать данные из основного состояния рабочего процесса и взаимодействовать с ним контролируемым и явным образом.

  > Sidenote:
  > - [014: Агент/Области видимости](./015_agent_scopes.md)

- **:term[Экземплирование]{canonical="Instancing"}:** Сообщение :term[состояния]{canonical="State"} полностью совместимо с системой :term[экземплирования]{canonical="Instancing"}. Когда запрос обрабатывает несколько :term[экземпляров]{canonical="Instance"}, каждый из них поддерживает свой собственный изолированный объект :term[состояния]{canonical="State"}, идентифицируемый уникальным ключом `_instance`. :term[Ссылки на переменные]{canonical="Variable Reference"} (например, `†state.currentUser.id`) автоматически и прозрачно направляются к правильному объекту :term[состояния]{canonical="State"}, соответствующему :term[экземпляру]{canonical="Instance"}, на который нацелен :term[вызов инструмента]{canonical="Call"}. Это позволяет выполнять один общий :term[план]{canonical="Plan"} параллельно для множества различных состояний с гарантированной изоляцией данных.

  > Sidenote:
  > - [012: Агент/Экземплирование](./013_agent_instancing.md)

- **:term[План]{canonical="Plan"}:** Хотя :term[состояние]{canonical="State"} позволяет создавать простые последовательности инструментов, его полная мощь раскрывается при использовании в качестве основы системы :term[планов]{canonical="Plan"}. В сообщении :term[плана]{canonical="Plan"} рабочий процесс представлен в виде направленного ациклического графа (DAG), где узлами являются :term[вызовы инструментов]{canonical="Call"}. Объект :term[состояния]{canonical="State"} обеспечивает связи — ребра — между этими узлами. Он позволяет одному узлу записывать данные в переменную, а другим — читать их, что позволяет реализовывать сложные шаблоны, такие как логические ветвления (if-else) или параллельные разветвления.

  > Sidenote:
  > - [011: Агент/План](./012_agent_plan.md)

## От одиночного состояния к организованным рабочим процессам

Сообщение :term[состояния]{canonical="State"} предоставляет механизм для управления памятью единого, согласованного рабочего процесса. Имея постоянный черновик и переменные для соединения инструментов, мы теперь можем проектировать и выполнять сложные, многошаговые рабочие процессы.

Следующий документ, :term[011: Агент/План]{href="./012_agent_plan.md"}, описывает систему для организации этих рабочих процессов в виде графа :term[вызовов инструментов]{canonical="Call"}.
