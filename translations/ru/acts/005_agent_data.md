# 005: Агент/Данные

> [!DEFINITION] [Сообщение с данными](./000_glossary.md)
> Постоянное контекстное сообщение, содержащее значение `data` и необязательную `schema`. Оно сохраняется на протяжении всего цикла выполнения агента для обеспечения стабильного, структурированного контекста.

> Sidenote:
> - Требуется:
>   - [001: Агент/Запрос](./001_agent_request.md)
> - Открывает возможности для:
>   - [006: Агент/Ввод](./006_agent_input.md)
>   - [009: Агент/Состояние](./009_agent_state.md)
> - Дополняется:
>   - [010: Агент/Цикл](./010_agent_loop.md)
>   - [012: Агент/Экземплирование](./013_agent_instancing.md)

:term[Протокол данных]{canonical="Data"} — это низкоуровневый шаблон для предоставления структурированной, самоописываемой информации. Он служит фундаментальным механизмом, используемым другими подсистемами, такими как :term[Ввод]{canonical="Input"} и :term[Состояние]{canonical="State"}, для управления структурированными данными в `контексте` агента. В отличие от эфемерных сообщений, сообщения с :term[Данными]{canonical="Data"} являются постоянными и сохраняются на протяжении нескольких шагов процесса агента, обеспечивая стабильный контекст для многоэтапных задач.

## Сообщение с данными

> Sidenote:
> - [001: Агент/Запрос](./001_agent_request.md)

Сообщение с :term[Данными]{canonical="Data"} — это простая, но мощная конструкция для добавления структурированного контекста в :term[Запрос]{canonical="Request"}. Это объект сообщения, который содержит следующие свойства:

- **`data`**: Любое значение JSON (например, строка, число, объект, массив), содержащее полезную нагрузку.
- **`schema`**: Необязательная JSON Schema, которая определяет структуру и семантическое значение `data`.
- **`kind`**: Необязательная строка, которая идентифицирует роль сообщения (например, `"state"`, `"input"`). Это позволяет системе и LLM различать различные типы :term[данных]{canonical="Data"} в одном и том же контексте.

Сочетая :term[данные]{canonical="Data"} с необязательной схемой, сообщение :term[Data]{canonical="Data"} делает контекст машиночитаемым. `schema` действует как :term[черновик]{canonical="blueprint"}, объясняя LLM, что означает каждое свойство, какой у него тип и какие ограничения применяются. Это не только направляет рассуждения LLM, но и служит формой документации, показывая пользователям, что можно изменить или настроить.

## Слияние и идентичность

Протокол предназначен для обработки нескольких сообщений с :term[Данными]{canonical="Data"} в рамках одного `контекста`. Если система решает, что несколько сообщений имеют одинаковую идентичность, они объединяются в один целостный объект. Это особенно полезно для сценариев, таких как применение серии исправлений состояния.

Идентичность сообщения в первую очередь определяется его `kind`. Например, все сообщения с `kind: "state"` без каких-либо других отличительных признаков считаются имеющими одинаковую идентичность. Эта идентичность может быть дополнительно уточнена другими протоколами, в первую очередь :term[Экземплированием]{canonical="Instancing"}, которое позволяет выполнять параллельную обработку путем создания различных контекстов.

> Sidenote:
> - [012: Агент/Экземплирование](./013_agent_instancing.md)

Когда присутствует несколько объединяемых сообщений (например, несколько объектов `state`, представляющих исправления), система может обработать это двумя способами. Во-первых, логика выполнения агента может явно объединить эти объекты в один целостный объект состояния перед его представлением LLM. Это снижает когнитивную нагрузку на модель. Во-вторых, сама LLM может «мысленно объединить» информацию в своем :term[скрытом состоянии]{canonical="latent space"}, понимая, что отдельные сообщения представляют разные аспекты единой :term[концепции]{canonical="concept"}.

:::::details{title="Пример того, как сообщения с данными видит LLM" open=false}

- Сообщение `text` передается без изменений.
- Сообщения `data` объединяются и преобразуются в одно сообщение `text`.

::::columns
:::column{title="Как выглядит код"}

```typescript
Agent.Request(config, schema, [
  {
    type: 'text',
    text: "Обновите город пользователя на Остин",
  },

  // Схема сериализуется, чтобы LLM мог понять семантику
  {
    type: 'data',
    kind: 'user',
    description: 'Представляет текущего пользователя.',
    data: { name: 'John Doe' },
    schema: {
      type: 'object',
      properties: {
        name: { type: 'string' },
        age: { type: 'number' },
        city: { type: 'string' },
      },
    },
  },

  // Второе сообщение `user` объединится с первым
  {
    type: 'data',
    kind: 'user',
    data: { age: 30 },
  },
]);
```

:::
:::column{title="Что видит LLM"}

```typescript
[
  {
    role: 'user',
    content: {
      type: 'text',
      text: "Обновите город пользователя на Остин",
    },
  },
  {
    role: 'user',
    content: {
      type: 'text',
      text: `
        ## Data: ¶user
        {
          "name": "John Doe",
          "age": 30
        }
        Представляет текущего пользователя.
        Схема для ¶user:
        {
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "age": { "type": "number" },
            "city": { "type": "string" }
          }
        }`,
    },
  },
];
```

:::
::::
:::::

## Специализация сообщения с данными

Обобщенное сообщение с :term[Данными]{canonical="Data"} является основополагающим шаблоном. Оно специализируется для разных ролей другими частями системы, часто путем присвоения определенного `kind`.

- **:term[Входное сообщение]{canonical="Input Message"}:** :term[Входное сообщение]{canonical="Input Message"} — это сообщение с :term[Данными]{canonical="Data"}, имеющее `kind: 'input'`. Оно формально объявляет параметры, которые принимает :term[Запрос]{canonical="Request"}, превращая статический :term[Запрос]{canonical="Request"} в многократно используемый, подобный функции компонент.

  > Sidenote:
  > - [006: Агент/Ввод](./006_agent_input.md)

- **:term[Сообщение о состоянии]{canonical="State Message"}:** :term[Сообщение о состоянии]{canonical="State Message"} — это сообщение с :term[Данными]{canonical="Data"}, имеющее `kind: 'state'`. Оно представляет собой постоянную, развивающуюся память рабочего процесса. Его `schema` определяет структуру этой памяти, включая то, какие свойства доступны для чтения или записи.

  > Sidenote:
  > - [009: Агент/Состояние](./009_agent_state.md)

- **:term[Вывод]{canonical="Final Output"}:** Механизм `_outputPath` создает новые сообщения с :term[Данными]{canonical="Data"} для сохранения результатов :term[Вызовов инструментов]{canonical="Tool Call"}. Когда выполняется `Call` с `_outputPath`, его результат добавляется в контекст как новое сообщение с :term[Данными]{canonical="Data"} (часто с `kind: 'state'`), делая его доступным для последующих шагов.

  > Sidenote:
  > - [008: Агент/Вывод](./008_agent_output.md)

- **:term[Экземплирование]{canonical="Instancing"}:** Система :term[Экземплирования]{canonical="Instancing"} использует свойство `_instance` для различения сообщений с :term[Данными]{canonical="Data"}. Этот ключ ограничивает сообщение конкретным потоком выполнения в пакетной операции. Сообщения с :term[Данными]{canonical="Data"}, имеющие разные значения `_instance`, рассматриваются как имеющие разную идентичность и не будут объединяться, обеспечивая изоляцию данных.

  > Sidenote:
  > - [012: Агент/Экземплирование](./013_agent_instancing.md)

- **:term[Цикл]{canonical="Loop"}:** :term[Цикл выполнения]{canonical="Execution Loop"} полагается на сообщения с :term[Данными]{canonical="Data"} для поддержания непрерывности. В частности, :term[Сообщение о состоянии]{canonical="State Message"} является основным средством для сохранения информации между тактами :term[Цикла]{canonical="Loop"}.

  > Sidenote:
  > - [010: Агент/Цикл](./010_agent_loop.md)

- **:term[Переменные]{canonical="Variable"}:** Система :term[Переменных]{canonical="Variable"} является основным потребителем сообщений с :term[Данными]{canonical="Data"}. **:term[Ссылки на переменные]{canonical="Variable Reference"}** (`†<kind>.<path>`) используются внутри :term[Вызовов инструментов]{canonical="Call"} для динамического чтения значений из сообщений с :term[Данными]{canonical="Data"} в контексте, таких как :term[Входное сообщение]{canonical="Input Message"} или :term[Сообщение о состоянии]{canonical="State Message"}.

  > Sidenote:
  > - [007: Агент/Переменные](./007_agent_variables.md)

## От общих данных к конкретным ролям

Сообщение с :term[Данными]{canonical="Data"} предоставляет общий контейнер для структурированной информации. Однако, чтобы агент мог эффективно использовать эти :term[данные]{canonical="Data"}, ему необходимо понимать их роль в процессе. В следующих главах описывается, как это общее сообщение с :term[Данными]{canonical="Data"} специализируется для конкретных целей, например, для предоставления начальных параметров для рабочего процесса.

Следующий документ, :term[006: Агент/Ввод]{href="./006_agent_input.md"}, описывает, как сообщение `Data` используется для создания структурированного запроса для агента.
