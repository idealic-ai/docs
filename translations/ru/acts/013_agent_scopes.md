# 013: Агент/Области

> [!DEFINITION] [Области](./000_glossary.md)
> Механизм, который делает контролируемое подмножество контекста из родительской среды доступным для выполнения. Свойство `_scopes` действует как разрешающий список, определяя сфокусированное и безопасное представление данных, к которым может получить доступ `Call`.

> Sidenote: Требуется:
> - [002: Агент/Инструмент](./002_agent_tool.md)
> - [004: Агент/Вызов](./004_agent_call.md)

**Протокол Областей** — это фундаментальный механизм для управления контекстом, доступным для `Call`. В сложной агентной системе `Call` редко выполняется в вакууме; ему часто требуется доступ к информации из родительской среды, такой как ввод пользователя, текущее состояние или результаты предыдущих шагов. Протокол Областей предоставляет безопасный и явный способ контролировать этот поток информации.

Ограничивая контекст, области повышают безопасность, предотвращают случайную утечку данных и фокусируют LLM, что приводит к более предсказуемому и экономичному выполнению. Этот контролируемый контекст также является ключом к модульности, позволяя таким компонентам, как `Идеи` и `Действия`, быть по-настоящему автономными и многократно используемыми. Этот документ объясняет, как работает этот протокол и как он сочетается с другими возможностями агента.

## Предоставление и Запрос Контекста

Схема свойства `_scopes` определяет, является ли контекст статически **предоставляемым** или динамически **запрашиваемым** во время выполнения.

> Sidenote: 
> ```mermaid
> graph TD
>     subgraph Родительский Контекст
>         direction LR
>         input("input")
>         state("state")
>     end
> 
>     subgraph Вызов Инструмента
>         direction LR
>         filter{{"_scopes: ['input']"}}
>     end
> 
>     input --> filter
>     state -.-> filter
> 
>     subgraph Предоставленный Контекст
>         Execute(Выполнить Инструмент)
>     end
> 
>     filter --> HITL{{Одобрение человеком}}
>     HITL --> Execute
> 
>     classDef unused stroke-dasharray: 5, 5, stroke:#aaa, color:#aaa
>     class state unused
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```

- **Статические Области (Предоставление Контекста)**: Схема `_scopes` может быть значением `const`, что означает, что контекст **предоставляется**. Разработчик жёстко закодировал точный контекст, который разрешено видеть инструменту.

  ```json
  {
    "_scopes": {
      "const": ["input"]
    }
  }
  ```

- **Динамические Области (Запрос Контекста)**: Схема `_scopes` может быть более гибкой, позволяя контекст **запрашивать**. LLM решает, какие из доступных областей ей нужны для генерации `Call`.

  ```json
  {
    "_scopes": {
      "type": "array",
      "items": {
        "enum": ["state", "input"]
      }
    }
  }
  ```

  Этот динамический шаблон особенно эффективен в сочетании с системой подтверждения человеком (human-in-the-loop), обеспечивая критически важный уровень прозрачности и контроля.

## Роль Областей в Композиции Call

Свойство `_scopes` — это основной механизм для контроля контекста, доступного для `Call`. Оно действует как разрешающий список, фильтруя родительскую среду, чтобы обеспечить сфокусированное, ограниченное поле зрения для выполнения. Этот контролируемый контекст является основополагающим для обработки `Call`, и его роль адаптируется для поддержки композиционной модели выполнения, где могут сочетаться различные возможности, такие как явная логика, инстансинг и модульность.

- **Скрытое Исполнение**: В стандартном скрытом исполнении `_scopes` служат «подсказкой», чтобы сфокусировать внимание LLM на релевантных частях родительского контекста. Это скорее рекомендация, а не строгий фильтр, но она крайне важна для повышения надёжности и экономической эффективности рассуждений LLM за счёт уменьшения шума от нерелевантных данных.

  > Sidenote: См. [002: Агент/Инструмент](./002_agent_tool.md).

- **Явное Исполнение (`_activity`)**: Когда `Call` подкреплён детерминированным `Действием`, роль областей становится более прямой. Ограниченный областями контекст передаётся целиком в функцию `Действия` в качестве дополнительного параметра. Это даёт `Действию` полный доступ к необходимым контекстуальным данным, даже если эти данные не использовались LLM напрямую для генерации основных параметров `Call`.

  > Sidenote: См. [003: Агент/Действие](./003_agent_activity.md).

- **Инстансинг (`_instance`)**: В многоэкземплярном запросе, где агент обрабатывает пакет схожих объектов данных, области начинают учитывать экземпляры. Протокол гарантирует, что `Call`, нацеленный на конкретный экземпляр, получит контекст только для _этого_ экземпляра. Это критически важно для поддержания целостности данных и предотвращения «утечки» контекста между параллельными выполнениями.

  > Sidenote: См. [011: Агент/Инстансинг](./011_agent_instancing.md).

- **Модульная Изоляция (`_module`)**: Когда `Call` делегируется внешнему `Модулю`, области действуют как стражи контекста. Они определяют _весь_ контекст для изолированного выполнения модуля в «чистой комнате». Ничто из родительской среды недоступно модулю, если это явно не указано в областях, что обеспечивает настоящую инкапсуляцию и возможность повторного использования.

  > Sidenote: См. [012: Агент/Делегирование](./012_agent_delegate.md).

Свойство `_scopes` — это мост, который позволяет `Call` получать контекст. Как показывает этот последний шаблон, когда данный механизм используется для предоставления _всего_ контекста для изолированного выполнения, он активирует мощный **Протокол Делегирования**. Следующий документ, [012: Агент/Делегирование](./012_agent_delegate.md), подробно описывает этот протокол.