# 851: Пакет/Покерный Движок

> [!DEFINITION] [Покерный Движок](./000_glossary.md)
> Комплексная, независимая от игры программная система для управления жизненным циклом пошаговых игр. Она реализует архитектуру на основе протоколов (`State`, `Game`, `Command`), чтобы отделить игровую логику от представления состояния.

> Sidenote:
> - Интеграция:
>   - :term[850: Пакет/Игровой Сервис]{href="./850_package_game_service.md"}
> - Визуализация:
>   - :term[852: Пакет/Покерный UI]{href="./852_package_poker_ui.md"}

**Покерный Движок** (`@idealic/poker-engine`) — это набор инструментов для управления игрой в покер. Он создает абстрактную сущность, состоящую из специализированных утилит, которые обеспечивают создание, развитие и завершение игр. Хотя он ориентирован на покер, его архитектурные паттерны применимы к любой пошаговой игре.

## Надежность

Движок разработан с использованием строгого **подхода, основанного на спецификациях**, что гарантирует формальное определение каждого правила и механики. Он подкреплен примерно **3000 тестами**, охватывающими широкий спектр сценариев — от стандартной игры до сложных крайних случаев, таких как многосторонние побочные банки и разделенные банки, — что гарантирует высочайшую стабильность и корректность.

Кроме того:

- **Фаззинг-тестирование:** Полный жизненный цикл игры непрерывно проверяется с помощью фаззинг-тестирования на уровне интеграции с Игровым Сервисом, симулируя хаотичные условия реального мира.
- **Проверенное наследие:** Логика движка основана на системе, совместимой с **форматом рук PokerStars**, которая прошла стресс-тестирование на наборе данных из более чем **10 миллионов исторических игр**.

## Принципы Проектирования

Движок построен на шести основных инвариантах:

1.  **Неизменяемость:** Все изменения состояния создают новые объекты (глубокое копирование), обеспечивая сохранение истории.
2.  **Детерминизм:** Использование генератора случайных чисел с начальным значением (seed) гарантирует точное воспроизведение игр.
3.  **Сначала проверка:** Действия проверяются перед применением, чтобы предотвратить повреждение состояния.
4.  **Разделение ответственностей:** Четкие границы между данными (`State`), исполняющей средой (`Game`) и логикой (`Processors`).
5.  **На основе действий:** Система, основанная на событиях, где все изменения проходят через стандартизированные строки действий.
6.  **На основе протоколов:** Универсальные пространства имен создают согласованный слой API.

## Паттерн Абстракции Пространства Имен

Движок реализует дизайн на основе протоколов через четыре основных пространства имен, которые действуют как универсальные обертки.

### 1. Пространство Имен State (Функциональное Ядро)

**`Poker.State`** (ранее `Hand`) — это протокол универсальной нотации игры.

- **Универсальная нотация:** Представляет состояние ЛЮБОЙ пошаговой игры (покер, шахматы и т.д.) в виде последовательности действий.
- **Источник истины:** Содержит полную историю, необходимую для воссоздания игры.
- **Функциональное ядро:** Чистая, неизменяемая структура данных, изменяемая только через чистые функции-редьюсеры.
- **Перспективы:** Поддерживает `personalize()` для создания маскированных представлений для конкретных игроков (скрывая карманные карты).

### 2. Пространство Имен Game (Исполняющая Среда)

**`Poker.Game`** — это протокол состояния исполнения (императивная оболочка).

- **Живое состояние:** Преобразует статическую нотацию `State` в изменяемый, запрашиваемый объект времени выполнения.
- **Применение правил:** Обрабатывает все правила игры, проверку (`canApplyAction`) и развитие игры.
- **Швейцарский нож:** Предоставляет утилиты для управления временем, индексации игроков и анализа состояния.
- **Развитие игры:** Метод `applyAction(game, action)` является основным драйвером движка, изменяя состояние игры на основе введенных данных.

### 3. Пространство Имен Command (Интерфейс)

**`Poker.Command`** — это протокол генерации действий.

- **Слой трансляции:** Преобразует высокоуровневые намерения пользователя (клики в интерфейсе) в стандартизированные строки действий.
- **Осведомленность о состоянии:** Считывает текущее состояние `Game` для генерации корректных действий (например, вычисление правильной суммы для команды `allIn`).
- **Разделение:** Отделяет взаимодействия с пользовательским интерфейсом от основной обработки движка.

### 4. Пространство Имен Format (Сериализатор)

**`Poker.Format`** предоставляет специализированные утилиты для обработки данных.

- **Сериализация/Десериализация:** Эффективное кодирование и декодирование состояний игры и действий для передачи по сети или хранения.
- **Парсинг истории рук:** Преобразование необработанного текста истории рук в структурированные объекты `State`, совместимые с основными форматами, такими как PokerStars.

## Статистика и Аналитика

Движок включает специальное пространство имен **`Poker.Stats`** для глубокой аналитики.

- **Философия:** Различает **статистику** (сырые счетчики, отслеживаемые в реальном времени, например, `three_bet_attempts`) и **метрики** (производные вычисления, например, `three_bet_frequency`).
- **Отслеживание по позиции:** Отслеживает маневры с явным позиционным контекстом (в позиции/без позиции), например, `cbet_ip_attempts` против `cbet_oop_attempts`.
- **Агрегация:** Поддерживает агрегацию данных по игроку, улице торгов или месту проведения для отчетности.

## Архитектура Системы

### Ответственности Клиента и Сервера

Покерный Движок работает как на клиенте, так и на сервере.

- **На стороне клиента:** Обрабатывает оптимистичный рендеринг и позволяет пользователю выполнять действия на основе локального состояния.
- **На стороне сервера:** Выступает в качестве конечного авторитета для проверки действий, очистки данных игры и управления случайностью.

### Интеграция

- **Бэкенд:** **[@idealic/game-service](../game-service/README.md)** — Управляет сессиями, сохранением данных и сетевым взаимодействием.
- **Фронтенд:** **[@idealic/poker-ui](../poker-ui/README.md)** — Отображает состояние `Game`.

## Жизненный Цикл Игры

Покерный Движок работает как конвейер "запрос-ответ".

1.  **Присоединение и инициализация:** Игроки запрашивают присоединение; система находит/создает стол; ожидает 2+ активных игроков.
2.  **Создание игры:** Создается авторитетное `State` с защищенным начальным значением (seed); происходит начальная раздача; состояние сохраняется и рассылается.
3.  **Цикл действий игрока:** Клиент отправляет действие -> Движок обрабатывает -> Новое состояние сохраняется/очищается/рассылается.
4.  **Завершение и преемственность:** Раздача заканчивается; движок перемещает баттон, обрабатывает блайнды, готовит следующую раздачу.
5.  **Управление жизненным циклом игрока:** Запросы на выход/паузу/возобновление ставятся в очередь для следующей игры.
6.  **Состояние ожидания:** Приостанавливается, если активных игроков < 2.
7.  **Обработка тайм-аутов:** Периодические проверки применяют действия по умолчанию, чтобы игра продолжалась.

## Основные Возможности

- **Управление состоянием:** Детерминированная раздача, отслеживание сложных состояний ставок и управление побочными банками.
- **Применение правил:** Строгая проверка правил ставок, последовательности улиц торгов и логики вскрытия карт.
- **Управление игроками:** Отслеживает позиции (Баттон, МБ, ББ), стеки и историю действий.
- **Игровой процесс:**
  - **Крупье:** Координирует поток действий между дилером и игроком.
  - **Дилер:** Автономный агент, который обрабатывает автоматическое развитие игры (раздача карт, переход по улицам).
  - **Вскрытие карт (Showdown):** Быстрая оценка силы руки на основе таблиц поиска (`utils/hand-strength.ts`) для определения победителя.

## Формат Действий

Движок использует стандартизированный строковый формат для всех событий:

- **Игрок:** `'p1 f'` (Фолд), `'p2 cc 20'` (Колл 20), `'p3 cbr 100'` (Рейз до 100).
- **Дилер:** `'d dh p1 AsKs'` (Раздать карманные), `'d db AhKhQh'` (Раздать на борд).
- **Мета:** `'p4 m Hello!'` (Сообщение).

Этот человекочитаемый формат служит одновременно и для передачи данных через API, и как журнал аудита.
