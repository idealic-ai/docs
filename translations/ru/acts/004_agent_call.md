# 004: Агент/Вызов

> [!DEFINITION] [Вызов](./000_glossary.md)
> Конкретный, исполняемый экземпляр `Tool` со значениями для его `params`. Это запрос на исполнение, который определяет, что *должно быть сделано*.

- Требует:
  - [002: Агент/Инструмент](./002_agent_tool.md)
- Открывает возможности для:
  - [103: Концепция/Идеатор](./103_concept_ideator.md)
  - [013: Агент/Области](./013_agent_scopes.md)
  - [011: Агент/Инстансинг](./011_agent_instancing.md)
  - [202: Идея/Носитель](./202_idea_vessel.md)
  - [203: Идея/Процесс](./203_idea_process.md)
- Расширяется:
  - [012: Агент/Делегат](./012_agent_delegate.md)

Документ [002: Агент/Инструмент](./002_agent_tool.md) закладывает основу интерфейса на базе схем, который позволяет агентам понимать структурированные возможности. Этот документ описывает протокол **004: Агент/Вызов**, который, опираясь на Инструменты, определяет, как происходит исполнение.

**Вызов** — это конкретный экземпляр Инструмента с заданными значениями параметров, готовый к исполнению. Если Инструменты определяют, _что можно сделать_, то Вызовы определяют, _как это будет исполнено_.

> [!HEADSUP] Внимание
> [001: Агент/Запрос](./001_agent_request.md), результатом которого является набор `Вызовов`, представляет собой [202: Идея/Носитель](./202_idea_vessel.md). `Носитель` представляет собой единичный, реактивный момент принятия решения, когда агент выбирает из доступных `Инструментов` для формирования ответа.

## Композиция и Контекст

Сам по себе `Вызов` — это простая структура данных. Его сила — в композиции с другими протоколами, управляющими средой его исполнения. Эти протоколы активируются специальными мета-свойствами (с префиксом `_`) в схеме `Инструмента`, что позволяет одному объекту `Вызов` запускать различные варианты исполнения.

Придавая этим мета-свойствам ясное семантическое значение, мы делаем LLM активным участником композиции. Модель может анализировать различные комбинации этих свойств для создания сложных и новых цепочек исполнения, переходя от простого выбора инструментов к динамической оркестрации рабочих процессов.

> [!TIP]
> Следующий раздел объясняет связи с другими частями системы, которые будут подробно описаны позже. Не нужно забегать вперёд, мы всё рассмотрим в логической последовательности. Вы сможете вернуться к этому разделу позже

- **Явное исполнение (`_activity`)**: Самое базовое расширение — это связь `Вызова` с детерминированной функцией в коде. Свойство `_activity` указывает, что `Вызов` должен быть исполнен через **Действие** (Activity), а не через скрытое исполнение LLM.

  > Sidenote: Подробнее в [003: Агент/Действие](./003_agent_activity.md).

- **Делегированное исполнение (`_delegate`)**: `Вызов` может быть делегирован внешнему **Делегату**. Свойство `_delegate` обычно содержит ссылку на сохранённый [001: Агент/Запрос](./001_agent_request.md) (часто в виде пути к JSON-файлу), что позволяет вызывать этот запрос как многоразовый инструмент. Это обеспечивает изолированную «чистую комнату» для исполнения, предотвращая смешивание контекстов и обеспечивая настоящую инкапсуляцию.

  > Sidenote: Подробнее в [012: Агент/Делегат](./012_agent_delegate.md).

- **Передача контекста (`_scopes`)**: Протокол **Scopes** контролирует, какой контекст доступен `Вызову`. Его основное применение — сфокусировать внимание LLM во время скрытого исполнения, указав, какие части родительского контекста следует учитывать. Это предотвращает смешивание контекстов и ведет к более надежным результатам. При использовании с `_delegate` его роль становится еще более мощной: он строго определяет _весь_ контекст для изолированного исполнения делегата.

  > Sidenote: Подробнее в [013: Агент/Области](./013_agent_scopes.md).

- **Исполнение с состоянием (`_outputPath`)**: `Вызов` можно сделать отслеживающим состояние, указав ему, куда записывать результат. Свойство `_outputPath` определяет путь внутри постоянного **Объекта Состояния**, где должен храниться результат `Вызова`. Это позволяет создавать многошаговые рабочие процессы, где результат одного `Вызова` может быть использован как входные данные для другого.

  > Sidenote: Подробнее в [009: Агент/Состояние](./009_agent_state.md).

- **Экземплярное исполнение (`_instance`)**: `Вызов` может быть нацелен на конкретный **Экземпляр** в рамках запроса с несколькими экземплярами. Свойство `_instance` действует как уникальный идентификатор, фокусируя все операции этого `Вызова` (такие как чтение входных данных из **Объекта Состояния** и запись результатов в него) на определённом контексте. Это обеспечивает эффективную параллельную обработку нескольких состояний с использованием одного и того же набора инструментов.
  > Sidenote: Подробнее в [011: Агент/Инстансинг](./011_agent_instancing.md).

## Паттерны исполнения Вызовов

Когда агент генерирует несколько Вызовов, можно применять различные стратегии исполнения в зависимости от потребностей приложения:

```typescript
// Исполнение одного Вызова
const result = await Tool(call);

// Исполнить все Вызовы, дождаться всех результатов
const results = await Tool.all(calls);

// Исполнить все Вызовы, вернуть первый успешный результат
const result = await Tool.any(calls);

// Исполнить все Вызовы, вернуть первый завершённый результат (успешный или нет)
const result = await Tool.race(calls);
```

Эти паттерны позволяют:

- **Тонкое управление**: Обрабатывать Вызовы по отдельности с пользовательской логикой между исполнениями
- **Пакетная обработка**: Исполнять независимые Вызовы параллельно для максимальной производительности
- **Стратегии быстрого отказа**: Останавливаться при первом успехе (`.any()`) или первом завершении (`.race()`)
- **Операции «всё или ничего»**: Гарантировать, что все Вызовы успешно завершатся вместе (`.all()`), поддерживая согласованность, когда Вызовы логически сгруппированы

## Оркестрация Вызовов в цикле

Хотя эти паттерны управляют исполнением одной пачки `Вызовов`, агентам часто требуется выполнять многошаговые задачи, где результат одного `Вызова` влияет на следующий. Это решается с помощью протокола более высокого уровня, который организует последовательность `Запросов` и `Вызовов`.

Следующий документ, [005: Агент/Цикл](./005_agent_loop.md), подробно описывает этот цикл исполнения.