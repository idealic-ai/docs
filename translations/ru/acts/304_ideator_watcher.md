# 304: Идеатор/Наблюдатель

> **Наблюдатель:** :term[Идеатор]{canonical="Ideator"} с :term[состоянием]{canonical="State"}, который является «источником» и подписывается на изменения в сервисе :term[Хранилища]{canonical="Storage"}. Когда происходит изменение (например, сохраняется новая версия :term[Идеи]{canonical="Idea"}), он инициирует новую транзакцию, обычно вызывая :term[План]{canonical="Plan"} для обработки новых :term[данных]{canonical="Data"}.
>
> — [Глоссарий](./000_glossary.md)

> Sidenote:
> - Требуется:
>   - [301: Идеатор/Хранилище](./301_ideator_storage.md)
>   - [011: Агент/План](./011_agent_plan.md)

## 1. Введение

Этот документ определяет **Протокол Наблюдателя**, критически важный компонент для создания асинхронных, событийно-ориентированных рабочих процессов в экосистеме. :term[Наблюдатель]{canonical="Watcher"} (также называемый Подписчиком) — это постоянный сервис, который отслеживает изменения у провайдера :term[Хранилища]{canonical="Storage"} и в ответ запускает новые процессы.

Это основной механизм для преодоления разрыва между сервисами с :term[состоянием]{canonical="State"} и без него, а также для обработки длительных задач, которыми нельзя управлять в простом цикле запрос-ответ.

## 2. Наблюдатель как «источник» Идеатор

В отличие от сервиса :term[Хранилища]{canonical="Storage"}, который действует как транзакционный «приёмник», :term[Наблюдатель]{canonical="Watcher"} является «источником». Его роль не в том, чтобы завершить транзакцию, а в том, чтобы **начать новую**.

Типичный рабочий процесс выглядит так:

1.  :term[Идея]{canonical="Idea"} фиксируется в :term[Хранилище]{canonical="Storage"}, завершая исходную транзакцию.
2.  Сервис :term[Хранилища]{canonical="Storage"} генерирует событие, уведомляя подписчиков об изменении.
3.  :term[Наблюдатель]{canonical="Watcher"}, подписанный на эти события, получает уведомление.
4.  :term[Наблюдатель]{canonical="Watcher"} инициирует новую, независимую транзакцию. Обычно это включает вызов [011: Агент/План](./011_agent_plan.md) и передачу новой :term[Идеи]{canonical="Idea"} в качестве контекста, что запускает новый рабочий процесс.

## 3. Обработка асинхронности и длительных процессов

:term[Наблюдатель]{canonical="Watcher"} — это ключ к корректному управлению длительными асинхронными операциями.

Рассмотрим :term[План]{canonical="Plan"}, который включает шаг, на выполнение которого могут уйти часы или дни (например, ожидание ввода от человека, обработка большого набора :term[данных]{canonical="Data"}). Синхронный :term[План]{canonical="Plan"} не может просто `await` этот результат.

Вместо этого :term[План]{canonical="Plan"} может делегировать длительную задачу внешнему сервису и затем завершиться. Этот внешний сервис по завершении записывает свой результат обратно в :term[Хранилище]{canonical="Storage"}. :term[Наблюдатель]{canonical="Watcher"}, настроенный на прослушивание этого конкретного результата, может затем запустить _новый_ :term[План]{canonical="Plan"} для продолжения рабочего процесса.

Этот паттерн позволяет создавать высокоустойчивые и масштабируемые процессы, не ограниченные памятью или временем жизни какой-либо одной среды выполнения. Он обеспечивает настоящую асинхронность, разбивая длительный процесс на серию небольших транзакций, запускаемых событиями.