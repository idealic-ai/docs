# 011: Агент/Инстансинг

> [!DEFINITION] [Инстансинг](./000_glossary.md)
> Процесс обработки нескольких независимых `Instances` (каждый со своим `State Object` и уникальным идентификатором) в рамках одного запроса агента.

Требуется: [009: Агент/Состояние](./009_agent_state.md)
Совместимо:
  - [007: Агент/Ввод](./007_agent_input.md)
  - [013: Агент/Области](./013_agent_scopes.md)
  - [010: Агент/План](./010_agent_plan.md)

**Протокол Инстансинга** — это шаблон для масштабирования рабочих процессов агентов. Он позволяет запускать один и тот же многоразовый [План](./010_agent_plan.md) одновременно для множества независимых объектов `State`, что значительно повышает производительность и согласованность.

## Механизм Инстансинга

Инстансинг основан на протоколе **[009: Агент/Состояние](./009_agent_state.md)**. Вместо одного `State Object` запрос может содержать их массив, где каждый объект представляет отдельный `Instance` задачи.

Для управления этими параллельными контекстами каждому сообщению `State` присваивается **уникальный идентификатор** через специальное свойство `_instance`. Эти идентификаторы — короткие, уникальные токены (например, `①`, `②`), которые позволяют LLM связывать операции с конкретным `Instance`.

Такой подход дает значительные преимущества:

- **Эффективность**: Увеличивает пропускную способность системы, обрабатывая множество инстансов за один запрос к LLM.
- **Согласованность**: Позволяет LLM видеть несколько связанных инстансов в одном контексте, что способствует созданию более согласованных и качественных планов.

## Взаимодействие с сообщениями контекста

Сила протокола заключается в том, как идентификатор `_instance` определяет область действия для различных типов сообщений контекста.

- **State:** Сообщение `State` — основа протокола. Каждый `Instance` является отдельным `State Object`, однозначно идентифицируемым свойством `_instance`. Это создает изолированное пространство для последовательности операций, гарантируя, что параллельные рабочие процессы не будут мешать друг другу.

  > Sidenote: [009: Агент/Состояние](./009_agent_state.md)

- **Input:** Сообщение `Input` можно использовать двумя способами. Глобальное сообщение `Input` (без идентификатора `_instance`) предоставляет конфигурацию для всех инстансов в пакете. Целевое сообщение `Input` (с идентификатором `_instance`) предоставляет данные для конкретного `State Object`, переопределяя любые глобальные входные данные.

  > Sidenote: [007: Агент/Ввод](./007_agent_input.md)

- **Scopes:** Идентификатор `_instance` обеспечивает критически важную изоляцию данных для `Scopes`. Когда `Call` нацелен на конкретный инстанс, его `_scopes` также ограничиваются контекстом этого инстанса. Это позволяет `Delegate` видеть только те данные, которые относятся к его конкретной задаче, даже если он является частью более крупного запроса с множеством инстансов.

  > Sidenote: [013: Агент/Области](./013_agent_scopes.md)

## Взаимодействие с другими протоколами

Инстансинг интегрируется с протоколами более высокого уровня для управления потоком выполнения.

- **Calls:** Свойство `_instance` в `Call` — это основной механизм, который направляет его выполнение. Оно гарантирует, что все манипуляции с состоянием — будь то запись в `_outputPath` или чтение значения из состояния для использования в качестве входных данных — правильно привязаны к целевому `Instance`.

  > Sidenote: [004: Агент/Вызов](./004_agent_call.md)

- **Plan:** В то время как инстансинг предоставляет механизм для параллельного выполнения задач, `Plan` определяет последовательность этих задач. Один и тот же многоразовый `Plan` может применяться к каждому `Instance` в запросе, обеспечивая последовательное выполнение сложного многоступенчатого рабочего процесса для большого пакета данных.

  > Sidenote: [010: Агент/План](./010_agent_plan.md)

## От планирования к процессу

В то время как `Plan` предоставляет многоразовый шаблон для рабочего процесса, а `Инстансинг` — механизм для его масштабного выполнения, **[Идея Процесса](./203_idea_process.md)** является артефактом, который фиксирует результат. Это полная, самодостаточная запись стратегического плана и его текущего состояния выполнения по всем инстансам.