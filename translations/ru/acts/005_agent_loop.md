# 005: Агент/Цикл

> **Цикл:** последовательность `Request`ов, нацеленная на достижение цели. Агент продолжает вызывать `Request`ы, обрабатывать полученные `Call`ы и передавать результат обратно в контекст для следующего `Request`а, пока `Call`ы не перестанут генерироваться. — [Глоссарий](./000_glossary.md)

> Sidenote:
> - Требуется:
>   - [001: Агент/Запрос](./001_agent_request.md)
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

Этот документ описывает **цикл выполнения**, который позволяет агенту выполнять многошаговые задачи, итеративно создавая [001: Агент/Запрос](./001_agent_request.md). Этот итеративный процесс сборки контекста, использования инструментов и обратной связи — это то, что обычно подразумевают, говоря об «агенте».

## Цикл выполнения

> Sidenote:
> ```mermaid
> graph TD
>     Start((Старт)) --> ContextAssembly(1. Сборка контекста)
>     ContextAssembly --> RequestInvocation(2. Вызов Request)
>     RequestInvocation --> CallProcessing(3. Обработка Call)
>     CallProcessing --> HasCalls{Есть Call'ы?}
>     HasCalls -- Нет --> Termination((5. Завершение))
>     HasCalls -- Да --> HITL{Участие человека}
>     HITL -- Одобрено --> Execution(4. Выполнение и обратная связь)
>     Execution -- Результаты --> ContextAssembly
>     HITL -- Исправлено --> ContextAssembly
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```

Цикл выполнения — это основной механизм для автономного, многошагового выполнения. Он работает следующим образом:

1.  **Сборка контекста:** Цикл начинается со сборки исходного контекста, который может включать цель пользователя, текущее `State` и другую важную информацию.
2.  **Вызов Request:** Цикл вызывает [001: Агент/Запрос](./001_agent_request.md) с текущим контекстом и схемой доступных `Tools`.
3.  **Обработка Call:** `Request` возвращает `solution`, содержащий массив из нуля или более [004: Агент/Вызов](./004_agent_call.md). Важно отметить, что на этом этапе эти `Call`ы являются лишь предлагаемыми действиями; они ещё не выполнены.
4.  **Выполнение и обратная связь:**
    - Если `solution` содержит `Call`ы, цикл их выполняет. Для `Explicit` `Call`ов это включает вызов соответствующего кода `Activity`.
    - Результаты этих `Call`ов затем добавляются обратно в контекст для следующей итерации.
5.  **Завершение:** Если `solution` не содержит `Call`ов, агент считает, что его цель достигнута, и цикл завершается.

## Участие человека в цикле (HITL)

Ключевая особенность цикла выполнения — это естественная поддержка контроля со стороны человека. Поскольку цикл разделяет создание `Call`ов и их выполнение, у пользователя появляется возможность вмешаться:

- **Одобрение:** Перед выполнением `Call`ов система может представить их пользователю для одобрения. Движок выполнения можно настроить так, чтобы он требовал подтверждения (например, через callback-функцию), которое действует как точка останова, приостанавливая цикл до получения ввода от человека.
- **Корректировка:** Пользователь может изменить параметры `Call`а или даже заменить его на другой.

Важно отметить, что эти конкретные механизмы HITL не являются частью основного протокола. Архитектура просто обеспечивает необходимое разделение между предложением действий и их выполнением, давая разработчикам гибкость для реализации любого вида вмешательства — от простого ручного одобрения до сложной автоматизированной системы с таймаутами.

Эта возможность критически важна для безопасности и совместных задач, где агент выступает в роли помощника. Корректировки и обратная связь от пользователя могут использоваться в [012: Агент/План](./012_agent_plan.md), позволяя агенту улучшать свою стратегию на основе человеческого ввода.

## Роль данных в цикле

Цикл выполнения предоставляет динамическую структуру для поведения агента, но его мощь реализуется через данные, которые циркулируют внутри него. Состояние, входные и выходные данные, управляемые на каждом шаге, позволяют агенту поддерживать контекст, учиться и выполнять сложные, многошаговые планы.

Следующий документ, [006: Агент/Данные](./006_agent_data.md), рассматривает протоколы для управления этими данными.