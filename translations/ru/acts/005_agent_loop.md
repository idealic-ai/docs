# 005: Агент/Цикл

> [!DEFINITION] :term[Цикл]
> Последовательность :term[Запросов], направленная на достижение цели. Агент продолжает вызывать :term[Запросы], обрабатывать полученные :term[Вызовы] и передавать результат обратно в контекст следующего :term[Запроса] до тех пор, пока не перестанут генерироваться :term[Вызовы].

> Sidenote:
> - Требуется:
>   - :term[001: Агент/Запрос]{href="./001_agent_request.md"}
>   - :term[002: Агент/Инструмент]{href="./002_agent_tool.md"}
>   - :term[004: Агент/Вызов]{href="./004_agent_call.md"}

Этот документ описывает :term[Цикл выполнения], который позволяет агенту выполнять многошаговые задачи, итеративно создавая :term[Запросы]. Этот итеративный процесс сборки контекста, использования инструментов и обратной связи — это то, что обычно подразумевается под словом «агент».

## Цикл выполнения

> Sidenote:
> ```mermaid
> graph TD
>     Start((Старт)) --> SchemaComposition(1. Композиция схемы)
>     SchemaComposition --> ContextAssembly(2. Сборка контекста)
>     ContextAssembly --> RequestInvocation(3. Вызов Запроса)
>     RequestInvocation --> CallProcessing(4. Обработка Вызова)
>     CallProcessing --> HasCalls{Есть Вызовы?}
>     HasCalls -- Да --> HITL{Человек-в-цикле}
>     HITL -- Одобрено --> Execution(5. Выполнение и обратная связь)
>     Execution -- Результаты --> ContextAssembly
>     HITL -- Исправлено --> ContextAssembly
>     HasCalls -- Нет --> Termination(6. Завершение)
>     Termination --> OutputGeneration(7. Генерация вывода)
>     OutputGeneration --> End((Конец))
>     classDef optional stroke-dasharray: 5, 5
>     class HITL optional
> ```

Цикл выполнения — это основной механизм для автономного, многошагового исполнения. Он работает следующим образом:

1.  **Композиция схемы:** Цикл настраивается с помощью определённой пользователем _схемы вывода_ для конечного результата. Она автоматически объединяется со схемами доступных :term[Инструментов] для создания единой схемы :term[Запроса], как описано в разделе :term[Композиция схемы Инструмента]{href="./002_agent_tool.md#composing-schemas-for-the-llm"}.
2.  **Сборка контекста:** Цикл начинается со сборки начального контекста, который может включать цель пользователя и другую релевантную информацию.
3.  **Вызов Запроса:** Цикл вызывает :term[Запрос] с текущим контекстом и составленной на предыдущем шаге схемой.
4.  **Обработка Вызова:** :term[Запрос] возвращает объект :term[Решение], содержащий массив из нуля или более :term[Вызовов] в свойстве `calls`. Важно, что на этом этапе :term[Вызовы] — это только предлагаемые действия; они ещё не выполнены.
5.  **Выполнение и обратная связь:**
    - Если массив `calls` объекта :term[Решение] не пуст, цикл их выполняет. Для :term[Явных вызовов] это включает вызов соответствующего кода :term[Действия].
    - Результаты этих :term[Вызовов] затем добавляются обратно в контекст для следующей итерации.
6.  **Завершение:** Если массив `calls` объекта :term[Решение] пуст, агент решил, что его цель достигнута, и цикл завершается.
7.  **Генерация вывода:** По завершении поле `output` объекта :term[Решение] содержит конечный результат, соответствующий определённой пользователем схеме вывода. Этот механизм позволяет агенту не только выполнять действия, но и создавать структурированный итоговый ответ. Содержимое `output` может быть преобразованием или обобщением контекста, накопленного во время цикла. Например, агент, которому поручен анализ данных, может выполнить несколько шагов обработки (каждый — это :term[Вызов]), а затем использовать поле `output` для возврата итогового отчёта в формате JSON.

## :term[Человек-в-цикле] (:term[HITL])

Ключевая особенность :term[Цикла выполнения] — это естественная поддержка человеческого контроля. Поскольку цикл разделяет генерацию :term[Вызовов] и их выполнение, у пользователя появляется возможность вмешаться:

- **Одобрение:** Перед выполнением :term[Вызовов] система может представить их пользователю для утверждения. Механизм выполнения можно настроить на шаг подтверждения (например, через callback-функцию), который будет работать как точка останова, приостанавливая цикл до получения ввода от человека.
- **Исправление:** Пользователь может изменить параметры :term[Вызова] или даже заменить его другим.

Важно отметить, что эти конкретные механизмы :term[HITL] не являются частью основного протокола. Архитектура просто обеспечивает необходимое разделение между предложением действий и их выполнением, давая разработчикам гибкость для реализации любого вида вмешательства — от простого ручного одобрения до сложной автоматизированной системы с тайм-аутами.

Эта возможность имеет решающее значение для безопасности и для совместных задач, где агент выступает в роли ассистента. Корректировки и обратная связь от пользователя могут быть использованы :term[Планом], что позволяет агенту уточнять свою стратегию на основе человеческого ввода.

Эта возможность имеет решающее значение для безопасности и для совместных задач, где агент выступает в роли ассистента. Корректировки и обратная связь от пользователя могут быть использованы :term[Планом], что позволяет агенту уточнять свою стратегию на основе человеческого ввода.

## Роль данных в цикле

:term[Цикл выполнения] предоставляет динамическую структуру для поведения агента, но его сила заключается в потоке данных внутри него. Это управляется :term[типом сообщения Данные], который рассматривается в :term[006: Агент/Данные]{href="./006_agent_data.md"}.
