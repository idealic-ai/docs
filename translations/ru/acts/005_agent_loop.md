# 005: Агент/Цикл

> **Цикл:** Последовательность `Request`-ов, направленная на достижение цели. Агент продолжает вызывать `Request`-ы, обрабатывать полученные `Call`-ы и передавать результат обратно в контекст следующего `Request`-а до тех пор, пока `Call`-ы не перестанут генерироваться. — [Глоссарий](./000_glossary.md)

> Sidenote: Требуется:
> - [001: Агент/Запрос](./001_agent_request.md)
> - [002: Агент/Инструмент](./002_agent_tool.md)
> - [004: Агент/Вызов](./004_agent_call.md)

Этот документ описывает **цикл исполнения**, который позволяет агенту выполнять многоэтапные задачи, итеративно создавая [001: Агент/Запрос](./001_agent_request.md). Этот итеративный процесс сборки контекста, использования инструментов и обратной связи — это то, что обычно подразумевается под «агентом».

## Цикл исполнения

> Sidenote: 
> ```mermaid
graph TD
    Start((Start)) --> ContextAssembly(1. Context Assembly)
    ContextAssembly --> RequestInvocation(2. Request Invocation)
    RequestInvocation --> CallProcessing(3. Call Processing)
    CallProcessing --> HasCalls{Has Calls?}
    HasCalls -- No --> Termination((5. Termination))
    HasCalls -- Yes --> HITL{Human-in-the-Loop}
    HITL -- Approved --> Execution(4. Execution & Feedback)
    Execution -- Results --> ContextAssembly
    HITL -- Corrected --> ContextAssembly
    classDef optional stroke-dasharray: 5, 5
    class HITL optional
```

Цикл исполнения — это основной механизм для автономного, многоэтапного выполнения. Он работает следующим образом:

1.  **Сборка контекста:** Цикл начинается со сборки начального контекста, который может включать цель пользователя, текущее `State` и другую релевантную информацию.
2.  **Вызов Запроса:** Цикл вызывает [001: Агент/Запрос](./001_agent_request.md) с текущим контекстом и схемой доступных `Tools`.
3.  **Обработка вызовов:** `Request` возвращает `solution`, содержащее массив из нуля или более [004: Агент/Вызов](./004_agent_call.md). Важно, что на этом этапе эти `Call`-ы являются лишь предложенными действиями; они еще не выполнены.
4.  **Исполнение и обратная связь:**
    - Если `solution` содержит `Call`-ы, цикл их исполняет. Для `Explicit` `Call`-ов это включает вызов соответствующего кода `Activity`.
    - Результаты этих `Call`-ов затем добавляются обратно в контекст для следующей итерации.
5.  **Завершение:** Если `solution` не содержит `Call`-ов, агент считает свою цель достигнутой, и цикл завершается.

## Участие человека в цикле (Human-in-the-Loop, HITL)

Ключевая особенность цикла исполнения — это его естественная поддержка надзора со стороны человека. Поскольку цикл разделяет генерацию `Call`-ов и их исполнение, это создает возможность для вмешательства пользователя:

- **Подтверждение:** Перед исполнением `Call`-ов система может представить их пользователю для подтверждения. Движок исполнения можно настроить с шагом подтверждения (например, функцией обратного вызова), который действует как точка останова, приостанавливая цикл до получения ввода от человека.
- **Коррекция:** Пользователь может изменять параметры `Call` или даже заменять его другим.

Важно отметить, что эти конкретные механизмы HITL не являются частью основного протокола. Архитектура просто обеспечивает необходимое разделение между предложением действий и их исполнением, предоставляя разработчикам гибкость для реализации любого вида вмешательства, от простого ручного подтверждения до сложной автоматизированной системы с тайм-аутами.

Эта возможность критически важна для безопасности и совместных задач, где агент выступает в роли ассистента. Корректировки и обратная связь от пользователя могут использоваться в [012: Агент/План](./012_agent_plan.md), позволяя агенту уточнять свою стратегию на основе человеческого ввода.

## Роль данных в цикле

Цикл исполнения обеспечивает динамическую структуру для поведения агента, но его мощь реализуется через данные, которые циркулируют внутри него. Состояние, вводы и выводы, управляемые на каждом цикле, — это то, что позволяет агенту поддерживать контекст, учиться и выполнять сложные, многоэтапные планы.

Следующий документ, [006: Агент/Данные](./006_agent_data.md), рассматривает протоколы для управления этими данными.