# 51: Запрос/Эволюционный Черновик

> [!DEFINITION] Эволюционный Черновик
> Временный артефакт для быстрого согласования изменений, исправления недопонимания и предоставления контекста перед обновлением основного документа.
>
> Sidenote:
> - См.: :term[02: Компания/Процесс]{href="./02_process.md"} для определения процесса.

## Цель

Эволюционный Черновик устраняет разрыв между обсуждением (в Pull Request-ах) и живой спецификацией. Он фиксирует изменившееся понимание или новое намерение, которое возникает в ходе ревью.

## Протокол для Агента

Когда пользователь запрашивает Эволюционный Черновик, вы **ОБЯЗАНЫ** получить ссылку на Pull Request и временной период.

### 1. Проверка предварительных условий

1.  **Ссылка на PR:** Если не предоставлена, **ОСТАНОВИТЕСЬ** и спросите:

    > "Пожалуйста, предоставьте ссылку на Pull Request в GitHub, который вы хотите проанализировать."

2.  **Дата "начиная с":** Если пользователь не указал дату, **ОСТАНОВИТЕСЬ** и спросите:
    > "Пожалуйста, укажите дату в формате ГГГГ-ММ-ДД, чтобы отфильтровать комментарии. Если вы хотите проанализировать всю историю, ответьте 'All'."

### 2. Получение данных

**ОГРАНИЧЕНИЕ:** Вам разрешено делать ТОЛЬКО следующие внешние запросы:

1.  **HTTP GET** на `https://idealic.academy/en/company/02_process.md/`
2.  **HTTP GET** на `https://idealic.academy/en/company/50_truth.md/`
3.  Вызов **API комментариев GitHub** (с помощью однострочной команды ниже)

**НЕ** загружайте содержимое других файлов, коммиты или дифы по отдельности.

**Шаг 1: Загрузка обязательных документов**
Вы **ОБЯЗАНЫ** использовать HTTP-инструмент для получения контента напрямую по указанным ниже URL. **Не ищите в вебе.** Загружайте именно эти URL.

- [02: Компания/Процесс](https://idealic.academy/en/company/02_process.md/)
- [50: Запрос/Истина](https://idealic.academy/en/company/00_truth.md/)

**Шаг 2: Получение комментариев (одной строкой)**
Выполните именно эту команду. Замените `{PR_NUMBER}` (например, 123) и `{SINCE_DATE}` (например, 2025-01-01). ВАЖНО: Необходимо получить все комментарии за один раз, что делает `per_page=200`. Не пытайтесь разделять эти вызовы.

**ОЧЕНЬ ВАЖНО**: Это ключевой шаг. Он группирует комментарии по тредам, учитывает дифы в первом комментарии треда и получает 200 комментариев за раз. Не пытайтесь изменять эту команду, так как это приведет к неверным результатам.

```bash
gh api "repos/{OWNER}/{REPO}/pulls/{PR_NUMBER}/comments?since={SINCE_DATE}&per_page=200" --paginate --jq 'map({id, body, user: .user.login, created_at, html_url, diff_hunk, in_reply_to_id}) | group_by(.in_reply_to_id // .id) | map(sort_by(.created_at) | .[0] as $root | [$root] + (.[1:] | map(del(.diff_hunk))))' | jq '.' > "comments_{SINCE_DATE}.json"
```

### 3. Анализ и Синтез (Язык: Русский)

**Ограничение:** Итоговый документ должен быть на **русском языке**. (Исключения: разговорные выражения вроде "yeah", "ok" или технические термины).

**Метод: Интеллектуальный синтез ("Магия LLM")**
Это **НЕ** программное преобразование JSON в Markdown. Вы должны применить интеллект для создания краткого и правдивого резюме:

- **Перефразируйте и сокращайте:** Сжимайте комментарии до сути, сохраняя смысл. Избегайте копирования больших блоков текста.
- **Фильтруйте шум:** Исключайте комментарии, которые не добавляют ценности или контекста к намерению.
- **Отбирайте контекст:** Включайте только те строки дифов, которые относятся к обсуждаемому вопросу.
- **Цель:** Создать компактный, точный и правдивый документ.

Анализируйте JSON. Ваша цель — **полнота**. Каждый отдельный тред или тема обсуждения должны быть представлены.

**Для каждого пункта определите:**

1.  **Намерение:** В чем основная цель?
2.  **Обоснование:** _Почему_ происходит это изменение? В чем основная причина или смысл? Синтезируйте это из обсуждения, чтобы предоставить контекст для LLM.
3.  **Действие:** Что нужно изменить?
4.  **Влияние на видение:** Изменилось ли долгосрочное видение?
5.  **Статус согласования:** Согласовано? Есть недопонимание?
    - Если автор **не ответил**, пометьте как: "Требует подтверждения".
6.  **Контекст:** Доказательства (цитаты).

### 4. Валидация

**КРИТИЧЕСКИЙ ШАГ:** Перед завершением работы над документом вы должны выполнить самопроверку:

1.  Прочтите сгенерированный список пунктов.
2.  Сравните его с файлом `comments_{DATE}.json`.
3.  **Сопоставьте каждый комментарий:** Убедитесь, что ID каждого комментария (особенно корневых комментариев тредов) связан с конкретным номером Намерения.
4.  **Проверка согласованности:** Убедитесь, что каждый номер Намерения, упомянутый в таблице валидации, соответствует реальному разделу в тексте.
    - **Исправление:** Если вы найдете "призрачную ссылку" (номер Намерения в таблице, которого нет в тексте), вы **ОБЯЗАНЫ** вернуться и сгенерировать недостающий раздел Намерения. Не просто удаляйте ссылку, а добавьте контент.
5.  **Вопрос:** "Не упустил(а) ли я _какой-нибудь_ тред?"
6.  Если да, немедленно добавьте его.

### 5. Генерация документа

Создайте новый файл (например, `evolution_{DATE}.md`).

**Обязательная структура:**

```markdown
# Эволюционный Черновик: {DATE}

> Статус: Черновик
> Источник: {PR_LINK}

## Обзор

{Высокоуровневый синтез цикла ревью на русском языке. Ответьте на следующее:}

1.  **Чего хотел ревьюер:** {Основные темы обратной связи/критики}
2.  **С чем согласился автор:** {Ключевые уступки или стратегические изменения}
3.  **Общий контекст:** {Устраненные недопонимания или подтвержденные изменения в видении}
4.  **Недопонимания (если есть):** {Список конкретных пунктов, вызвавших путаницу}
5.  **Открытые вопросы (если есть):** {Обсужденные, но не решенные вопросы}
6.  **Новые открытия:** {Идеи, полученные в ходе обсуждения}
7.  **Связанные документы:** {Ссылки на упомянутые связанные документы}

## Список Намерений

<!-- Повторить для КАЖДОЙ отдельной темы/треда, найденного в JSON -->

### {N}. {Краткое название на русском}

- **Намерение:** {Чего мы хотим достичь?}
- **Обоснование:** {Объяснение, _почему_ это изменение необходимо, обобщающее аргументы из комментариев}
- **Действие:** {Конкретные шаги, которые нужно предпринять.}
- **Статус:** {Согласовано / Недопонимание / Требует уточнения / Изменение видения / Требует подтверждения}
- **Прежнее понимание (если применимо):** {Краткое описание предыдущего понимания/видения, если оно изменилось}
- **Результат:** {Кратко: Изменилось ли видение? Достигнуто ли согласие? Устранено ли недопонимание?}
- **Контекст:**
  > [{Имя ревьюера}]({Ссылка}): "{Кратко перефразированное замечание}"
  >
  > [{Имя автора}]({Ссылка}): "{Кратко перефразированное решение}" (или "Нет ответа")
  >
  > _Контекст дифа:_ `{1-2 строки максимум, только при необходимости}`

---

## Отчет о валидации

| ID Комментария | Заголовок (Резюме) | № Намерения | Статус          |
| ------------- | --------------- | -------- | --------------- |
| [{ID}]({URL}) | {3-6 слов}     | {N}      | Включено        |
| [{ID}]({URL}) | {3-6 слов}     | -        | Пропущено (Шум) |
```
