# 51: Запрос/Черновик Эволюции

> [!DEFINITION] Черновик Эволюции
> Временный артефакт для быстрого реагирования, используемый для согласования изменений, исправления недопониманий и предоставления контекста для выполнения перед обновлением Основного Документа.
>
> Sidenote:
>
> - См.: :term[02: Компания/Процесс]{href="./02_process.md" canonical="02: Company/Process"} для определения процесса.

## Цель

Черновик Эволюции устраняет разрыв между обсуждением (:term[Pull Requests]{canonical="Pull Requests"}) и постоянной спецификацией (Живой Спецификацией). Он фиксирует "изменившееся понимание" или "новое намерение", которые появляются в ходе ревью.

## Протокол для Агента

Когда пользователь запрашивает Черновик Эволюции, вы **ОБЯЗАНЫ** получить ссылку на :term[Pull Request]{canonical="Pull Request"} и временной диапазон.

### 1. Проверка предварительных условий

1.  **Ссылка на PR:** Если не предоставлена, **ОСТАНОВИТЕСЬ** и спросите:

    > "Пожалуйста, предоставьте ссылку на GitHub Pull Request, который вы хотите проанализировать."

2.  **Дата 'since':** Если пользователь не указал дату, **ОСТАНОВИТЕСЬ** и спросите:
    > "Пожалуйста, укажите дату 'since' (ГГГГ-ММ-ДД) для фильтрации комментариев. Если вы хотите проанализировать всю историю, ответьте 'All'."

### 2. Получение данных

**ОГРАНИЧЕНИЕ:** Вам разрешено делать ТОЛЬКО следующие внешние :term[запросы]{canonical="Request"}:

1.  **HTTP GET** на `https://idealic.academy/en/company/02_process.md/`
2.  **HTTP GET** на `https://idealic.academy/en/company/50_prompt_truth.md/`
3.  Вызов **GitHub Comments API** (с помощью однострочной команды ниже)

**НЕ** извлекайте содержимое других файлов, коммиты или дифы по отдельности.

**Шаг 1: Получение обязательных документов**
Вы **ОБЯЗАНЫ** использовать HTTP-инструмент для получения содержимого напрямую по указанным ниже URL. **НЕ ищите в вебе.** Получайте данные по конкретным URL.

- [:term[02: Компания/Процесс]{canonical="02: Company/Process"}](https://idealic.academy/en/company/02_process.md/)
- [:term[50: Запрос/Истина]{canonical="50: Prompt/Truth"}](https://idealic.academy/en/company/50_prompt_truth.md/)

**Шаг 2: Получение комментариев (одной командой)**
Выполните в точности эту команду. Замените `{PR_NUMBER}` (например, 123) и `{SINCE_DATE}` (например, 2025-01-01). ПРИМЕЧАНИЕ: Важно получить все комментарии за один раз, `per_page=200` это обеспечивает. Не пытайтесь разделять эти вызовы.

**СУПЕР ВАЖНО**: Это очень важный шаг, он группирует комментарии по тредам, учитывает `diff hunks` в первом комментарии треда и получает 200 комментариев за раз. Не пытайтесь изменять эту команду, так как это приведет к неверным результатам.

```bash
gh api "repos/{OWNER}/{REPO}/pulls/{PR_NUMBER}/comments?since={SINCE_DATE}&per_page=200" --paginate --jq 'map({id, body, user: .user.login, created_at, html_url, diff_hunk, in_reply_to_id}) | group_by(.in_reply_to_id // .id) | map(sort_by(.created_at) | .[0] as $root | [$root] + (.[1:] | map(del(.diff_hunk))))' | jq '.' > "comments_{SINCE_DATE}.json"
```

### 3. Анализ и синтез (Язык: русский)

**Требование:** Прочитайте и следуйте стандартам, определенным в:

- :term[02: Компания/Процесс]{href="https://idealic.academy/en/company/02_process.md/" canonical="02: Company/Process"} (Понимание роли Документов Эволюции)
- :term[50: Запрос/Истина]{href="https://idealic.academy/en/company/50_prompt_truth.md/" canonical="50: Prompt/Truth"} (Стандарты написания: утвердительность, точность, без "воды")

**Ограничение:** Выходной документ должен быть на **русском языке**. (Исключения: разговорные выражения типа "yeah", "ok" или технические термины).

**Метод: Интеллектуальный синтез ("Магия LLM")**
Это **НЕ** программное преобразование JSON в Markdown. Вы должны применить интеллект для создания компактного и правдивого резюме:

- **Перефразируйте и сократите:** Сжимайте комментарии до их сути, сохраняя смысл. Избегайте копирования больших блоков.
- **Фильтруйте шум:** Опускайте комментарии, которые не добавляют ценности или контекста к намерению.
- **Цель:** Создать компактный, точный и правдивый документ.

Проанализируйте JSON. Ваша цель — **Полнота**. Каждый отдельный тред или тема обсуждения должны быть представлены.

**Для каждого пункта определите:**

1.  **:term[Намерение]{canonical="Intent"}:** В чем заключается основное желание?
2.  **Обоснование:** _Почему_ происходит это изменение? В чем основная причина или смысл? Синтезируйте это из обсуждения, чтобы предоставить контекст для LLM.
3.  **:term[Действие]{canonical="Action"}:** Что нужно изменить?
4.  **Влияние на видение:** Изменилось ли долгосрочное видение?
5.  **Статус согласования:** Согласовано? Есть ли недопонимание?
    - Если автор **не ответил**, пометьте как: "Требует подтверждения".
6.  **Контекст:** Доказательство (цитаты) и/или конкретное место в коде (если применимо).

### 4. Валидация

**КРИТИЧЕСКИ ВАЖНЫЙ ШАГ:** Перед завершением работы над документом вы должны выполнить самопроверку:

1.  Прочитайте сгенерированный список пунктов.
2.  Сравните его с `comments_{DATE}.json`.
3.  **Сопоставьте каждый комментарий:** Убедитесь, что каждый ID комментария (особенно корневых комментариев тредов) сопоставлен с конкретным номером Намерения.
4.  **Проверка консистентности:** Убедитесь, что каждый номер Намерения, упомянутый в таблице валидации, соответствует реальному разделу в тексте.
    - **Исправление:** Если вы найдете "фантомную ссылку" (номер Намерения в таблице, которого нет в тексте), вы **ОБЯЗАНЫ** вернуться и сгенерировать этот недостающий раздел Намерения. Не просто удаляйте ссылку, а добавьте содержимое.
5.  **Вопрос:** "Я пропустил _какой-нибудь_ тред?"
6.  Если да, немедленно добавьте его.

### 5. Генерация документа

Создайте новый файл (например, `evolution_{DATE}.md`).

**Обязательная структура:**

````markdown
# Черновик Эволюции: {DATE}

> Статус: Черновик
> Источник: {PR_LINK}

## Обзор

{Общий синтез цикла ревью на русском языке. Ответьте на следующие вопросы:}

1.  **Чего хотел ревьюер:** {Основные темы обратной связи/критики}
2.  **С чем согласился автор:** {Ключевые уступки или стратегические сдвиги}
3.  **Общий контекст:** {Устраненные недопонимания или подтвержденные изменения в видении}
4.  **Недопонимания (если есть):** {Список конкретных моментов, вызвавших путаницу}
5.  **Открытые вопросы (если есть):** {Обсужденные, но не решенные вопросы}
6.  **Новые открытия:** {Инсайты, полученные в ходе обсуждения}
7.  **Связанные документы:** {Ссылки на упомянутые связанные документы}

## Список Намерений

<!-- Повторить для КАЖДОЙ отдельной темы/треда из JSON -->

### {N}. {Короткий заголовок на русском}

- **Намерение:** {Чего мы хотим достичь?}
- **Обоснование:** {Объяснение, _почему_ это изменение необходимо, синтезируя аргументацию из комментариев}
- **Действие:** {Конкретные шаги, которые нужно предпринять.}
- **Статус:** {Согласовано / Недопонимание / Требует уточнения / Изменение видения / Требует подтверждения}
- **Прежнее понимание (если применимо):** {Краткое описание предыдущего понимания/видения, если оно изменилось}
- **Результат:** {Кратко: Изменилось ли видение? Достигнуто ли соглашение? Устранено ли недопонимание?}
- **Контекст:**

  > [{Имя ревьюера}]({Ссылка}): "{Кратко перефразированная проблема}"
  >
  > [{Имя автора}]({Ссылка}): "{Кратко переформулированное решение}" (или "Без ответа")

  ```{lang}
  {не более 1-3 строк кода из diff hunk}
  {Используйте многоточие ... для длинных строк (>80 символов)}
  {Общий размер блока < 240 символов}
  ```

---

## Отчет о валидации

| ID комментария | Заголовок (кратко) | № Намерения | Статус         |
| -------------- | ------------------ | ----------- | -------------- |
| [{ID}]({URL})  | {3-6 слов}         | {N}         | Включен        |
| [{ID}]({URL})  | {3-6 слов}         | -           | Пропущен (Шум) |
````
