# 005: Агент/Цикл

> **Цикл:** Это когда агент выполняет одну задачу за другой, как бы идя по кругу, чтобы достичь большой цели. Он делает `Запрос`, получает в ответ `Вызовы` (команды), выполняет их и использует результат для следующего `Запроса`. И так до тех пор, пока команды не закончатся. — [Глоссарий](./000_glossary.md)

> Sidenote:
>
> - Требуется:
>   - [001: Агент/Запрос](./001_agent_request.md)
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

Этот документ рассказывает о **протоколе Цикла**. Он похож на план действий для агента, который позволяет ему выполнять сложные задачи, состоящие из множества шагов.

## Цикл выполнения

> Sidenote:
>
> ```mermaid
graph TD
    Start((Старт)) --> AssembleContext(Собрать информацию)
    AssembleContext --> InvokeRequest(Сделать запрос)
    InvokeRequest --> HasCalls{В решении есть команды?}
    HasCalls -- Нет --> Stop((Конец))
    HasCalls -- Да --> HITL{Контроль человеком}
    HITL -- Одобрено --> ExecuteCalls(Выполнить команды)
    ExecuteCalls -- Результаты --> AssembleContext
    HITL -- Исправлено --> AssembleContext
    classDef optional stroke-dasharray: 5, 5
    class HITL optional
> ```

Цикл агента — это главный способ, которым он работает самостоятельно, шаг за шагом. Вот как это происходит:

1.  **Сбор информации:** Вначале цикл собирает всё, что нужно для работы: цель, которую поставил человек, что уже было сделано (`Состояние`) и другие полезные данные. Представь, что ты собираешь все нужные детали Lego, прежде чем начать строить.
2.  **Отправка запроса:** Используя всю собранную информацию, агент делает **[Запрос](./001_agent_request.md)**. Это как спросить у очень умного помощника: «Вот что у нас есть и вот что мы можем делать (`Инструменты`). Какой следующий шаг?»
3.  **Обработка команд:** В ответ на `Запрос` приходит `решение`, в котором есть список **[Вызовов](./004_agent_call.md)**. `Вызов` — это просто команда, которую нужно выполнить. Команд может быть несколько или не быть совсем.
4.  **Выполнение и обратная связь:**
    - Если в `решении` есть `Вызовы`, цикл их выполняет. Например, запускает нужную программу.
    - Результаты выполнения этих команд (что получилось в итоге) добавляются к общей информации для следующего круга цикла. Так агент учится на том, что сделал.
5.  **Завершение:** Если в `решении` нет ни одного `Вызова`, агент считает, что он достиг цели или сделал всё, что мог. Цикл останавливается.

## Человек-в-деле (контроль человеком)

Одна из самых важных особенностей Цикла — это возможность человеку присматривать за работой агента. Поскольку агент сначала придумывает, что делать (`Вызовы`), а только потом выполняет это, у нас появляется шанс вмешаться.

- **Одобрение:** Перед тем как выполнить команды, система может показать их тебе и спросить: «Всё правильно? Продолжаем?»
- **Исправление:** Ты можешь изменить что-то в команде или даже заменить её на совсем другую, если считаешь, что так будет лучше.

Это очень важно для безопасности и для совместной работы, когда агент выступает в роли твоего помощника. Агент может даже учиться на твоих исправлениях (об этом говорится в документе **[012: Агент/План](./012_agent_plan.md)**), чтобы в следующий раз действовать умнее.