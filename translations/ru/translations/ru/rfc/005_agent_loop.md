# 005: Агент/Цикл

> **Цикл:** Это последовательность `Запросов` для достижения цели. Агент повторяет шаги: вызывает `Запросы`, обрабатывает `Вызовы` и добавляет результат в контекст для следующего шага. Цикл заканчивается, когда `Вызовы` больше не создаются. — [Глоссарий](./000_glossary.md)

> Sidenote:
> 
> - Требуется:
>   - [001: Агент/Запрос](./001_agent_request.md)
>   - [002: Агент/Инструмент](./002_agent_tool.md)
>   - [004: Агент/Вызов](./004_agent_call.md)

Этот документ описывает **Протокол Цикла**, который помогает агенту выполнять задачи в несколько шагов. Для этого он снова и снова вызывает протокол `Запроса`.

## Цикл Выполнения

> Sidenote:
> 
> ```mermaid
graph TD
    Start((Start)) --> AssembleContext(Assemble Context)
    AssembleContext --> InvokeRequest(Invoke Request)
    InvokeRequest --> HasCalls{Solution has Calls?}
    HasCalls -- No --> Stop((End))
    HasCalls -- Yes --> HITL{Human-in-the-Loop}
    HITL -- Approved --> ExecuteCalls(Execute Calls)
    ExecuteCalls -- Results --> AssembleContext
    HITL -- Corrected --> AssembleContext
    classDef optional stroke-dasharray: 5, 5
    class HITL optional
> ```

Цикл Агента — это главный способ, которым он самостоятельно выполняет задачи в несколько шагов. Вот как это работает:

1.  **Сборка Контекста:** Сначала цикл собирает исходный контекст. Он может включать цель пользователя, текущее `Состояние` и другую важную информацию.
2.  **Вызов Запроса:** Затем он вызывает протокол **[001: Агент/Запрос](./001_agent_request.md)**, передавая ему текущий контекст и доступные `Инструменты`.
3.  **Обработка Вызова:** В ответ на `Запрос` приходит `решение`. Оно содержит список **[004: Агент/Вызов](./004_agent_call.md)ов** (или ни одного).
4.  **Выполнение и Обратная Связь:**
    - Если в `решении` есть `Вызовы`, цикл их выполняет. Если `Вызов` `Явный` (`Explicit`), запускается код соответствующего `Действия`.
    - Результаты выполненных `Вызовов` добавляются обратно в контекст для следующего шага цикла.
5.  **Завершение:** Если в `решении` нет `Вызовов`, агент считает задачу выполненной, и цикл останавливается.

## Человек-в-Цикле (Human-in-the-Loop, HITL)

Главная особенность Цикла Агента — встроенная возможность контроля со стороны человека. Цикл сначала создает `Вызовы`, а только потом их выполняет. Этот перерыв позволяет пользователю вмешаться:

- **Одобрение:** Перед тем, как выполнить `Вызовы`, система может показать их пользователю, чтобы он их одобрил.
- **Коррекция:** Пользователь может поправить параметры `Вызова` или полностью заменить его другим.

Эта функция очень важна для безопасности и для задач, где агент помогает человеку. Замечания и исправления от пользователя могут использоваться в **[012: Агент/План](./012_agent_plan.md)**. Это помогает агенту корректировать свой план действий, основываясь на подсказках человека.