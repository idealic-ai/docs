# 004: Агент/Вызов

> **Вызов:** — это конкретная, готовая к запуску версия `Инструмента` с заданными параметрами (`params`). Это команда на выполнение, говорящая, _что нужно сделать_.
> 
> — [Глоссарий](./000_glossary.md)

> Sidenote:
> 
> - Требует:
>   - [103: Концепция/Идеатор](./103_concept_ideator.md)
> - Позволяет:
>   - [008: Агент/Импорты](./008_agent_imports.md)
>   - [011: Агент/Инстансинг](./011_agent_instancing.md)
>   - [202: Идея/Контейнер](./202_idea_vessel.md)
>   - [203: Идея/Процесс](./203_idea_process.md)

[101: Концепция/Идея](./101_concept_idea.md) описывает мощную и самодостаточную структуру, которая хранит знания и логику работы. [002: Агент/Инструмент](./002_agent_tool.md) устанавливает простой интерфейс на основе схемы, который помогает агентам понять, какие действия они могут выполнять. Этот документ описывает протокол **004: Агент/Вызов**. Он, опираясь на Инструменты, объясняет, как происходит выполнение с помощью настроек Области (Scope) и Метода (Method).

**Вызов** — это Инструмент, у которого уже заданы все нужные параметры, и он готов к выполнению. Если Инструменты определяют, _что можно сделать_, то Вызовы определяют, _как именно это сделать_.

## Процесс от Идеи к Вызову

1.  **Идея**: Самодостаточное описание знания или процесса, нацеленное на результат.
2.  **Инструмент**: Это `Идея`, превращённая в схему-интерфейс. Агент регистрирует её в своей системе и может использовать для работы (подробнее о схемах, регистрации и системе см. в [002: Агент/Инструмент](./002_agent_tool.md)).
3.  **Вызов**: Когда языковая модель (LLM) решает использовать `Инструмент`, она подставляет в него конкретные значения. Так получается **Вызов** — готовая к запуску команда.

Основной принцип: **любую Идею можно превратить в Инструмент, который затем исполняется как Вызов.**

Подробное объяснение того, как входная схема `Идеи` преобразуется в схему параметров `Инструмента`, смотрите в **[007: Агент/Ввод](./007_agent_input.md)**.

## Элементы управления исполнением: Область и Метод

Как будет выполнен `Вызов`, определяют два независимых параметра: **Область** (где он выполняется) и **Метод** (как он выполняется). Эти параметры задаются специальными свойствами (`_module`, `_activity`, `_output`) в схеме Инструмента.

### Две оси исполнения

1.  **Область (Встроенная vs. Модульная)**
    Область определяет, где будет выполняться код: внутри самого агента или в отдельном, внешнем модуле.
    - **Встроенная область**: Режим по умолчанию. `Вызов` обрабатывается напрямую в текущем окружении.
    - **Модульная область**: Задаётся свойством `_module`. `Вызов` передаётся для выполнения внешнему `Действию` или `Идее`.

2.  **Метод (Явный vs. Скрытый)**
    Метод определяет, как будет получен результат: с помощью заранее написанного кода или через языковую модель (LLM).
    - **Явный метод**: Задаётся свойством `_activity`. Результат `Вызова` генерируется заранее написанным кодом, работающим по чёткому алгоритму.
    - **Скрытый метод**: Поведение по умолчанию, если `_activity` отсутствует. Результат `Вызова` генерируется языковой моделью. Для этого может понадобиться свойство `_output`.

Эти параметры можно сочетать, чтобы создавать разные сценарии работы, а их контекст — контролировать через импорты. Подробнее о том, как их комбинировать и управлять контекстом, читайте в **[008: Агент/Импорты](./008_agent_imports.md)**.

## Реализация сложных рабочих процессов

`Вызов` — это базовый элемент, из которого можно строить более сложные и упорядоченные процессы. В протоколе COILS это механизм, который запускает `Идеи` более высокого уровня, такие как **[202: Идея/Контейнер](./202_idea_vessel.md)** и **[203: Идея/Процесс](./203_idea_process.md)**. Например, `Контейнер` (`Vessel`) — это описание одного момента принятия решения. Он содержит в себе весь запрос к агенту (включая дополнительный `context` и `schema` со списком доступных `Инструментов`) и его ответ — `решение` (`solution`), в котором может быть несколько `Вызовов` для исполнения.

> Sidenote:
> 
> - [202: Идея/Контейнер](./202_idea_vessel.md)
> - [203: Идея/Процесс](./203_idea_process.md)

## Паттерны исполнения Вызовов

Когда агент создаёт несколько Вызовов, можно использовать разные стратегии их выполнения в зависимости от задачи:

```typescript
// Исполнение одного Вызова
const result = await Tool(call);

// Исполнить все Вызовы, дождаться всех результатов
const results = await Tool.all(calls);

// Исполнить все Вызовы, вернуть первый успешный результат
const result = await Tool.any(calls);

// Исполнить все Вызовы, вернуть первый завершённый (успешно или нет)
const result = await Tool.race(calls);
```

Эти паттерны позволяют:

- **Точное управление**: Обрабатывать Вызовы по одному, добавляя между ними свою логику.
- **Пакетная обработка**: Запускать независимые Вызовы одновременно, чтобы ускорить работу.
- **Стратегии быстрого ответа**: Останавливаться, как только получен первый успешный результат (`.any()`) или как только завершился любой из Вызовов (`.race()`)
- **Операции "всё или ничего"**: Гарантировать, что все связанные друг с другом Вызовы выполнятся успешно (`.all()`), чтобы сохранить целостность данных.