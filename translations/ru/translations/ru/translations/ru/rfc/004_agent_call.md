# 004: Агент/Вызов

> **Вызов:** это конкретный, готовый к запуску экземпляр `Tool` с заданными параметрами (`params`). Это запрос, сосредоточенный на выполнении конкретной задачи: _что нужно сделать_.
>
> — [Глоссарий](./000_glossary.md)

> Sidenote:
>
> - Требует:
>   - [103: Концепция/Идеатор](./103_concept_ideator.md)
> - Открывает возможности для:
>   - [008: Агент/Импорты](./008_agent_imports.md)
>   - [011: Агент/Инстансинг](./011_agent_instancing.md)
>   - [202: Идея/Контейнер](./202_idea_vessel.md)
>   - [203: Идея/Процесс](./203_idea_process.md)

Документ [101: Концепция/Идея](./101_concept_idea.md) описывает гибкую структуру для представления знаний и внутренней логики. В [002: Агент/Инструмент](./002_agent_tool.md) мы представили интерфейс на основе схем, который помогает агентам понимать свои возможности. Этот документ посвящён протоколу **004: Агент/Вызов**. Он основан на Инструментах (Tools) и определяет, как именно происходит их выполнение с помощью параметров Scope и Method.

**Вызов** — это конкретный экземпляр Инструмента (Tool) с заданными параметрами, готовый к выполнению. Если Инструменты определяют, _что можно сделать_, то Вызовы определяют, _как именно это будет сделано_.

## Процесс от Idea до Вызова

1.  **Idea**: Самостоятельный документ, нацеленный на результат и описывающий знание или процесс.
2.  **Tool**: `Idea`, преобразованная в интерфейсную схему и зарегистрированная в системе инструментов агента (подробнее о схемах Инструментов, регистрации и архитектуре двойного реестра читайте в [002: Агент/Инструмент](./002_agent_tool.md)).
3.  **Вызов**: Когда LLM решает использовать `Tool`, она задаёт его параметры, создавая **Вызов**. `Вызов` — это единичный, конкретный экземпляр `Tool`, готовый к выполнению.

Основной принцип: **любую Idea можно превратить в Tool, который затем можно выполнить как Вызов.**

Подробнее о том, как входная схема `Idea` преобразуется в схему параметров `Tool`, читайте в **[007: Агент/Ввод](./007_agent_input.md)**.

## Управление Выполнением: Scope и Method

Выполнение `Вызова` определяется двумя независимыми параметрами: **Scope** (где он выполняется) и **Method** (как он выполняется). Эти параметры задаются специальными свойствами (`_module`, `_activity`, `_output`) в схеме инструмента.

### Два аспекта выполнения

1.  **Scope (Встроенный или Модульный)**
    Scope определяет место выполнения: внутри текущего агента или во внешнем, отдельном модуле.
    - **Встроенный Scope**: Режим по умолчанию. `Вызов` выполняется напрямую в текущем контексте.
    - **Модульный Scope**: Обозначается через `_module`. `Вызов` передаётся на выполнение внешнему `Действию` или `Idea`.

2.  **Method (Явный или Скрытый)**
    Method определяет способ получения результата: с помощью заранее написанного кода (детерминированно) или с помощью LLM.
    - **Явный Method**: Обозначается свойством `_activity`. Результат `Вызова` создаётся заранее написанным кодом.
    - **Скрытый Method**: Режим по умолчанию (когда `_activity` не указан). Результат `Вызова` генерируется LLM и может использовать необязательное свойство `_output`.

Эти параметры можно комбинировать в различные паттерны выполнения, а их контекст контролировать через импорты. Подробнее о том, как эти параметры сочетаются и как управляется контекст, читайте в **[008: Агент/Импорты](./008_agent_imports.md)**.

## Создание Сложных Процессов

`Вызов` — это основной строительный блок для создания более сложных, структурированных процессов. В протоколе COILS этот механизм запускает `Ideas` высокого уровня, например **[202: Идея/Контейнер](./202_idea_vessel.md)** и **[203: Идея/Процесс](./203_idea_process.md)**. Например, `Контейнер` (`Vessel`) — это один акт принятия решения. Он содержит полный запрос к агенту (включая `context` и `schema` с доступными `Инструментами`) и ответ агента в виде `решения` (`solution`). Это решение содержит список `Вызовов` для выполнения (список может быть и пустым).

> Sidenote:
>
> - [202: Идея/Контейнер](./202_idea_vessel.md)
> - [203: Идея/Процесс](./203_idea_process.md)

## Паттерны Выполнения Вызовов

Когда агент генерирует несколько Вызовов, можно применять различные стратегии их выполнения в зависимости от задачи:

```typescript
// Выполнить один Вызов
const result = await Tool(call);

// Выполнить все Вызовы и дождаться всех результатов
const results = await Tool.all(calls);

// Выполнить все Вызовы и вернуть первый успешный результат
const result = await Tool.any(calls);

// Выполнить все Вызовы и вернуть первый завершившийся результат (успешный или нет)
const result = await Tool.race(calls);
```

Эти паттерны обеспечивают:

- **Точное управление**: Позволяет обрабатывать вызовы по одному, добавляя свою логику между шагами.
- **Пакетная обработка**: Позволяет выполнять независимые вызовы одновременно для большей скорости.
- **Стратегии быстрого ответа**: Позволяет остановиться после первого же успеха (`.any()`) или первого результата (`.race()`).
- **Операции «всё или ничего»**: Гарантирует, что все вызовы в группе выполнятся успешно (`.all()`), сохраняя целостность данных.