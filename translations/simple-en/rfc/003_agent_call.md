# 004: Агент/Вызов

> **Вызов:** Это как заполненный бланк заказа на `Инструмент`. Если `Инструмент` — это пустая форма, то `Вызов` — это конкретная команда с заполненными полями, готовая к исполнению. Это запрос на то, что _должно быть сделано_.
>
> — [Глоссарий](./000_glossary.md)

> Sidenote:
>
> - Требуется: [Протокол: Идеаторы](./103_concept_ideator.md)
> - Позволяет: [Протокол Импортов](./006_agent_imports.md), [Протокол Инстансинга](./008_agent_instancing.md)

[Протокол Идей](./101_concept_idea.md) — это наш способ хранить знания и скрытую логику в виде отдельных «мыслей». [Система Инструментов](./002_agent_tool.md) — это набор правил, который помогает агентам понимать свои возможности. В этом документе мы описываем **Протокол Вызовов**, который, опираясь на Инструменты, объясняет, как именно происходит выполнение действий с помощью контроля Области и Метода.

> Sidenote:
>
> - Требуется
>   - [Нормативный Акт 1: Инструмент](/)
> - Позволяет
>   - [Нормативный Акт 9: План](/)

**Вызов** — это готовый к исполнению экземпляр Инструмента с конкретными параметрами. Если Инструменты описывают, _что можно сделать_, то Вызовы определяют, _как именно это будет сделано_.

## Процесс: от Идеи к Вызову

1.  **Идея**: Это законченная мысль или результат. Представьте себе готовый рисунок или записанный рецепт.
2.  **Инструмент**: Это превращение Идеи в шаблон или трафарет. Например, мы превращаем готовый рецепт в пустую карточку для заполнения. (Подробнее об этом в [Системе Инструментов](./002_agent_tool.md)).
3.  **Вызов**: Это когда ИИ решает использовать `Инструмент`. Он заполняет пустые поля в шаблоне конкретными значениями и создает **Вызов**. Это и есть сам акт *использования* `Инструмента`.

Главный принцип: **любую Идею можно превратить в Инструмент, который затем можно использовать через Вызов.**

Подробное объяснение того, как входная схема `Идеи` превращается в схему параметров `Инструмента`, можно найти в **[Протоколе Ввода](./007_agent_input.md)**.

## Рычаги управления: Область и Метод

Выполнение `Вызова` определяется двумя независимыми свойствами: **Областью** (где он выполняется) и **Методом** (как он выполняется). Эти настройки задаются специальными свойствами в схеме инструмента (`_module`, `_activity`, `_output`).

### Две оси выполнения

1.  **Область (Встроенная vs. Модульная)**
    Определяет, где будет выполнено действие: внутри текущего процесса или где-то вовне.
    - **Встроенная Область**: Это как готовить на своей кухне. Действие выполняется прямо здесь и сейчас. Это режим по умолчанию.
    - **Модульная Область**: Это как заказать еду из ресторана. `Вызов` отправляется на выполнение в другое место — внешнему помощнику (`Activity`) или другой `Идее`. Сигналом для этого служит свойство `_module`.

2.  **Метод (Явный vs. Скрытый)**
    Определяет, как будет получен результат: по чётким инструкциям или с помощью творчества ИИ.
    - **Явный Метод**: Это как готовить по строгому рецепту. Результат предсказуем, потому что он создается обычным кодом. Сигналом служит свойство `_activity`.
    - **Скрытый Метод**: Это как попросить шеф-повара (ИИ) придумать что-то новое. Результат создается творчески, а не по шагам. Это поведение по умолчанию, если `_activity` отсутствует. Требует наличия свойства `_output`, чтобы ИИ знал, какого вида результат от него ждут.

Эти «рычаги» можно комбинировать для создания разных сценариев выполнения. Подробнее о том, как это работает, читайте в **[Протоколе Импортов](./008_agent_imports.md)**.

## Идея, Инструмент и Вызов: Разный фокус внимания

Чтобы понять, как они связаны, давайте посмотрим, на чём сфокусирован каждый из них.

- **Идея** — **фокус на результате**. Это готовый продукт, например, испеченный торт. Она описывает то, что _уже было_ или _могло бы быть_ сделано.

- **Инструмент** — **фокус на интерфейсе**. Это шаблон или рецепт торта с пустыми полями для ингредиентов. Он описывает, что _можно_ сделать.

- **Вызов** — **фокус на действии**. Это сам процесс выпечки торта с конкретными ингредиентами. Это команда, которая говорит, что _нужно сделать_ прямо сейчас.

## Идея-Контейнер: Момент принятия решения

Когда агенту нужно принять решение, мы упаковываем весь запрос к ИИ в специальный тип `Идеи`, который мы называем **Идея-Контейнер**. Она представляет собой один-единственный, самодостаточный момент принятия решения.

Идея-Контейнер собирает вместе два ключевых компонента, необходимых ИИ для выбора:

1.  **Контекст**: Вся важная информация. Что спросил пользователь? Какова предыстория?
2.  **Схема**: Это «меню» доступных `Инструментов`, которые агент может использовать в данный момент.

ИИ обрабатывает всю эту `Идею` — и контекст, и «меню» инструментов — и его `решение` (**solution**) — это список из нуля или более `Вызовов`, которые нужно выполнить.

Такая структура позволяет одной `Идее` описать сложное, многошаговое действие.

## Сценарии выполнения Вызовов

Когда Идея-Контейнер создает несколько Вызовов, мы можем выполнять их по-разному, в зависимости от задачи:

```typescript
// Выполнить один Вызов
const result = await Tool(call);

// Выполнить все Вызовы и дождаться всех результатов
const results = await Tool.all(calls);

// Выполнить все Вызовы, вернуть первый успешный результат
const result = await Tool.any(calls);

// Выполнить все Вызовы, вернуть самый первый результат (неважно, успешный или нет)
const result = await Tool.race(calls);
```

Эти сценарии позволяют нам:

- **Точно контролировать процесс**: Выполнять Вызовы по одному, с паузами для размышлений
- **Работать в пакете**: Выполнять независимые Вызовы одновременно для максимальной скорости
- **Быстро получать результат**: Остановиться после первого же успеха (`.any()`) или просто взять самый быстрый ответ (`.race()`)
- **Делать всё или ничего**: Гарантировать, что группа Вызовов либо выполнится вся целиком, либо не выполнится вовсе (`.all()`), что важно для связанных операций