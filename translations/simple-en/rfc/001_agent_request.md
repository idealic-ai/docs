# 001: Агент/Запрос

> **Запрос:** Это одна, полностью самостоятельная команда для умного ИИ (LLM). Вы даёте ему информацию для размышления (`context`), правила, как должен выглядеть ответ (`schema`), и он выдаёт вам результат (`solution`). — [Глоссарий](./000_glossary.md)

> Sidenote: NPM: [https://www.npmjs.com/package/@augceo/agent](@idealic-ai/agent)

Этот документ объясняет **Протокол Запроса** — основной способ общения с умным ИИ. `Запрос` — это как мотор, который берёт абстрактную **[101: Концепцию/Идею](./101_concept_idea.md)** и делает её понятной для компьютера, используя информацию (`context`) и правила (`schema`), чтобы создать результат (`solution`).

## Конвейер Запроса

`Запрос` — это не просто вопрос. Это как сборочный конвейер, который берёт много разной информации (`context`), обрабатывает её по шагам и превращает в один, правильно оформленный ответ от ИИ.

### 1. Контекст: Массив Сообщений

В основе каждого `Запроса` лежит его `context`, который выглядит как список `Сообщений`. Представьте это как сценарий пьесы, где записаны все реплики. Так можно показать ИИ целый разговор с разными участниками, чтобы он понял всю историю.

Простой контекст может выглядеть так:

```json
[
  { "role": "system", "content": "Ты — полезный ассистент." },
  { "role": "user", "content": "Какая столица у Франции?" }
]
```

### 2. Пользовательские Типы Содержимого

Система делает сообщения ещё умнее, позволяя использовать **пользовательские типы содержимого**. Вместо простого текста, `content` сообщения может быть специальным объектом, например, `{ "type": "state", "state": { ... } }`. Это как бы коробочка с ярлыком, где хранится определённая информация.

Этими типами управляет система `Content` (см. `agent/src/Content/Content.ts`). У каждого типа есть свой «обработчик», и все они выстраиваются в конвейер. Когда сообщение проходит по этому конвейеру, его обработчик может изменить три главные части `Запроса`:

- **Настройки ИИ (LLM Config)**: Изменение таких параметров, как модель, «температура» (креативность) или другие опции.
- **Схема (Schema)**: Изменение JSON-схемы, то есть правил, по которым должен быть построен финальный ответ.
- **Контекст (Context)**: Изменение итогового списка сообщений, который увидит ИИ. Например, можно превратить специальный тип данных в обычный текст или добавить новые сообщения.

Этот мощный механизм конвейера позволяет агенту работать со сложными, структурированными идеями и на лету создавать идеальную команду для ИИ, чтобы выполнить нужную задачу.

### 3. Схема: Направляя Решение

`Схема` — это как чертёж, который задаёт точную структуру для желаемого `решения`. Функция `Запроса` проверяет, что умеет конкретный ИИ, и выбирает лучший способ заставить его следовать этому чертежу:

1.  **Родной режим JSON-схемы**: Если ИИ это поддерживает (как новые модели OpenAI), схема передаётся ему напрямую. Это самый надёжный способ.
2.  **Запасной вариант через вызов инструментов**: Если ИИ не понимает схемы, но умеет пользоваться инструментами, мы «оборачиваем» схему в инструмент с названием `generate_response` и просим модель вызвать его.
3.  **Режим JSON с добавлением в промпт**: В крайнем случае, если ИИ может выдавать только общий JSON, мы просто вставляем описание схемы прямо в текст системного сообщения и просим его следовать этим инструкциям.

### 4. Выполнение и Решение

После всей подготовки итоговый список сообщений и выбранный способ контроля схемы упаковываются в один запрос и отправляются к ИИ. ИИ генерирует ответ, который точно соответствует схеме.

Система разбирает этот ответ — неважно, пришёл ли он как обычный текст или как результат вызова инструмента — и превращает его в структурированный объект. Этот объект и есть `решение`.

Весь этот конвейер — от обработки сложного контекста до получения проверенного по схеме решения — и позволяет **Идее** быть фундаментальным, вычислимым элементом в нашей системе.