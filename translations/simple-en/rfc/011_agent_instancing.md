# 011: Агент/Инстансинг

> **Инстансинг:** Это как если бы повар готовил несколько разных блюд одновременно. У каждого блюда есть свой рецепт и своё место на кухне (`Объект Состояния`), и повар следит за всеми сразу, не путая их. — [Глоссарий](./000_glossary.md)

> Sidenote:
>
> - Требуется: [010: Агент/Состояние](./010_agent_state.md)
> - Совместимо с:
>   - [007: Агент/Ввод](./007_agent_input.md)
>   - [008: Агент/Импорты](./008_agent_imports.md)
>   - [012: Агент/План](./012_agent_plan.md)

Этот документ объясняет, как научить искусственный интеллект (ИИ) выполнять много независимых задач за один раз, используя специальную систему состояний.

## 1. Главное требование: Система Состояний

Чтобы всё это заработало, нам нужна **Система Состояний**. Представь, что это разделение между «придумать, что делать» и «начать делать». Сначала ты составляешь план, а потом выполняешь его шаг за шагом.

**Объект Состояния** — это что-то вроде рабочего стола для каждой отдельной задачи. Это цифровой блокнот, который делает две важные вещи:

1.  **Место для результатов**: Это холст, на котором инструменты ИИ «рисуют». Каждое действие инструмента (`Tool Call`) знает, куда именно в этот блокнот записать результат. Например, в строчку с названием `_outputPath`.
2.  **Источник данных**: Инструмент может взять информацию из одной части блокнота, чтобы использовать её в другой. Например, взять текст из одной строчки, чтобы проанализировать его и записать результат в другую. Так можно выстраивать целые цепочки действий.

## 2. Как работает Инстансинг

Настоящая магия этой системы в том, как она справляется с множеством задач одновременно.

### 2.1. Метки для задач

Чтобы ИИ мог обработать сразу несколько задач, мы даём ему пачку «рабочих столов» (контекстных сообщений). Каждому такому столу мы прикрепляем уникальный значок-стикер, например `①` или `②`, с помощью специального свойства `_instance`.

Эти значки — просто метки. Они помогают ИИ не путать задачи между собой, как если бы ты наклеил стикеры с именами на разные тетради.

### 2.2. Точечные операции

Этот значок `_instance` используется, чтобы каждое действие было направлено на правильный «рабочий стол».

- **Связь с действием**: Каждое действие (`Tool Call`) в плане ИИ содержит значок `_instance`, чтобы знать, к какой задаче оно относится.
- **Автоматическая сортировка**: Когда ИИ видит значок на действии, он автоматически понимает, что все пути (куда записать результат `_outputPath` или откуда взять данные) относятся именно к этому рабочему столу. Ему не нужно каждый раз напоминать: «Запиши это в тетрадь `①`». Он просто видит значок `①` и знает, что работать нужно только с этой тетрадью.

Благодаря этому сами инструменты остаются очень простыми. Им не нужно знать, что они работают с одной из многих задач. Значки-стикеры делают всю работу по разделению за них.

### 2.3. Пример

Представь, что мы дали ИИ два текста, чтобы он определил их настроение (хорошее или плохое). Мы можем даже дать ему «шаблон» для его блокнота, чтобы он знал, какие поля там должны быть.

```json
{
  "context": [
    {
      // Это первая задача, помеченная значком ①.
      "_instance": "①",
      "type": "state",
      "state": { "text": "Это просто чудесно!" },
      // Это шаблон: должен быть текст, а потом появится настроение.
      "schema": {
        "type": "object",
        "properties": {
          "text": { "type": "string" },
          "sentiment": { "type": "string" }
        },
        "required": ["text"]
      }
    },
    {
      // А это вторая задача, помеченная значком ②.
      "_instance": "②",
      "type": "state",
      "state": { "text": "Это просто ужасно." }
    }
  ]
}
```

ИИ видит обе задачи сразу и составляет один общий план для них:

```json
{
  "calls": [
    {
      // 1. Используй инструмент "analyzeSentiment" для задачи ①.
      "_tool": "analyzeSentiment",
      "_instance": "①",
      // Возьми текст из её блокнота.
      "text": "†state.text",
      // Результат запиши в поле "sentiment".
      "_outputPath": "sentiment"
    },
    {
      // 2. Сделай то же самое для задачи ②.
      "_tool": "analyzeSentiment",
      "_instance": "②",
      "text": "†state.text",
      "_outputPath": "sentiment"
    }
  ]
}
```

После этого система выполняет этот план, и результаты записываются в блокнот каждой задачи.

## 3. Дополнительная система: Граф Планирования

**Система Планирования** — это как лучший друг для Инстансинга. Она помогает создавать очень предсказуемые и многоразовые инструкции.

**План** — это как рецепт или инструкция для сборки. Он описывает все шаги и в каком порядке их выполнять. Этот рецепт можно составить и проверить *заранее*, до того как начнётся основная «готовка».

Когда рецепт готов, его можно передать ИИ. Теперь, когда ИИ получит много задач, он не будет придумывать план на ходу, а просто будет следовать этому готовому рецепту для каждой задачи. Это гарантирует, что результат для всех будет одинаково хорошим и предсказуемым.

## 4. Плюсы такого подхода

Эта система даёт огромные преимущества:

- **Скорость и экономия**: ИИ обрабатывает много задач за один раз. Это как если бы ты делал домашку по математике сразу для всего класса — это намного быстрее и дешевле, чем делать для каждого по отдельности.
- **Качество и постоянство**: Когда ИИ видит несколько похожих задач одновременно, он замечает общие черты. Это помогает ему составить более умный и качественный план, который хорошо сработает для всех.
- **Предсказуемость**: Если использовать готовый **План** (рецепт), то можно быть уверенным, что результат будет всегда одинаковым. Никаких неприятных сюрпризов — каждая задача будет выполнена точно так, как задумано, раз за разом.