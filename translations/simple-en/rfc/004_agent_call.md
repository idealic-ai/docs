# 004: Агент/Запрос

> **Запрос:** Конкретный, готовый к выполнению экземпляр `Инструмента` с заданными значениями для его `параметров`. Это сфокусированный на выполнении приказ о том, *что должно быть сделано*. — [Глоссарий](./000_glossary.md)

> Sidenote:
>
> - Требует: [103: Концепция/Идеатор](./103_concept_ideator.md)
> - Открывает возможности для: [008: Агент/Импорты](./008_agent_imports.md), [011: Агент/Инстансинг](./011_agent_instancing.md)

Документ [101: Концепция/Идея](./101_concept_idea.md) описывает `Идею` как мощную, самодостаточную структуру для хранения знаний и скрытой логики. А [002: Агент/Инструмент](./002_agent_tool.md) объясняет, как на её основе создать интерфейс, который агенты могут понять. Этот документ описывает **Протокол Запроса**, который строится на `Инструментах` и определяет, как именно происходит выполнение с помощью управления Областью (Scope) и Методом (Method).

**Запрос** — это как бы оживший `Инструмент`, которому дали конкретные параметры и сказали «действуй!». Если `Инструменты` определяют, *что можно сделать*, то Запросы определяют, *как это будет выполнено*.

## Путь от Идеи к Запросу

Представь себе конвейер:

1.  **Идея**: Это как рецепт. Самодостаточный документ, который описывает готовый результат — например, шоколадный торт.
2.  **Инструмент**: Это как бланк заказа в кондитерской, сделанный на основе рецепта. Он превращает рецепт в список вопросов: «Какой размер торта?», «Нужна ли посыпка?». (Подробнее об этом в [002: Агент/Инструмент](./002_agent_tool.md)).
3.  **Запрос**: Это когда ИИ (в нашем случае — большая языковая модель, LLM) решает использовать `Инструмент`, он заполняет этот бланк заказа. Например: «Торт среднего размера, с посыпкой». Это и есть **Запрос** — одна конкретная, готовая к исполнению команда.

Главный принцип: **любую Идею можно превратить в Инструмент, который затем можно вызвать как Запрос.**

Чтобы детально понять, как вопросы из `Идеи` превращаются в параметры `Инструмента`, загляни в **[007: Агент/Ввод](./007_agent_input.md)**.

## Как управлять выполнением: Область и Метод

То, как будет выполнен `Запрос`, определяется двумя независимыми параметрами: **Областью** (где он работает) и **Методом** (как он работает). Агент понимает, что делать, по специальным подсказкам в `Инструменте` (`_module`, `_activity`, `_output`).

### Две оси выполнения

1.  **Область (Внутри или Снаружи)**
    Область определяет, будет ли задача выполнена прямо здесь, в текущем процессе агента, или её передадут кому-то вовне.
    - **Внутренняя Область**: Стандартный режим. Запрос обрабатывается немедленно.
    - **Внешняя Область**: Если есть пометка `_module`, агент понимает, что нужно передать этот Запрос другому модулю (`Activity` или `Idea`), который работает отдельно, как специалист в другой комнате.

2.  **Метод (Четко по инструкции или Творчески)**
    Метод определяет, будет ли результат получен с помощью точного кода или с помощью «воображения» ИИ.
    - **Четкий Метод**: Если есть пометка `_activity`, значит, результат должен быть получен с помощью предсказуемого кода, который работает как калькулятор.
    - **Творческий Метод**: Это стандартный режим, когда `_activity` нет. Результат генерирует ИИ, основываясь на своем понимании. Для этого ему нужна подсказка `_output`, чтобы знать, в каком виде должен быть ответ.

Эти параметры можно комбинировать для создания разных сценариев работы. Подробнее о том, как это всё сочетается, рассказано в **[008: Агент/Импорты](./008_agent_imports.md)**.

## Идея, Инструмент и Запрос: Разный фокус

Чтобы понять, как они связаны, важно увидеть, на чём сфокусирован каждый из них.

- **Идея** — **фокус на результате**. Её главная цель — показать готовый результат. Это описание того, что *было* или *могло бы быть*.

- **Инструмент** — **фокус на интерфейсе**. Он описывает, какие параметры (входные данные) можно задать. Это как пустой шаблон для действия, который ждёт, когда его заполнят.

- **Запрос** — **фокус на выполнении**. Это конкретный, готовый к запуску экземпляр `Инструмента`. Он берёт шаблон `Инструмента` и заполняет его реальными значениями, превращаясь в приказ о том, *что нужно сделать*.

## Идея-Контейнер: один момент принятия решения

Когда агенту нужно принять решение, весь запрос к ИИ упаковывается в специальный тип `Идеи`, который мы называем **Идея-Контейнер**. Она представляет собой один-единственный момент принятия решения.

Идея-Контейнер собирает вместе два ключевых элемента, которые нужны ИИ для выбора:

1.  **Контекст**: Вся важная информация, которая есть у агента: просьба пользователя, его прошлая история и другие данные.
2.  **Схема**: В Идее-Контейнере схема играет роль «меню». Она определяет набор доступных `Инструментов`, которые агенту разрешено использовать в данной ситуации.

ИИ обрабатывает всю эту `Идею` — и контекст, и меню доступных инструментов — и его `решением` становится список из одного или нескольких `Запросов`, которые нужно выполнить.

Это позволяет с помощью одной `Идеи` описать сложное действие, состоящее из нескольких шагов.

## Сценарии выполнения Запросов

Когда Идея-Контейнер порождает несколько Запросов, их можно выполнять по-разному, в зависимости от задачи:

```typescript
// Выполнить один Запрос
const result = await Tool(call);

// Выполнить все Запросы и дождаться всех результатов
const results = await Tool.all(calls);

// Выполнить все Запросы и вернуть результат первого успешного
const result = await Tool.any(calls);

// Выполнить все Запросы и вернуть результат первого завершившегося (неважно, успешно или нет)
const result = await Tool.race(calls);
```

Эти сценарии позволяют:

- **Точечно управлять**: Обрабатывать Запросы по одному, выполняя свою логику между ними.
- **Обрабатывать пачкой**: Выполнять независимые Запросы одновременно для максимальной скорости.
- **Быстро находить решение**: Остановиться после первого же успеха (`.any()`) или первого ответа (`.race()`).
- **Делать всё или ничего**: Гарантировать, что все Запросы в группе выполнятся успешно (`.all()`), чтобы избежать ошибок, когда они связаны друг с другом.