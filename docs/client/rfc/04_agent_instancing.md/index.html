<!DOCTYPE html>
    <html lang="en">
      <head>
        <link rel="stylesheet" type="text/css" href="/docs/assets/static/src_assets_tufte-2d3b6576.BrVfN5Rs.css">
        <meta charset="UTF-8" />
        
    <title>My Vike App</title><meta property="og:title" content="My Vike App" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="icon" href="/docs/assets/static/logo.DLJJsk-H.svg"/>
    
    <meta name="description" content="Demo showcasing Vike" /><meta property="og:description" content="Demo showcasing Vike" />
    
  
      </head>
      <body>
        
        <div id="root"></div>
        
        <script id="vike_pageContext" type="application/json">{"_urlRewrite":null,"pageId":"\\/src\\/@document\\/@chapter","routeParams":{"document":"rfc","chapterSlug":"04_agent_instancing"},"data":{"sitemap":{"manifesto":[{"id":"Call","number":1,"numberStr":"01","name":"Call","slug":"01_call","path":"01_call.md","url":"\\/manifesto\\/01_call.md"},{"id":"Inner Journey","number":2,"numberStr":"02","name":"Inner Journey","slug":"02_inner_journey","path":"02_inner_journey.md","url":"\\/manifesto\\/02_inner_journey.md"},{"id":"Outer Work","number":3,"numberStr":"03","name":"Outer Work","slug":"03_outer_work","path":"03_outer_work.md","url":"\\/manifesto\\/03_outer_work.md"}],"rfc":[{"id":"00_glossary","number":0,"numberStr":"00","name":"00_glossary","slug":"00_glossary","path":"00_glossary.md","url":"\\/rfc\\/00_glossary.md"},{"id":"The Mechanics of a Living Web","number":1,"numberStr":"01","name":"The Mechanics of a Living Web","slug":"01_protocol_ideas","path":"01_protocol_ideas.md","url":"\\/rfc\\/01_protocol_ideas.md"},{"id":"The Idea-to-Call Pipeline","number":2,"numberStr":"02","name":"The Idea-to-Call Pipeline","slug":"02_agent_calls","path":"02_agent_calls.md","url":"\\/rfc\\/02_agent_calls.md"},{"id":"Combining Scope and Method","number":3,"numberStr":"03","name":"Combining Scope and Method","slug":"03_agent_imports","path":"03_agent_imports.md","url":"\\/rfc\\/03_agent_imports.md"},{"id":"1. Foundational Requirement: The State System","number":4,"numberStr":"04","name":"1. Foundational Requirement: The State System","slug":"04_agent_instancing","path":"04_agent_instancing.md","url":"\\/rfc\\/04_agent_instancing.md"},{"id":"From Poker-Specific to Protocol-Driven","number":5,"numberStr":"05","name":"From Poker-Specific to Protocol-Driven","slug":"05_system_reactor","path":"05_system_reactor.md","url":"\\/rfc\\/05_system_reactor.md"},{"id":"The `Input` Message Type","number":6,"numberStr":"06","name":"The `Input` Message Type","slug":"06_agent_input","path":"06_agent_input.md","url":"\\/rfc\\/06_agent_input.md"}],"blueprint":[{"id":"Core Components","number":0,"numberStr":"00","name":"Core Components","slug":"00_architecture","path":"00_architecture.md","url":"\\/blueprint\\/00_architecture.md"},{"id":"B","number":0,"numberStr":"00","name":"B","slug":"00_glossary","path":"00_glossary.md","url":"\\/blueprint\\/00_glossary.md"},{"id":"New Ideas in This Chapter","number":0,"numberStr":"00","name":"New Ideas in This Chapter","slug":"00_references","path":"00_references.md","url":"\\/blueprint\\/00_references.md"},{"id":"New Ideas in This Chapter","number":1,"numberStr":"01","name":"New Ideas in This Chapter","slug":"01_vibes","path":"01_vibes.md","url":"\\/blueprint\\/01_vibes.md"},{"id":"Core Tables","number":1,"numberStr":"01","name":"Core Tables","slug":"01_vibes_database","path":"01_vibes_database.md","url":"\\/blueprint\\/01_vibes_database.md"},{"id":"Examples of Vibe Structures","number":1,"numberStr":"01","name":"Examples of Vibe Structures","slug":"01_vibes_examples","path":"01_vibes_examples.md","url":"\\/blueprint\\/01_vibes_examples.md"},{"id":"New Ideas in This Chapter","number":2,"numberStr":"02","name":"New Ideas in This Chapter","slug":"02_instructions","path":"02_instructions.md","url":"\\/blueprint\\/02_instructions.md"},{"id":"Example 1: Process Scheduling","number":2,"numberStr":"02","name":"Example 1: Process Scheduling","slug":"02_instructions_examples","path":"02_instructions_examples.md","url":"\\/blueprint\\/02_instructions_examples.md"},{"id":"Context Switching with Execution Environments","number":2,"numberStr":"02","name":"Context Switching with Execution Environments","slug":"02_instructions_guidance","path":"02_instructions_guidance.md","url":"\\/blueprint\\/02_instructions_guidance.md"},{"id":"New Ideas in This Chapter","number":4,"numberStr":"04","name":"New Ideas in This Chapter","slug":"04_refinements","path":"04_refinements.md","url":"\\/blueprint\\/04_refinements.md"},{"id":"Detailed Example: Evolving Record Vibe Schemas","number":4,"numberStr":"04","name":"Detailed Example: Evolving Record Vibe Schemas","slug":"04_refinements_examples","path":"04_refinements_examples.md","url":"\\/blueprint\\/04_refinements_examples.md"},{"id":"New Ideas in This Chapter","number":5,"numberStr":"05","name":"New Ideas in This Chapter","slug":"05_exchange","path":"05_exchange.md","url":"\\/blueprint\\/05_exchange.md"},{"id":"New Ideas in This Chapter","number":6,"numberStr":"06","name":"New Ideas in This Chapter","slug":"06_budgets","path":"06_budgets.md","url":"\\/blueprint\\/06_budgets.md"},{"id":"Self-Sustaining Startup Ecosystem","number":6,"numberStr":"06","name":"Self-Sustaining Startup Ecosystem","slug":"06_budgets_examples","path":"06_budgets_examples.md","url":"\\/blueprint\\/06_budgets_examples.md"},{"id":"New Ideas in This Chapter","number":6,"numberStr":"06","name":"New Ideas in This Chapter","slug":"06_budgets_stats","path":"06_budgets_stats.md","url":"\\/blueprint\\/06_budgets_stats.md"},{"id":"New Ideas in This Chapter","number":7,"numberStr":"07","name":"New Ideas in This Chapter","slug":"07_processes","path":"07_processes.md","url":"\\/blueprint\\/07_processes.md"},{"id":"New Ideas in This Chapter","number":8,"numberStr":"08","name":"New Ideas in This Chapter","slug":"08_branches","path":"08_branches.md","url":"\\/blueprint\\/08_branches.md"},{"id":"Navigating the Determinism Landscape","number":12,"numberStr":"12","name":"Navigating the Determinism Landscape","slug":"12_determinism","path":"12_determinism.md","url":"\\/blueprint\\/12_determinism.md"}]},"content":"\u003ch1>The Instancing Protocol\u003c\\/h1>\n\u003cp>\u003cem>For definitions of key terms used in this document, please refer to the \u003ca href=\".\\/00_glossary.md\">Glossary\u003c\\/a>.\u003c\\/em>\u003c\\/p>\n\u003cp>This document outlines a protocol for processing multiple, independent instances within a single agent request, using a state-driven architecture.\u003c\\/p>\n\u003ch2>1. Foundational Requirement: The State System\u003c\\/h2>\n\u003cp>The core prerequisite for this instancing protocol is the \u003cstrong>State System\u003c\\/strong>, which explicitly decouples the planning of actions from their execution.\u003c\\/p>\n\u003cp>The \u003cstrong>State Object\u003c\\/strong> is the bridge between these phases. It is a mutable, JSON-like object that serves two critical functions:\u003c\\/p>\n\u003col>\n\u003cli>\u003cstrong>Target for Execution\u003c\\/strong>: It is the canvas upon which tools operate. Every \u003ccode>Tool Call\u003c\\/code> includes an \u003ccode>_outputPath\u003c\\/code> property, which specifies a path within the \u003ccode>State\u003c\\/code> object where the tool&#39;s output should be written during execution.\u003c\\/li>\n\u003cli>\u003cstrong>Source for Dependencies\u003c\\/strong>: A \u003ccode>Tool Call\u003c\\/code> can reference a value from the \u003ccode>State\u003c\\/code> as one of its inputs. This allows for the creation of dependency graphs.\u003c\\/li>\n\u003c\\/ol>\n\u003ch2>2. The Instancing Mechanism\u003c\\/h2>\n\u003cp>The true power of this architecture is revealed in its native support for multi-instance operations, which is enabled by the State System.\u003c\\/p>\n\u003ch3>2.1. State Identifiers\u003c\\/h3>\n\u003cp>To process multiple instances in a single request, the system accepts an array of context messages. Each message representing a distinct instance is assigned a \u003cstrong>unique identifier\u003c\\/strong> via a special \u003ccode>_instance\u003c\\/code> property. These identifiers are short, unique tokens (e.g., circled numbers like \u003ccode>①\u003c\\/code>, \u003ccode>②\u003c\\/code>) that are easily visible to the LLM but carry no semantic meaning beyond their function as a reference.\u003c\\/p>\n\u003ch3>2.2. Targeted Operations\u003c\\/h3>\n\u003cp>This \u003ccode>_instance\u003c\\/code> is then used to target all operations to a specific instance&#39;s context. Furthermore, all meta-parameters for a \u003ccode>Tool Call\u003c\\/code> are prefixed with an underscore (\u003ccode>_\u003c\\/code>), and its \u003ccode>params\u003c\\/code> are inlined directly into the call object.\u003c\\/p>\n\u003cul>\n\u003cli>\u003cstrong>\u003ccode>Tool Call\u003c\\/code> Association\u003c\\/strong>: Each \u003ccode>Tool Call\u003c\\/code> in the generated plan contains the \u003ccode>_instance\u003c\\/code> of the context it should operate on.\u003c\\/li>\n\u003cli>\u003cstrong>Implicit Scoping\u003c\\/strong>: The \u003ccode>_instance\u003c\\/code> on a \u003ccode>Tool Call\u003c\\/code> implicitly scopes all path-based operations (\u003ccode>_outputPath\u003c\\/code> and input references) within that call. This means that when a tool reads from or writes to a state object, the path is relative to the \u003ccode>_instance\u003c\\/code> of the context it belongs to.\u003c\\/li>\n\u003c\\/ul>\n\u003cp>This mechanism allows the definitions of the tools themselves to remain simple and agnostic of the instancing context. The \u003ccode>_outputPath\u003c\\/code> and input references within a tool&#39;s schema do not need to be updated; the identifier cleanly separates the operational contexts.\u003c\\/p>\n\u003ch3>2.3. Example\u003c\\/h3>\n\u003cp>A single request might contain two state objects for sentiment analysis. The schema for the state can be provided to constrain the available properties and guide the LLM.\u003c\\/p>\n\u003cpre>\u003ccode class=\"language-json\">{\n  &quot;context&quot;: [\n    {\n      &quot;_instance&quot;: &quot;①&quot;,\n      &quot;type&quot;: &quot;state&quot;,\n      &quot;state&quot;: { &quot;text&quot;: &quot;This is wonderful!&quot; },\n      &quot;schema&quot;: {\n        &quot;type&quot;: &quot;object&quot;,\n        &quot;properties&quot;: {\n          &quot;text&quot;: { &quot;type&quot;: &quot;string&quot; },\n          &quot;sentiment&quot;: { &quot;type&quot;: &quot;string&quot; }\n        },\n        &quot;required&quot;: [&quot;text&quot;]\n      }\n    },\n    { &quot;_instance&quot;: &quot;②&quot;, &quot;type&quot;: &quot;state&quot;, &quot;state&quot;: { &quot;text&quot;: &quot;This is terrible.&quot; } }\n  ]\n}\n\u003c\\/code>\u003c\\/pre>\n\u003cp>The LLM processes both in a single context and generates a unified plan:\u003c\\/p>\n\u003cpre>\u003ccode class=\"language-json\">{\n  &quot;calls&quot;: [\n    {\n      &quot;_tool&quot;: &quot;analyzeSentiment&quot;,\n      &quot;_instance&quot;: &quot;①&quot;,\n      &quot;text&quot;: &quot;†state.text&quot;,\n      &quot;_outputPath&quot;: &quot;sentiment&quot;\n    },\n    {\n      &quot;_tool&quot;: &quot;analyzeSentiment&quot;,\n      &quot;_instance&quot;: &quot;②&quot;,\n      &quot;text&quot;: &quot;†state.text&quot;,\n      &quot;_outputPath&quot;: &quot;sentiment&quot;\n    }\n  ]\n}\n\u003c\\/code>\u003c\\/pre>\n\u003cp>The host environment then executes this plan, writing the results to the respective state objects.\u003c\\/p>\n\u003ch2>3. Complementary System: The Planning Graph\u003c\\/h2>\n\u003cp>While not a strict requirement for instancing, the \u003cstrong>Planning System\u003c\\/strong> works symbiotically with this architecture to enable highly predictable, reusable workflows.\u003c\\/p>\n\u003cp>A \u003cstrong>Plan\u003c\\/strong> is a template for a process, defined as a directed acyclic graph (DAG) of \u003ccode>Tool Calls\u003c\\/code>. This graph is generated by analyzing the dependencies between tools reading from and writing to a \u003ccode>State Object\u003c\\/code>.\u003c\\/p>\n\u003cp>Crucially, this plan can be generated and perfected \u003cem>before\u003c\\/em> execution. Once finalized, the plan can be passed as a \u003ccode>Context Message\u003c\\/code> to the agent. When processing multiple instances, the agent can then follow this pre-defined plan for each \u003ccode>State Object\u003c\\/code>, achieving highly consistent and predictable results across multiple invocations. The \u003ccode>State Object\u003c\\/code> for each instance serves as a snapshot of its current position within that execution graph.\u003c\\/p>\n\u003ch2>4. Advantages of this Approach\u003c\\/h2>\n\u003cp>This state-driven instancing model provides significant benefits:\u003c\\/p>\n\u003cul>\n\u003cli>\u003cstrong>Efficiency\u003c\\/strong>: It multiplies the throughput of the system by processing many instances in a single LLM request, dramatically improving speed and reducing costs.\u003c\\/li>\n\u003cli>\u003cstrong>Consistency &amp; Quality\u003c\\/strong>: By allowing the LLM to see multiple related instances in a single context, it can generate more consistent and higher-quality plans, leveraging patterns across all instances.\u003c\\/li>\n\u003cli>\u003cstrong>Predictability\u003c\\/strong>: When combined with a pre-defined \u003cstrong>Plan\u003c\\/strong>, the system can achieve deterministic outcomes. The deterministic execution loop ensures that once a plan is followed, its outcome is reliable and repeatable across every instance.\u003c\\/li>\n\u003c\\/ul>\n","currentChapter":"1. Foundational Requirement: The State System"}}</script>
        <script id="vike_globalContext" type="application/json">{}</script>
        <script src="/docs/assets/entries/entry-client-routing.CGxaIKAB.js" type="module" async></script>
        <link rel="modulepreload" href="/docs/assets/entries/src_-document_-chapter.C_7418N7.js" as="script" type="text/javascript">
        <link rel="modulepreload" href="/docs/assets/chunks/chunk-FZmpFa9c.js" as="script" type="text/javascript">
        <link rel="modulepreload" href="/docs/assets/chunks/chunk-tfHUaCBC.js" as="script" type="text/javascript">
      </body>
    </html>