[
  [
    {
      "body": "тут неплохо все-таки добавить шаг про тестирование, тк мы деплоим только протестированые образы. Думаю нелишним будет добавить понимания новопришедшим",
      "created_at": "2025-12-03T23:53:52Z",
      "diff_hunk": "@@ -3,70 +3,355 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586965160",
      "id": 2586965160,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "и неплохо добавить что образы хранятся в регистри докера. Канеш мелкая деталь, но понятно тогда откуда скачивает их ранер и как мы обеспечиваем идентичность образов и репродьюсибилити билдов",
      "created_at": "2025-12-03T23:56:03Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586968186",
      "id": 2586968186,
      "in_reply_to_id": 2586965160,
      "user": "Inviz"
    },
    {
      "body": "Добавил:\r\n\r\n**Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\r\n**Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\r\n",
      "created_at": "2025-12-04T16:47:45Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2589827054",
      "id": 2589827054,
      "in_reply_to_id": 2586965160,
      "user": "vyprik"
    }
  ],
  [
    {
      "body": "тут мы про раннер говорим, хотя по идее в контексте деплоймента слово Сервер означает финальный сервер на котором мы деплоим. А вроде до этого мы рассуждали, что по ssh соединяемся с сервером. \r\n\r\nИли у нас поменялось видение и можем больше не заходить по ssh, и управление через экшены происходит? Типа задеплоеный сервер - это ранер, он слушает задачу типа start app? так-то может это и логично. Но хочу уточнить конкретное видение",
      "created_at": "2025-12-04T00:00:01Z",
      "diff_hunk": "@@ -3,70 +3,355 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  Self-hosted Runner на сервере скачивает готовые образы.\n+4.  Для Application-сервисов запускается новый \"цветной\" стек.\n+5.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Сервер не открывает входящие порты для управления. GitHub Runner, установленный на сервере, сам опрашивает GitHub на наличие задач и выполняет команды локально.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586973615",
      "id": 2586973615,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "Да, добавил явное уточнение, что SSH используется только для ручного доступа, а CI работает локально через раннер:\r\n\r\n> - **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.",
      "created_at": "2025-12-04T16:47:52Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2589827464",
      "id": 2589827464,
      "in_reply_to_id": 2586973615,
      "user": "vyprik"
    }
  ],
  [
    {
      "body": "тогда пример должен быть `app-green-poker-runtime` - включать слово app, и app-green это префикс, а не суффикс. Я бы лучше тут сказал напрямую - что цвет стека определяется через project_name, который дает суффиксы всем контейнерам и хостам, изолируя друг от друга. ",
      "created_at": "2025-12-04T00:01:53Z",
      "diff_hunk": "@@ -3,70 +3,355 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  Self-hosted Runner на сервере скачивает готовые образы.\n+4.  Для Application-сервисов запускается новый \"цветной\" стек.\n+5.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Сервер не открывает входящие порты для управления. GitHub Runner, установленный на сервере, сам опрашивает GitHub на наличие задач и выполняет команды локально.\n+- **Централизованная конфигурация:** Единый источник истины для секретов — GitHub Secrets. Никаких `.env` файлов на диске сервера.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Динамические имена контейнеров:** Имена контейнеров и хостов формируются с суффиксом цвета (например, `poker-runtime-green`), что позволяет двум версиям приложения существовать в одной сети одновременно.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586976595",
      "id": 2586976595,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "Заменил на:\r\n\r\n> **Изоляция стеков:** Мы используем **Project Name** (`-p`) для логического разделения стеков. В сочетании с переменной `COLOR`, это обеспечивает уникальность имен контейнеров (напр. `app-green-poker-runtime`) и позволяет запускать Blue и Green версии параллельно в одной сети.",
      "created_at": "2025-12-04T16:47:57Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2589827706",
      "id": 2589827706,
      "in_reply_to_id": 2586976595,
      "user": "vyprik"
    }
  ],
  [
    {
      "body": "надо подписать что это временная ситуация, что мы не можем передплоивать едж без даунтайма. Это компромисс, который может быть улучшен в будущем. Но мы сосредотачиваемся на важной части - обновление приложения.",
      "created_at": "2025-12-04T00:03:09Z",
      "diff_hunk": "@@ -3,70 +3,355 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  Self-hosted Runner на сервере скачивает готовые образы.\n+4.  Для Application-сервисов запускается новый \"цветной\" стек.\n+5.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Сервер не открывает входящие порты для управления. GitHub Runner, установленный на сервере, сам опрашивает GitHub на наличие задач и выполняет команды локально.\n+- **Централизованная конфигурация:** Единый источник истины для секретов — GitHub Secrets. Никаких `.env` файлов на диске сервера.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Динамические имена контейнеров:** Имена контейнеров и хостов формируются с суффиксом цвета (например, `poker-runtime-green`), что позволяет двум версиям приложения существовать в одной сети одновременно.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586978345",
      "id": 2586978345,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "Добавил:\r\n\r\n> _Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._",
      "created_at": "2025-12-04T16:48:02Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2589827911",
      "id": 2589827911,
      "in_reply_to_id": 2586978345,
      "user": "vyprik"
    }
  ],
  [
    {
      "body": "нет, суфиксы мы не задаем вручную. Project name задает префиксы автоматически так что суффикс будет `app-green-nginx-app`, `app-green-poker-runtime`",
      "created_at": "2025-12-04T00:04:08Z",
      "diff_hunk": "@@ -3,70 +3,355 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  Self-hosted Runner на сервере скачивает готовые образы.\n+4.  Для Application-сервисов запускается новый \"цветной\" стек.\n+5.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Сервер не открывает входящие порты для управления. GitHub Runner, установленный на сервере, сам опрашивает GitHub на наличие задач и выполняет команды локально.\n+- **Централизованная конфигурация:** Единый источник истины для секретов — GitHub Secrets. Никаких `.env` файлов на диске сервера.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Динамические имена контейнеров:** Имена контейнеров и хостов формируются с суффиксом цвета (например, `poker-runtime-green`), что позволяет двум версиям приложения существовать в одной сети одновременно.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586979900",
      "id": 2586979900,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "Нужно с утра перепроверить и обсудить, в случае необходимости. Пока оставил без изменений.",
      "created_at": "2025-12-04T16:48:29Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2589829425",
      "id": 2589829425,
      "in_reply_to_id": 2586979900,
      "user": "vyprik"
    },
    {
      "body": "перепроверь, но так и работает изоляция через project-name, прекфиксы подставляются автоматически в хосты, сети и где-то в вольюмы",
      "created_at": "2025-12-04T23:35:46Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590941563",
      "id": 2590941563,
      "in_reply_to_id": 2586979900,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "изменить все примеры чтоб был префикс а не суффикс",
      "created_at": "2025-12-04T00:04:33Z",
      "diff_hunk": "@@ -3,70 +3,355 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  Self-hosted Runner на сервере скачивает готовые образы.\n+4.  Для Application-сервисов запускается новый \"цветной\" стек.\n+5.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Сервер не открывает входящие порты для управления. GitHub Runner, установленный на сервере, сам опрашивает GitHub на наличие задач и выполняет команды локально.\n+- **Централизованная конфигурация:** Единый источник истины для секретов — GitHub Secrets. Никаких `.env` файлов на диске сервера.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Динамические имена контейнеров:** Имена контейнеров и хостов формируются с суффиксом цвета (например, `poker-runtime-green`), что позволяет двум версиям приложения существовать в одной сети одновременно.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586980570",
      "id": 2586980570,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "Нужно с утра перепроверить и обсудить, в случае необходимости. Пока оставил без изменений.",
      "created_at": "2025-12-04T16:48:40Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2589830037",
      "id": 2589830037,
      "in_reply_to_id": 2586980570,
      "user": "vyprik"
    }
  ],
  [
    {
      "body": "внутри какой сети? надо тут разьяснить. Мы сети изолируем блю от грин? Или сеть общая на всё? Что насчет сети еджа?",
      "created_at": "2025-12-04T00:05:15Z",
      "diff_hunk": "@@ -3,70 +3,355 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  Self-hosted Runner на сервере скачивает готовые образы.\n+4.  Для Application-сервисов запускается новый \"цветной\" стек.\n+5.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Сервер не открывает входящие порты для управления. GitHub Runner, установленный на сервере, сам опрашивает GitHub на наличие задач и выполняет команды локально.\n+- **Централизованная конфигурация:** Единый источник истины для секретов — GitHub Secrets. Никаких `.env` файлов на диске сервера.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Динамические имена контейнеров:** Имена контейнеров и хостов формируются с суффиксом цвета (например, `poker-runtime-green`), что позволяет двум версиям приложения существовать в одной сети одновременно.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Изоляция в сети:** Новый стек доступен внутри Docker-сети по своим хостнеймам, но внешний трафик на него еще не идет.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586981544",
      "id": 2586981544,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "По идее всё в одну сеть если сделать то будет легко. Но если разьединить то будет более гибко и безопасно. Я бы предложил, чтобы сети были разьединены. А блю-грин переключался бы по порту на хост машине (у каждого стека-цвета свой порт, типа app-blue: 81, app-green: 82). Тогда еботы с днсом тоже не будет - алекс страдал что хосты переключать в нжинксе вызывает даунтайм",
      "created_at": "2025-12-04T00:18:37Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586999729",
      "id": 2586999729,
      "in_reply_to_id": 2586981544,
      "user": "Inviz"
    },
    {
      "body": "Обновил два пункта:\r\n\r\n> 2.  **Сетевая изоляция:** Каждый стек (Blue/Green) запускается в своей собственной изолированной Docker-сети (`default` network проекта). Стеки не видят друг друга и не пересекаются по DNS-именам. Связь с Edge осуществляется через проброс портов на хост.\r\n\r\n> 4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию upstream, переключая трафик на порт хоста (`STACK_PORT`), соответствующий новому стеку (Port-based Routing).\r\n",
      "created_at": "2025-12-04T16:48:45Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2589830368",
      "id": 2589830368,
      "in_reply_to_id": 2586981544,
      "user": "vyprik"
    },
    {
      "body": "Коля ты глянул че я тебе в канале девопсе линканул? там еще описано что host.docker.internal хост используется для этого. ",
      "created_at": "2025-12-04T23:32:15Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590936231",
      "id": 2590936231,
      "in_reply_to_id": 2586981544,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "в состоянии healthy",
      "created_at": "2025-12-04T00:05:29Z",
      "diff_hunk": "@@ -3,70 +3,355 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  Self-hosted Runner на сервере скачивает готовые образы.\n+4.  Для Application-сервисов запускается новый \"цветной\" стек.\n+5.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Сервер не открывает входящие порты для управления. GitHub Runner, установленный на сервере, сам опрашивает GitHub на наличие задач и выполняет команды локально.\n+- **Централизованная конфигурация:** Единый источник истины для секретов — GitHub Secrets. Никаких `.env` файлов на диске сервера.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Динамические имена контейнеров:** Имена контейнеров и хостов формируются с суффиксом цвета (например, `poker-runtime-green`), что позволяет двум версиям приложения существовать в одной сети одновременно.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Изоляция в сети:** Новый стек доступен внутри Docker-сети по своим хостнеймам, но внешний трафик на него еще не идет.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека ответили `healthy`.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586982000",
      "id": 2586982000,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "Исправил.",
      "created_at": "2025-12-04T16:48:52Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2589830752",
      "id": 2589830752,
      "in_reply_to_id": 2586982000,
      "user": "vyprik"
    }
  ],
  [
    {
      "body": "стоит юзать `-e APP_HOST=idealic-green-poker-runtime` для консистентности? ",
      "created_at": "2025-12-04T00:06:56Z",
      "diff_hunk": "@@ -3,70 +3,355 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  Self-hosted Runner на сервере скачивает готовые образы.\n+4.  Для Application-сервисов запускается новый \"цветной\" стек.\n+5.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Сервер не открывает входящие порты для управления. GitHub Runner, установленный на сервере, сам опрашивает GitHub на наличие задач и выполняет команды локально.\n+- **Централизованная конфигурация:** Единый источник истины для секретов — GitHub Secrets. Никаких `.env` файлов на диске сервера.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Динамические имена контейнеров:** Имена контейнеров и хостов формируются с суффиксом цвета (например, `poker-runtime-green`), что позволяет двум версиям приложения существовать в одной сети одновременно.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Изоляция в сети:** Новый стек доступен внутри Docker-сети по своим хостнеймам, но внешний трафик на него еще не идет.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека ответили `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию, направляя `proxy_pass` на хост `nginx-app-green`.\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App\n+app.blue.yml                   # Override: конфигурация для Blue стека\n+app.green.yml                  # Override: конфигурация для Green стека\n+```\n+\n+**Как работает наслаивание:**\n+\n+- **Локальная разработка:** Используется команда `docker compose -f docker-compose.app.yml up`. Используется только базовый файл. Переменные окружения берутся из `.env` файла автоматически.\n+- **Production деплой:** Используется цепочка файлов. Файл `.deploy.yml` переопределяет `image:` на готовые образы из Registry. Переменные передаются через environment shell (GitHub Secrets).\n+\n+---\n+\n+### 5.2 Анатомия команды деплоя\n+\n+Это ключевой раздел, объясняющий, как мы консолидируем разные задачи в один вызов команды Docker Compose.\n+\n+**Пример команды запуска Green стека в Production:**\n+\n+```bash\n+# 1. ENV VARIABLES (Secrets)\n+APP_HOST=poker-runtime-green \\",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586984019",
      "id": 2586984019,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "Удалил файлы app.blue.yml и app.green.yml, так как порты будут задаваться через переменную.",
      "created_at": "2025-12-04T16:48:57Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2589831052",
      "id": 2589831052,
      "in_reply_to_id": 2586984019,
      "user": "vyprik"
    },
    {
      "body": "по идее да, можно. Если только одним портом торчим наружу",
      "created_at": "2025-12-04T23:33:43Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590938648",
      "id": 2590938648,
      "in_reply_to_id": 2586984019,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "давай везде наведи порядок по документу про изоляциюю. \r\n\r\napp-green, app-blue  для внутрених стеков, везде юзать префиксы а не суффиксы и не вручную\r\nedge для внешних сервисов\r\n\r\nпредлагаю не юзать idealic для простоты. Если надо мы потом переальясить можем на сервере легко",
      "created_at": "2025-12-04T00:10:32Z",
      "diff_hunk": "@@ -3,70 +3,355 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  Self-hosted Runner на сервере скачивает готовые образы.\n+4.  Для Application-сервисов запускается новый \"цветной\" стек.\n+5.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Сервер не открывает входящие порты для управления. GitHub Runner, установленный на сервере, сам опрашивает GitHub на наличие задач и выполняет команды локально.\n+- **Централизованная конфигурация:** Единый источник истины для секретов — GitHub Secrets. Никаких `.env` файлов на диске сервера.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Динамические имена контейнеров:** Имена контейнеров и хостов формируются с суффиксом цвета (например, `poker-runtime-green`), что позволяет двум версиям приложения существовать в одной сети одновременно.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Изоляция в сети:** Новый стек доступен внутри Docker-сети по своим хостнеймам, но внешний трафик на него еще не идет.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека ответили `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию, направляя `proxy_pass` на хост `nginx-app-green`.\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App\n+app.blue.yml                   # Override: конфигурация для Blue стека\n+app.green.yml                  # Override: конфигурация для Green стека\n+```\n+\n+**Как работает наслаивание:**\n+\n+- **Локальная разработка:** Используется команда `docker compose -f docker-compose.app.yml up`. Используется только базовый файл. Переменные окружения берутся из `.env` файла автоматически.\n+- **Production деплой:** Используется цепочка файлов. Файл `.deploy.yml` переопределяет `image:` на готовые образы из Registry. Переменные передаются через environment shell (GitHub Secrets).\n+\n+---\n+\n+### 5.2 Анатомия команды деплоя\n+\n+Это ключевой раздел, объясняющий, как мы консолидируем разные задачи в один вызов команды Docker Compose.\n+\n+**Пример команды запуска Green стека в Production:**\n+\n+```bash\n+# 1. ENV VARIABLES (Secrets)\n+APP_HOST=poker-runtime-green \\\n+APP_PORT=3003 \\\n+OPENAI_API_KEY=sk-... \\\n+# 2. COMMAND\n+docker compose \\\n+  # 3. LAYERING\n+  -f docker-compose.app.yml \\         # База (структура сервисов)\n+  -f docker-compose.app.deploy.yml \\  # Prod Override (образы из registry)\n+  -f app.green.yml \\                  # Color Override (порты для green)\n+  # 4. ISOLATION\n+  -p idealic-green \\                  # Project Name (изолированный namespace)\n+  # 5. ACTION\n+  up -d --wait\n+```\n+\n+**Разбор компонентов:**\n+\n+1.  **ENV VARIABLES:**\n+    - Передаются **перед** командой или через экспорт в shell.\n+    - **Почему так:** Мы НИКОГДА не сохраняем секреты в `.env` файлы на сервере (security risk). GitHub Actions инжектит их напрямую в процесс запуска.\n+    - Внутри `docker-compose.yml` переменные подставляются в секции `environment:`.\n+\n+2.  **LAYERING (`-f ...`):**\n+    - Мы собираем итоговый конфиг из кусочков. Это позволяет не дублировать код.\n+    - `app.deploy.yml` заменяет `build: .` на `image: registry/...`.\n+\n+3.  **ISOLATION (`-p ...`):**\n+    - Задает **Project Name**. Все контейнеры получат префикс `idealic-green-`.\n+    - Это критично для Blue-Green: позволяет запустить _вторую_ копию тех же самых сервисов параллельно с первой (`idealic-blue`), не вызывая конфликта имен.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586988838",
      "id": 2586988838,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "но в идеале везде где мы юзаем хостнейм и т д неплохо бы сделать возможность тоже конфигурировать префикс. \r\n\r\nПредлагаю так:\r\n\r\nSTACK_NAME=idealic-app\r\nSTACK_COLOR=green\r\n\r\n->\r\n\r\n-p $STACK_NAME-$STACK_COLOR\r\n\r\nтаким образом мы можем запустить `idealic-app-staging-blue` например на том же сервере что и `idealic-app-green` продакшен, и быть обслужеными одним edge сервером (в теории)",
      "created_at": "2025-12-04T00:15:06Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586994891",
      "id": 2586994891,
      "in_reply_to_id": 2586988838,
      "user": "Inviz"
    },
    {
      "body": "для этого мы должны убедиться что все хосты передаются из конфига, а конфиги правильно сконфигурированы. Мы ожидаем что env переменные установлены правильно (то есть учитывают $STACK_NAME если где-то в переменных забиты хосты)",
      "created_at": "2025-12-04T00:16:25Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2586996786",
      "id": 2586996786,
      "in_reply_to_id": 2586988838,
      "user": "Inviz"
    },
    {
      "body": "Внес правки, с учетом и STACK_PORT.",
      "created_at": "2025-12-04T16:49:08Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2589831639",
      "id": 2589831639,
      "in_reply_to_id": 2586988838,
      "user": "vyprik"
    }
  ],
  [
    {
      "body": "как сказано выше, я предлагаю server:$DOCKER_HOST_IP:$STACK_PORT - то есть хост один и тот же всегда, а айпи у каждого стека-цвета свой",
      "created_at": "2025-12-04T00:19:41Z",
      "diff_hunk": "@@ -3,70 +3,355 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  Self-hosted Runner на сервере скачивает готовые образы.\n+4.  Для Application-сервисов запускается новый \"цветной\" стек.\n+5.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Сервер не открывает входящие порты для управления. GitHub Runner, установленный на сервере, сам опрашивает GitHub на наличие задач и выполняет команды локально.\n+- **Централизованная конфигурация:** Единый источник истины для секретов — GitHub Secrets. Никаких `.env` файлов на диске сервера.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Динамические имена контейнеров:** Имена контейнеров и хостов формируются с суффиксом цвета (например, `poker-runtime-green`), что позволяет двум версиям приложения существовать в одной сети одновременно.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Изоляция в сети:** Новый стек доступен внутри Docker-сети по своим хостнеймам, но внешний трафик на него еще не идет.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека ответили `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию, направляя `proxy_pass` на хост `nginx-app-green`.\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App\n+app.blue.yml                   # Override: конфигурация для Blue стека\n+app.green.yml                  # Override: конфигурация для Green стека\n+```\n+\n+**Как работает наслаивание:**\n+\n+- **Локальная разработка:** Используется команда `docker compose -f docker-compose.app.yml up`. Используется только базовый файл. Переменные окружения берутся из `.env` файла автоматически.\n+- **Production деплой:** Используется цепочка файлов. Файл `.deploy.yml` переопределяет `image:` на готовые образы из Registry. Переменные передаются через environment shell (GitHub Secrets).\n+\n+---\n+\n+### 5.2 Анатомия команды деплоя\n+\n+Это ключевой раздел, объясняющий, как мы консолидируем разные задачи в один вызов команды Docker Compose.\n+\n+**Пример команды запуска Green стека в Production:**\n+\n+```bash\n+# 1. ENV VARIABLES (Secrets)\n+APP_HOST=poker-runtime-green \\\n+APP_PORT=3003 \\\n+OPENAI_API_KEY=sk-... \\\n+# 2. COMMAND\n+docker compose \\\n+  # 3. LAYERING\n+  -f docker-compose.app.yml \\         # База (структура сервисов)\n+  -f docker-compose.app.deploy.yml \\  # Prod Override (образы из registry)\n+  -f app.green.yml \\                  # Color Override (порты для green)\n+  # 4. ISOLATION\n+  -p idealic-green \\                  # Project Name (изолированный namespace)\n+  # 5. ACTION\n+  up -d --wait\n+```\n+\n+**Разбор компонентов:**\n+\n+1.  **ENV VARIABLES:**\n+    - Передаются **перед** командой или через экспорт в shell.\n+    - **Почему так:** Мы НИКОГДА не сохраняем секреты в `.env` файлы на сервере (security risk). GitHub Actions инжектит их напрямую в процесс запуска.\n+    - Внутри `docker-compose.yml` переменные подставляются в секции `environment:`.\n+\n+2.  **LAYERING (`-f ...`):**\n+    - Мы собираем итоговый конфиг из кусочков. Это позволяет не дублировать код.\n+    - `app.deploy.yml` заменяет `build: .` на `image: registry/...`.\n+\n+3.  **ISOLATION (`-p ...`):**\n+    - Задает **Project Name**. Все контейнеры получат префикс `idealic-green-`.\n+    - Это критично для Blue-Green: позволяет запустить _вторую_ копию тех же самых сервисов параллельно с первой (`idealic-blue`), не вызывая конфликта имен.\n+\n+4.  **ACTION (`up -d --wait`):**\n+    - `--wait`: Самый важный флаг для Atomic Deployment. Compose ждет, пока ВСЕ healthcheck'и пройдут (станут `healthy`).\n+    - Если хоть один сервис не взлетел — команда возвращает exit code 1. CI останавливает деплой. Трафик не переключается.\n+\n+---\n+\n+### 5.3 Blue-Green скрипты\n+\n+```\n+scripts/blue-green/\n+├── switch.sh   # Переключение трафика между blue/green\n+└── deploy.sh   # Полный цикл деплоя\n+```\n+\n+**Использование:**\n+\n+```bash\n+# Показать текущий статус\n+./scripts/blue-green/switch.sh status\n+\n+# Переключить трафик на green\n+./scripts/blue-green/switch.sh green\n+\n+# Переключить на противоположный стек\n+./scripts/blue-green/switch.sh toggle\n+\n+# Полный цикл деплоя (запуск нового стека + переключение + остановка старого)\n+./scripts/blue-green/deploy.sh\n+\n+# Деплой без остановки старого стека\n+./scripts/blue-green/deploy.sh --skip-cleanup\n+```\n+\n+### 5.4 Механизм переключения трафика\n+\n+Nginx Edge использует симлинк для определения активного upstream:\n+\n+```\n+/etc/nginx/conf.d/\n+├── 00-upstream.conf -> upstream-blue.conf   # Симлинк (источник правды)\n+├── upstream-blue.conf                        # upstream app_backend { server nginx-app-blue:80; }",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2587001257",
      "id": 2587001257,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "Исправил.",
      "created_at": "2025-12-04T16:49:27Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2589832764",
      "id": 2589832764,
      "in_reply_to_id": 2587001257,
      "user": "vyprik"
    }
  ],
  [
    {
      "body": "ок вижу твой ответ на мой вопрос выше. О том что деплой через гитхаб ранер происходит. Это мне кажется хорошая идея. Я сам не допёр почему-то. ",
      "created_at": "2025-12-04T00:21:20Z",
      "diff_hunk": "@@ -3,70 +3,355 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  Self-hosted Runner на сервере скачивает готовые образы.\n+4.  Для Application-сервисов запускается новый \"цветной\" стек.\n+5.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Сервер не открывает входящие порты для управления. GitHub Runner, установленный на сервере, сам опрашивает GitHub на наличие задач и выполняет команды локально.\n+- **Централизованная конфигурация:** Единый источник истины для секретов — GitHub Secrets. Никаких `.env` файлов на диске сервера.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Динамические имена контейнеров:** Имена контейнеров и хостов формируются с суффиксом цвета (например, `poker-runtime-green`), что позволяет двум версиям приложения существовать в одной сети одновременно.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Изоляция в сети:** Новый стек доступен внутри Docker-сети по своим хостнеймам, но внешний трафик на него еще не идет.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека ответили `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию, направляя `proxy_pass` на хост `nginx-app-green`.\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App\n+app.blue.yml                   # Override: конфигурация для Blue стека\n+app.green.yml                  # Override: конфигурация для Green стека\n+```\n+\n+**Как работает наслаивание:**\n+\n+- **Локальная разработка:** Используется команда `docker compose -f docker-compose.app.yml up`. Используется только базовый файл. Переменные окружения берутся из `.env` файла автоматически.\n+- **Production деплой:** Используется цепочка файлов. Файл `.deploy.yml` переопределяет `image:` на готовые образы из Registry. Переменные передаются через environment shell (GitHub Secrets).\n+\n+---\n+\n+### 5.2 Анатомия команды деплоя\n+\n+Это ключевой раздел, объясняющий, как мы консолидируем разные задачи в один вызов команды Docker Compose.\n+\n+**Пример команды запуска Green стека в Production:**\n+\n+```bash\n+# 1. ENV VARIABLES (Secrets)\n+APP_HOST=poker-runtime-green \\\n+APP_PORT=3003 \\\n+OPENAI_API_KEY=sk-... \\\n+# 2. COMMAND\n+docker compose \\\n+  # 3. LAYERING\n+  -f docker-compose.app.yml \\         # База (структура сервисов)\n+  -f docker-compose.app.deploy.yml \\  # Prod Override (образы из registry)\n+  -f app.green.yml \\                  # Color Override (порты для green)\n+  # 4. ISOLATION\n+  -p idealic-green \\                  # Project Name (изолированный namespace)\n+  # 5. ACTION\n+  up -d --wait\n+```\n+\n+**Разбор компонентов:**\n+\n+1.  **ENV VARIABLES:**\n+    - Передаются **перед** командой или через экспорт в shell.\n+    - **Почему так:** Мы НИКОГДА не сохраняем секреты в `.env` файлы на сервере (security risk). GitHub Actions инжектит их напрямую в процесс запуска.\n+    - Внутри `docker-compose.yml` переменные подставляются в секции `environment:`.\n+\n+2.  **LAYERING (`-f ...`):**\n+    - Мы собираем итоговый конфиг из кусочков. Это позволяет не дублировать код.\n+    - `app.deploy.yml` заменяет `build: .` на `image: registry/...`.\n+\n+3.  **ISOLATION (`-p ...`):**\n+    - Задает **Project Name**. Все контейнеры получат префикс `idealic-green-`.\n+    - Это критично для Blue-Green: позволяет запустить _вторую_ копию тех же самых сервисов параллельно с первой (`idealic-blue`), не вызывая конфликта имен.\n+\n+4.  **ACTION (`up -d --wait`):**\n+    - `--wait`: Самый важный флаг для Atomic Deployment. Compose ждет, пока ВСЕ healthcheck'и пройдут (станут `healthy`).\n+    - Если хоть один сервис не взлетел — команда возвращает exit code 1. CI останавливает деплой. Трафик не переключается.\n+\n+---\n+\n+### 5.3 Blue-Green скрипты\n+\n+```\n+scripts/blue-green/\n+├── switch.sh   # Переключение трафика между blue/green\n+└── deploy.sh   # Полный цикл деплоя\n+```\n+\n+**Использование:**\n+\n+```bash\n+# Показать текущий статус\n+./scripts/blue-green/switch.sh status\n+\n+# Переключить трафик на green\n+./scripts/blue-green/switch.sh green\n+\n+# Переключить на противоположный стек\n+./scripts/blue-green/switch.sh toggle\n+\n+# Полный цикл деплоя (запуск нового стека + переключение + остановка старого)\n+./scripts/blue-green/deploy.sh\n+\n+# Деплой без остановки старого стека\n+./scripts/blue-green/deploy.sh --skip-cleanup\n+```\n+\n+### 5.4 Механизм переключения трафика\n+\n+Nginx Edge использует симлинк для определения активного upstream:\n+\n+```\n+/etc/nginx/conf.d/\n+├── 00-upstream.conf -> upstream-blue.conf   # Симлинк (источник правды)\n+├── upstream-blue.conf                        # upstream app_backend { server nginx-app-blue:80; }\n+├── upstream-green.conf                       # upstream app_backend { server nginx-app-green:80; }\n+└── default.conf                              # Server блоки с proxy_pass http://app_backend\n+```\n+\n+**Переключение:**\n+\n+1. `ln -sf upstream-green.conf 00-upstream.conf` — атомарная смена симлинка\n+2. `nginx -s reload` — graceful перезагрузка (без прерывания соединений)\n+\n+### 5.5 GitHub Actions Workflow\n+\n+Файл: `.github/workflows/deploy-blue-green.yml`\n+\n+**Jobs:**\n+\n+| Job                     | Описание                                              | Когда запускается                  |\n+|-------------------------|-------------------------------------------------------|------------------------------------|\n+| `determine-environment` | Определяет окружение (production/staging/development) | Всегда                             |\n+| `build`                 | Собирает все Docker образы (Edge + App)               | Всегда                             |\n+| `test`                  | Запускает тесты                                       | Если не skip-tests                 |\n+| `release`               | Тегирует образы стабильным тегом                      | После успешных тестов, только push |\n+| `deploy-edge`           | Деплоит инфраструктуру (БД, Temporal, nginx-edge)     | Только при `deploy-edge: true`     |\n+| `deploy-app`            | **Blue-Green деплой** приложения                      | После release, автоматически       |\n+\n+**Workflow:**\n+\n+```\n+push to main/staging/development\n+        │\n+        ↓\n+┌───────────────────┐\n+│ determine-env     │\n+└───────────────────┘\n+     │\n+     ├──────────────────────────────────────────┐\n+     ▼                                          ▼\n+┌───────────────────┐                      ┌───────────────────┐\n+│ build-app         │ (ВСЕГДА)             │ build-edge        │ (РУЧНОЙ / CONDITIONAL)\n+│ (nginx-app, core) │                      │ (DB, Edge Nginx)  │\n+└───────────────────┘                      └───────────────────┘\n+     │                                          │\n+     ▼                                          ▼\n+┌───────────────────┐                      ┌───────────────────┐\n+│ test & release    │                      │ release-edge      │\n+└───────────────────┘                      └───────────────────┘\n+     │                                          │\n+     ▼                                          ▼\n+┌───────────────────┐                      ┌───────────────────┐\n+│ deploy-app        │                      │ deploy-edge       │\n+│ (Blue-Green)      │                      │ (Recreate)        │\n+└───────────────────┘                      └───────────────────┘\n+```\n+\n+- **deploy-app:** Запускается автоматически после успешных тестов. Выполняет `scripts/blue-green/deploy.sh`.\n+- **deploy-edge:** Запускается **только** если был изменен код в папках инфраструктуры или по ручному триггеру (`workflow_dispatch`).\n+\n+---\n+\n+## 6. Технические Детали\n+\n+### 6.1 Управление переменными окружения\n+\n+Секреты передаются строго в памяти процесса (`Secrets in Memory`). GitHub Runner инжектит их в процесс `docker compose` в момент запуска. На диске сервера секреты никогда не сохраняются.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2587003644",
      "id": 2587003644,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "неплохо бы тоже обьяснить почему докер композ юзаем\r\n1) Потому что позволяет иметь одну инфраструктуру локально, на стейджинге и продакшене\r\n2) Хорошо изолировано, позволяет запускать несколько приложений на одном сервере (это по идее становится теперь инвариантом, что у нас не должно быть конфликтов между стеками и инстансами приложения - стейджинг, продакшен, дев, должны уметь бежать рядом)\r\n3) Гибкость разворачивания - можно разворачивать разные комбинации внешних и внутренних стеков\r\n4) Индустриальный стандарт - всем понятно, легко поддерживать\r\n5) Легкость расширения - привнесение новых компонентов делается очень легко, доступно много разных имеджей\r\n6) Докер композ без кубернетеса - облегченное администрирование и управление, позволяет композу взять на себя все сложные части\r\n7) Деплой стека целиком - все компоненты протестированы, что работают вместе, все зависимые части обновляются одновременно\r\n8) Дружественно к параметризированию через переменные - можно отделить конфигурацию от архитектуры\r\n9) Использование контейнеров - легковесный способ добиться предсказуемости, без налога на виртуализацию (в линуксе)\r\n10) Централизированая конфигурация через композ файлы - не разбросано по миру\r\n11) Хорошо работает с монорепозиториями, чтобы тестировать и деплоить изменения в экосистеме целиком\r\n12) Легкий концептуально рецепты для zero downtime deployment и экстренного отката системы\r\n13) Повторяемость билда - одно и то же работает везде\r\n14) Скорость разворачивания - докер кеширует билды всех имеджей по слоям, позволяя избежать перекомпиляции всего мира\r\n15) Система хелсчеков и зависимостей позволяет запускать стек целиком за раз, помогает избежать круговых циклов зависимостй между компонентами, не думать о порядке и успешности запуска\r\n",
      "created_at": "2025-12-04T23:43:55Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590953448",
      "id": 2590953448,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "посмотри сам, может быть кое что отсюда можно вынести в философию и цели, а можно оставить просто введение как почему докер композ. ",
      "created_at": "2025-12-04T23:47:57Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590959296",
      "id": 2590959296,
      "in_reply_to_id": 2590953448,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "пройдись по документу и устакань манеру повествования. Я предлагаю убрать мы, вы, ты. Оставить безлично и технологично.",
      "created_at": "2025-12-04T23:46:20Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590957042",
      "id": 2590957042,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "уже не хостнейм, и было бы неплохо обьяснить более простыми словами. Edge nginx перенаправляет входящеий трафик в новый стек",
      "created_at": "2025-12-04T23:47:25Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590958564",
      "id": 2590958564,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "Пожалуйста, когды ты применяешь правки меняй сразу во всех местах. STACK_COLOR",
      "created_at": "2025-12-04T23:48:35Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590960324",
      "id": 2590960324,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "Проси ллм проанализировать документ и добиться консистентности в переменных, пусть выявляет исторические нескладухи",
      "created_at": "2025-12-04T23:49:08Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590961122",
      "id": 2590961122,
      "in_reply_to_id": 2590960324,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "давай сразу использовать пример для приложения а-ля `app-production-green`. чтоб понятно было как окружения не конфликтуют. ",
      "created_at": "2025-12-04T23:50:04Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590962507",
      "id": 2590962507,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "либо даже idealic-production-green. Я знаю, что я в прошлый раз предлагал переименовать всё в app, поэтому смотри сам",
      "created_at": "2025-12-04T23:50:56Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590963856",
      "id": 2590963856,
      "in_reply_to_id": 2590962507,
      "user": "Inviz"
    },
    {
      "body": "в том смысле что сама конфигурация остается docker-compose.app.yml, а idealic это \"экземпляр\" приложения. Например если бы мы на другом рынке продавали под другим именем, мы могли бы использовать какой нибудь \"megabot-production-green\", имея ту же самую конфигурацию композа. То есть это та часть, которая из конфигурации приходит и можно создать новые инвайроменты ",
      "created_at": "2025-12-04T23:52:15Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590966577",
      "id": 2590966577,
      "in_reply_to_id": 2590962507,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "предлагаю другую формулировку - Некоторые сервисы (типа acme-sh для SSL), привязаны к конкретным профилям, которые указываются через `--profile=production`, позволяя гибко контроллировать состав стека",
      "created_at": "2025-12-04T23:54:29Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590970102",
      "id": 2590970102,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "сборка, пуш, пул и запуск образов выполняются паравллельно, для ускорения всех процессов CI/CD",
      "created_at": "2025-12-04T23:55:13Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590971140",
      "id": 2590971140,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "насчет запуска не уверен, делает ли там что-то --parallel или нет",
      "created_at": "2025-12-04T23:55:31Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590971543",
      "id": 2590971543,
      "in_reply_to_id": 2590971140,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "описать намерение/ситуацию. Теперь когда мы теоретически позволяем нескольким внутренним стекам юзать один внешний, нужно лучше обьяснить общее видение",
      "created_at": "2025-12-04T23:56:18Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590972714",
      "id": 2590972714,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "и доступ через host.docker.internal",
      "created_at": "2025-12-04T23:57:50Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+_Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Сетевая изоляция:** Каждый стек (Blue/Green) запускается в своей собственной изолированной Docker-сети (`default` network проекта). Стеки не видят друг друга и не пересекаются по DNS-именам. Связь с Edge осуществляется через проброс портов на хост.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590975410",
      "id": 2590975410,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "Представим что на сервере уже запущен стек приложения с цветом BLUE. Это значит, что следующий деплой будет сделано с цветом GREEN. \r\n\r\nПотому что у тебя щас немножко с места в карьер ",
      "created_at": "2025-12-04T23:59:38Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+_Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590978576",
      "id": 2590978576,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "Port-based Routing тут ничего не добавляет. Убрать латинизмы ненужные, особенно такие, какие не являются индустриальными терминами",
      "created_at": "2025-12-05T00:00:17Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+_Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Сетевая изоляция:** Каждый стек (Blue/Green) запускается в своей собственной изолированной Docker-сети (`default` network проекта). Стеки не видят друг друга и не пересекаются по DNS-именам. Связь с Edge осуществляется через проброс портов на хост.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека в состоянии `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию upstream, переключая трафик на порт хоста (`STACK_PORT`), соответствующий новому стеку (Port-based Routing).",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590979550",
      "id": 2590979550,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "как насчет docker-compose.app.local.yml? или это через профили как-то делается?",
      "created_at": "2025-12-05T00:01:31Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+_Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Сетевая изоляция:** Каждый стек (Blue/Green) запускается в своей собственной изолированной Docker-сети (`default` network проекта). Стеки не видят друг друга и не пересекаются по DNS-именам. Связь с Edge осуществляется через проброс портов на хост.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека в состоянии `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию upstream, переключая трафик на порт хоста (`STACK_PORT`), соответствующий новому стеку (Port-based Routing).\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590981493",
      "id": 2590981493,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "или docker-compose.app.yml и есть локальный рецепт?",
      "created_at": "2025-12-05T00:01:57Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590982050",
      "id": 2590982050,
      "in_reply_to_id": 2590981493,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "коммент потерял мой? \r\n\r\nпеременные надо передавать через -e флаг в докер композе для консистентности. А не юниксовым путем как у тебя тут",
      "created_at": "2025-12-05T00:03:06Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+_Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Сетевая изоляция:** Каждый стек (Blue/Green) запускается в своей собственной изолированной Docker-сети (`default` network проекта). Стеки не видят друг друга и не пересекаются по DNS-именам. Связь с Edge осуществляется через проброс портов на хост.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека в состоянии `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию upstream, переключая трафик на порт хоста (`STACK_PORT`), соответствующий новому стеку (Port-based Routing).\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App\n+```\n+\n+**Как работает наслаивание:**\n+\n+- **Локальная разработка:** Используется команда `docker compose -f docker-compose.app.yml up`. Используется только базовый файл. Переменные окружения берутся из `.env` файла автоматически.\n+- **Production деплой:** Используется цепочка файлов. Файл `.deploy.yml` переопределяет `image:` на готовые образы из Registry. Переменные передаются через environment shell (GitHub Secrets).\n+\n+---\n+\n+### 5.2 Анатомия команды деплоя\n+\n+Это ключевой раздел, объясняющий, как мы консолидируем разные задачи в один вызов команды Docker Compose.\n+\n+**Пример команды запуска Green стека в Production:**\n+\n+```bash\n+# 1. ENV VARIABLES (Secrets & Config)\n+STACK_NAME=app\n+COLOR=green\n+STACK_PORT=8082\n+OPENAI_API_KEY=sk-...",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590983708",
      "id": 2590983708,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "если ты исполтьзуешь -e для передачи переменных, контейнеры видят их напрямую и не надо их перечислять в `environment:`. Но и при этом их нельзя использовать в интерполяциях внутри docker-compose. Я предлагаю разделить переменные на те, которые нужны в контейнере  (передаем их через -e) и на те, что нужны в конфигурации композа (передаем их как STACK_COLOR=green docker-compose up). Надо определить какие переменные нам необходимы внутри файла докер-композ, а какие только внутри контейнеров\r\n\r\nЭто значительно облегчит введение новых енв-переменных для приложения, если их не надо будет обьявлять внутри докер-композа. Просто задаем их в гитхаб енвайромент переменных, они все пробрасываются в контейнер через -e. \r\n",
      "created_at": "2025-12-05T00:09:40Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+_Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Сетевая изоляция:** Каждый стек (Blue/Green) запускается в своей собственной изолированной Docker-сети (`default` network проекта). Стеки не видят друг друга и не пересекаются по DNS-именам. Связь с Edge осуществляется через проброс портов на хост.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека в состоянии `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию upstream, переключая трафик на порт хоста (`STACK_PORT`), соответствующий новому стеку (Port-based Routing).\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App\n+```\n+\n+**Как работает наслаивание:**\n+\n+- **Локальная разработка:** Используется команда `docker compose -f docker-compose.app.yml up`. Используется только базовый файл. Переменные окружения берутся из `.env` файла автоматически.\n+- **Production деплой:** Используется цепочка файлов. Файл `.deploy.yml` переопределяет `image:` на готовые образы из Registry. Переменные передаются через environment shell (GitHub Secrets).\n+\n+---\n+\n+### 5.2 Анатомия команды деплоя\n+\n+Это ключевой раздел, объясняющий, как мы консолидируем разные задачи в один вызов команды Docker Compose.\n+\n+**Пример команды запуска Green стека в Production:**\n+\n+```bash\n+# 1. ENV VARIABLES (Secrets & Config)\n+STACK_NAME=app\n+COLOR=green\n+STACK_PORT=8082\n+OPENAI_API_KEY=sk-...\n+# 2. COMMAND\n+docker compose \\\n+  # 3. LAYERING\n+  -f docker-compose.app.yml \\         # База (структура сервисов)\n+  -f docker-compose.app.deploy.yml \\  # Prod Override (образы из registry)\n+  # 4. ISOLATION\n+  -p ${STACK_NAME}-${COLOR} \\         # Project Name (напр. app-green)\n+  # 5. ACTION\n+  up -d --wait\n+```\n+\n+**Разбор компонентов:**\n+\n+1.  **ENV VARIABLES:**\n+    - Передаются **перед** командой или через экспорт в shell.\n+    - `STACK_NAME` и `COLOR` определяют имя проекта.\n+    - `STACK_PORT` задает внешний порт для Nginx Internal текущего цвета.\n+    - Внутри `docker-compose.yml` переменные подставляются в секции `environment:` и `ports:`.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2590993337",
      "id": 2590993337,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "Тут неправда. Если ты не укажешь build/image вместе в обычном стеке, то комопз не будет знать куда пушить эти имеджи и не узнает откуда пулить их для кеширования слоев. \r\n\r\nНужно ли вообще что-то менять? ИМХО легче воспользоваться флагом `docker compose up --no-build` чтоб не билдить  на продакшене. Сам УМЛ слой может все еще полезен для какой-то доп. конфигурации, не знаю.",
      "created_at": "2025-12-05T00:13:36Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+_Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Сетевая изоляция:** Каждый стек (Blue/Green) запускается в своей собственной изолированной Docker-сети (`default` network проекта). Стеки не видят друг друга и не пересекаются по DNS-именам. Связь с Edge осуществляется через проброс портов на хост.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека в состоянии `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию upstream, переключая трафик на порт хоста (`STACK_PORT`), соответствующий новому стеку (Port-based Routing).\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App\n+```\n+\n+**Как работает наслаивание:**\n+\n+- **Локальная разработка:** Используется команда `docker compose -f docker-compose.app.yml up`. Используется только базовый файл. Переменные окружения берутся из `.env` файла автоматически.\n+- **Production деплой:** Используется цепочка файлов. Файл `.deploy.yml` переопределяет `image:` на готовые образы из Registry. Переменные передаются через environment shell (GitHub Secrets).\n+\n+---\n+\n+### 5.2 Анатомия команды деплоя\n+\n+Это ключевой раздел, объясняющий, как мы консолидируем разные задачи в один вызов команды Docker Compose.\n+\n+**Пример команды запуска Green стека в Production:**\n+\n+```bash\n+# 1. ENV VARIABLES (Secrets & Config)\n+STACK_NAME=app\n+COLOR=green\n+STACK_PORT=8082\n+OPENAI_API_KEY=sk-...\n+# 2. COMMAND\n+docker compose \\\n+  # 3. LAYERING\n+  -f docker-compose.app.yml \\         # База (структура сервисов)\n+  -f docker-compose.app.deploy.yml \\  # Prod Override (образы из registry)\n+  # 4. ISOLATION\n+  -p ${STACK_NAME}-${COLOR} \\         # Project Name (напр. app-green)\n+  # 5. ACTION\n+  up -d --wait\n+```\n+\n+**Разбор компонентов:**\n+\n+1.  **ENV VARIABLES:**\n+    - Передаются **перед** командой или через экспорт в shell.\n+    - `STACK_NAME` и `COLOR` определяют имя проекта.\n+    - `STACK_PORT` задает внешний порт для Nginx Internal текущего цвета.\n+    - Внутри `docker-compose.yml` переменные подставляются в секции `environment:` и `ports:`.\n+\n+2.  **LAYERING (`-f ...`):**\n+    - Мы собираем итоговый конфиг из кусочков.\n+    - `app.deploy.yml` заменяет `build: .` на `image: registry/...`.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2591001465",
      "id": 2591001465,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "надо указывать еще build.cache_from для кеширования\r\n\r\n    build:\r\n      context: .\r\n      cache_from:\r\n        - my-registry.com/myapp:latest",
      "created_at": "2025-12-05T00:15:20Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2591003984",
      "id": 2591003984,
      "in_reply_to_id": 2591001465,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "это позволяет еще запустить несколько инвайроментов рядом друг с другом (стейджинг и дев)",
      "created_at": "2025-12-05T00:14:03Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+_Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Сетевая изоляция:** Каждый стек (Blue/Green) запускается в своей собственной изолированной Docker-сети (`default` network проекта). Стеки не видят друг друга и не пересекаются по DNS-именам. Связь с Edge осуществляется через проброс портов на хост.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека в состоянии `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию upstream, переключая трафик на порт хоста (`STACK_PORT`), соответствующий новому стеку (Port-based Routing).\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App\n+```\n+\n+**Как работает наслаивание:**\n+\n+- **Локальная разработка:** Используется команда `docker compose -f docker-compose.app.yml up`. Используется только базовый файл. Переменные окружения берутся из `.env` файла автоматически.\n+- **Production деплой:** Используется цепочка файлов. Файл `.deploy.yml` переопределяет `image:` на готовые образы из Registry. Переменные передаются через environment shell (GitHub Secrets).\n+\n+---\n+\n+### 5.2 Анатомия команды деплоя\n+\n+Это ключевой раздел, объясняющий, как мы консолидируем разные задачи в один вызов команды Docker Compose.\n+\n+**Пример команды запуска Green стека в Production:**\n+\n+```bash\n+# 1. ENV VARIABLES (Secrets & Config)\n+STACK_NAME=app\n+COLOR=green\n+STACK_PORT=8082\n+OPENAI_API_KEY=sk-...\n+# 2. COMMAND\n+docker compose \\\n+  # 3. LAYERING\n+  -f docker-compose.app.yml \\         # База (структура сервисов)\n+  -f docker-compose.app.deploy.yml \\  # Prod Override (образы из registry)\n+  # 4. ISOLATION\n+  -p ${STACK_NAME}-${COLOR} \\         # Project Name (напр. app-green)\n+  # 5. ACTION\n+  up -d --wait\n+```\n+\n+**Разбор компонентов:**\n+\n+1.  **ENV VARIABLES:**\n+    - Передаются **перед** командой или через экспорт в shell.\n+    - `STACK_NAME` и `COLOR` определяют имя проекта.\n+    - `STACK_PORT` задает внешний порт для Nginx Internal текущего цвета.\n+    - Внутри `docker-compose.yml` переменные подставляются в секции `environment:` и `ports:`.\n+\n+2.  **LAYERING (`-f ...`):**\n+    - Мы собираем итоговый конфиг из кусочков.\n+    - `app.deploy.yml` заменяет `build: .` на `image: registry/...`.\n+\n+3.  **ISOLATION (`-p ...`):**\n+    - Задает **Project Name** в формате `${STACK_NAME}-${COLOR}`.\n+    - Все контейнеры получат соответствующий префикс (например, `app-green-`).\n+    - Это критично для Blue-Green: позволяет запустить _вторую_ копию тех же самых сервисов параллельно с первой (`app-blue`), не вызывая конфликта имен.",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2591002082",
      "id": 2591002082,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "еще --parallel всегда\r\nеще --no-build на продакшене\r\n",
      "created_at": "2025-12-05T00:14:59Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+_Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Сетевая изоляция:** Каждый стек (Blue/Green) запускается в своей собственной изолированной Docker-сети (`default` network проекта). Стеки не видят друг друга и не пересекаются по DNS-именам. Связь с Edge осуществляется через проброс портов на хост.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека в состоянии `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию upstream, переключая трафик на порт хоста (`STACK_PORT`), соответствующий новому стеку (Port-based Routing).\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App\n+```\n+\n+**Как работает наслаивание:**\n+\n+- **Локальная разработка:** Используется команда `docker compose -f docker-compose.app.yml up`. Используется только базовый файл. Переменные окружения берутся из `.env` файла автоматически.\n+- **Production деплой:** Используется цепочка файлов. Файл `.deploy.yml` переопределяет `image:` на готовые образы из Registry. Переменные передаются через environment shell (GitHub Secrets).\n+\n+---\n+\n+### 5.2 Анатомия команды деплоя\n+\n+Это ключевой раздел, объясняющий, как мы консолидируем разные задачи в один вызов команды Docker Compose.\n+\n+**Пример команды запуска Green стека в Production:**\n+\n+```bash\n+# 1. ENV VARIABLES (Secrets & Config)\n+STACK_NAME=app\n+COLOR=green\n+STACK_PORT=8082\n+OPENAI_API_KEY=sk-...\n+# 2. COMMAND\n+docker compose \\\n+  # 3. LAYERING\n+  -f docker-compose.app.yml \\         # База (структура сервисов)\n+  -f docker-compose.app.deploy.yml \\  # Prod Override (образы из registry)\n+  # 4. ISOLATION\n+  -p ${STACK_NAME}-${COLOR} \\         # Project Name (напр. app-green)\n+  # 5. ACTION\n+  up -d --wait\n+```\n+\n+**Разбор компонентов:**\n+\n+1.  **ENV VARIABLES:**\n+    - Передаются **перед** командой или через экспорт в shell.\n+    - `STACK_NAME` и `COLOR` определяют имя проекта.\n+    - `STACK_PORT` задает внешний порт для Nginx Internal текущего цвета.\n+    - Внутри `docker-compose.yml` переменные подставляются в секции `environment:` и `ports:`.\n+\n+2.  **LAYERING (`-f ...`):**\n+    - Мы собираем итоговый конфиг из кусочков.\n+    - `app.deploy.yml` заменяет `build: .` на `image: registry/...`.\n+\n+3.  **ISOLATION (`-p ...`):**\n+    - Задает **Project Name** в формате `${STACK_NAME}-${COLOR}`.\n+    - Все контейнеры получат соответствующий префикс (например, `app-green-`).\n+    - Это критично для Blue-Green: позволяет запустить _вторую_ копию тех же самых сервисов параллельно с первой (`app-blue`), не вызывая конфликта имен.\n+\n+4.  **ACTION (`up -d --wait`):**",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2591003359",
      "id": 2591003359,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "--build на локальном пресете всегда чтоб он перебилдивал то что нужно",
      "created_at": "2025-12-05T00:17:08Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2591006477",
      "id": 2591006477,
      "in_reply_to_id": 2591003359,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "диаграма неправильная, звучит как едж может быть зарелизен без тестирования. Шаг тестирования общий на оба стека. Это тестирование всего монорепо",
      "created_at": "2025-12-05T00:18:28Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+_Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Сетевая изоляция:** Каждый стек (Blue/Green) запускается в своей собственной изолированной Docker-сети (`default` network проекта). Стеки не видят друг друга и не пересекаются по DNS-именам. Связь с Edge осуществляется через проброс портов на хост.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека в состоянии `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию upstream, переключая трафик на порт хоста (`STACK_PORT`), соответствующий новому стеку (Port-based Routing).\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App\n+```\n+\n+**Как работает наслаивание:**\n+\n+- **Локальная разработка:** Используется команда `docker compose -f docker-compose.app.yml up`. Используется только базовый файл. Переменные окружения берутся из `.env` файла автоматически.\n+- **Production деплой:** Используется цепочка файлов. Файл `.deploy.yml` переопределяет `image:` на готовые образы из Registry. Переменные передаются через environment shell (GitHub Secrets).\n+\n+---\n+\n+### 5.2 Анатомия команды деплоя\n+\n+Это ключевой раздел, объясняющий, как мы консолидируем разные задачи в один вызов команды Docker Compose.\n+\n+**Пример команды запуска Green стека в Production:**\n+\n+```bash\n+# 1. ENV VARIABLES (Secrets & Config)\n+STACK_NAME=app\n+COLOR=green\n+STACK_PORT=8082\n+OPENAI_API_KEY=sk-...\n+# 2. COMMAND\n+docker compose \\\n+  # 3. LAYERING\n+  -f docker-compose.app.yml \\         # База (структура сервисов)\n+  -f docker-compose.app.deploy.yml \\  # Prod Override (образы из registry)\n+  # 4. ISOLATION\n+  -p ${STACK_NAME}-${COLOR} \\         # Project Name (напр. app-green)\n+  # 5. ACTION\n+  up -d --wait\n+```\n+\n+**Разбор компонентов:**\n+\n+1.  **ENV VARIABLES:**\n+    - Передаются **перед** командой или через экспорт в shell.\n+    - `STACK_NAME` и `COLOR` определяют имя проекта.\n+    - `STACK_PORT` задает внешний порт для Nginx Internal текущего цвета.\n+    - Внутри `docker-compose.yml` переменные подставляются в секции `environment:` и `ports:`.\n+\n+2.  **LAYERING (`-f ...`):**\n+    - Мы собираем итоговый конфиг из кусочков.\n+    - `app.deploy.yml` заменяет `build: .` на `image: registry/...`.\n+\n+3.  **ISOLATION (`-p ...`):**\n+    - Задает **Project Name** в формате `${STACK_NAME}-${COLOR}`.\n+    - Все контейнеры получат соответствующий префикс (например, `app-green-`).\n+    - Это критично для Blue-Green: позволяет запустить _вторую_ копию тех же самых сервисов параллельно с первой (`app-blue`), не вызывая конфликта имен.\n+\n+4.  **ACTION (`up -d --wait`):**\n+    - `--wait`: Самый важный флаг для Atomic Deployment. Compose ждет, пока ВСЕ healthcheck'и пройдут (станут `healthy`).\n+    - Если хоть один сервис не взлетел — команда возвращает exit code 1. CI останавливает деплой. Трафик не переключается.\n+\n+---\n+\n+### 5.3 Blue-Green скрипты\n+\n+```\n+scripts/blue-green/\n+├── switch.sh   # Переключение трафика между blue/green\n+└── deploy.sh   # Полный цикл деплоя\n+```\n+\n+**Использование:**\n+\n+```bash\n+# Показать текущий статус\n+./scripts/blue-green/switch.sh status\n+\n+# Переключить трафик на green\n+./scripts/blue-green/switch.sh green\n+\n+# Переключить на противоположный стек\n+./scripts/blue-green/switch.sh toggle\n+\n+# Полный цикл деплоя (запуск нового стека + переключение + остановка старого)\n+./scripts/blue-green/deploy.sh\n+\n+# Деплой без остановки старого стека\n+./scripts/blue-green/deploy.sh --skip-cleanup\n+```\n+\n+### 5.4 Механизм переключения трафика\n+\n+Nginx Edge использует симлинк для определения активного upstream. Мы используем подход с разными портами для разных цветов стека (Port-based Routing), обращаясь к ним через IP хоста Docker.\n+\n+```\n+/etc/nginx/conf.d/\n+├── 00-upstream.conf -> upstream-blue.conf    # Симлинк (источник правды)\n+├── upstream-blue.conf                        # upstream app_backend { server 127.0.0.1:8081; }\n+├── upstream-green.conf                       # upstream app_backend { server 127.0.0.1:8082; }\n+└── default.conf                              # Server блоки с proxy_pass http://app_backend\n+```\n+\n+**Переключение:**\n+\n+1. `ln -sf upstream-green.conf 00-upstream.conf` — атомарная смена симлинка\n+2. `nginx -s reload` — graceful перезагрузка (без прерывания соединений)\n+\n+### 5.5 GitHub Actions Workflow\n+\n+Файл: `.github/workflows/deploy-blue-green.yml`\n+\n+**Jobs:**\n+\n+| Job                     | Описание                                              | Когда запускается                  |\n+|-------------------------|-------------------------------------------------------|------------------------------------|\n+| `determine-environment` | Определяет окружение (production/staging/development) | Всегда                             |\n+| `build`                 | Собирает все Docker образы (Edge + App)               | Всегда                             |\n+| `test`                  | Запускает тесты                                       | Если не skip-tests                 |\n+| `release`               | Тегирует образы стабильным тегом                      | После успешных тестов, только push |\n+| `deploy-edge`           | Деплоит инфраструктуру (БД, Temporal, nginx-edge)     | Только при `deploy-edge: true`     |\n+| `deploy-app`            | **Blue-Green деплой** приложения                      | После release, автоматически       |\n+\n+**Workflow:**\n+\n+```\n+push to main/staging/development\n+        │\n+        ↓\n+┌───────────────────┐\n+│ determine-env     │\n+└───────────────────┘\n+     │\n+     ├──────────────────────────────────────────┐\n+     ▼                                          ▼\n+┌───────────────────┐                      ┌───────────────────┐\n+│ build-app         │ (ВСЕГДА)             │ build-edge        │ (РУЧНОЙ / CONDITIONAL)\n+│ (nginx-app, core) │                      │ (DB, Edge Nginx)  │\n+└───────────────────┘                      └───────────────────┘\n+     │                                          │\n+     ▼                                          ▼\n+┌───────────────────┐                      ┌───────────────────┐\n+│ test & release    │                      │ release-edge      │",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2591008758",
      "id": 2591008758,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "если мы делаем деплой и управление машиной через экшены/ранер, то нам надо будет разбить шаг деплоя на:\r\n\r\n1) boostrap-server - устанавливаем докер, etc\r\n2) update-app (STACK_NAME=idealic-production) - пулим имеджи, убеждаемся что докер композ не взорвался\r\n3) start-app (STACK_NAME=idealic-production STACK_COLOR=green) - стартуем приложение\r\n4) switch-app (STACK_NAME=idealic-production STACK_COLOR=green) - переключаем нжинкс\r\n5) stop-app (STACK_NAME=idealic-production STACK_COLOR=blue) \r\n\r\nТогда эти таски можно будет запускать вручную тоже. Например при перезагрузке сервера стартануть приложение. \r\n",
      "created_at": "2025-12-05T00:22:12Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+_Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Сетевая изоляция:** Каждый стек (Blue/Green) запускается в своей собственной изолированной Docker-сети (`default` network проекта). Стеки не видят друг друга и не пересекаются по DNS-именам. Связь с Edge осуществляется через проброс портов на хост.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека в состоянии `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию upstream, переключая трафик на порт хоста (`STACK_PORT`), соответствующий новому стеку (Port-based Routing).\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App\n+```\n+\n+**Как работает наслаивание:**\n+\n+- **Локальная разработка:** Используется команда `docker compose -f docker-compose.app.yml up`. Используется только базовый файл. Переменные окружения берутся из `.env` файла автоматически.\n+- **Production деплой:** Используется цепочка файлов. Файл `.deploy.yml` переопределяет `image:` на готовые образы из Registry. Переменные передаются через environment shell (GitHub Secrets).\n+\n+---\n+\n+### 5.2 Анатомия команды деплоя\n+\n+Это ключевой раздел, объясняющий, как мы консолидируем разные задачи в один вызов команды Docker Compose.\n+\n+**Пример команды запуска Green стека в Production:**\n+\n+```bash\n+# 1. ENV VARIABLES (Secrets & Config)\n+STACK_NAME=app\n+COLOR=green\n+STACK_PORT=8082\n+OPENAI_API_KEY=sk-...\n+# 2. COMMAND\n+docker compose \\\n+  # 3. LAYERING\n+  -f docker-compose.app.yml \\         # База (структура сервисов)\n+  -f docker-compose.app.deploy.yml \\  # Prod Override (образы из registry)\n+  # 4. ISOLATION\n+  -p ${STACK_NAME}-${COLOR} \\         # Project Name (напр. app-green)\n+  # 5. ACTION\n+  up -d --wait\n+```\n+\n+**Разбор компонентов:**\n+\n+1.  **ENV VARIABLES:**\n+    - Передаются **перед** командой или через экспорт в shell.\n+    - `STACK_NAME` и `COLOR` определяют имя проекта.\n+    - `STACK_PORT` задает внешний порт для Nginx Internal текущего цвета.\n+    - Внутри `docker-compose.yml` переменные подставляются в секции `environment:` и `ports:`.\n+\n+2.  **LAYERING (`-f ...`):**\n+    - Мы собираем итоговый конфиг из кусочков.\n+    - `app.deploy.yml` заменяет `build: .` на `image: registry/...`.\n+\n+3.  **ISOLATION (`-p ...`):**\n+    - Задает **Project Name** в формате `${STACK_NAME}-${COLOR}`.\n+    - Все контейнеры получат соответствующий префикс (например, `app-green-`).\n+    - Это критично для Blue-Green: позволяет запустить _вторую_ копию тех же самых сервисов параллельно с первой (`app-blue`), не вызывая конфликта имен.\n+\n+4.  **ACTION (`up -d --wait`):**\n+    - `--wait`: Самый важный флаг для Atomic Deployment. Compose ждет, пока ВСЕ healthcheck'и пройдут (станут `healthy`).\n+    - Если хоть один сервис не взлетел — команда возвращает exit code 1. CI останавливает деплой. Трафик не переключается.\n+\n+---\n+\n+### 5.3 Blue-Green скрипты\n+\n+```\n+scripts/blue-green/\n+├── switch.sh   # Переключение трафика между blue/green\n+└── deploy.sh   # Полный цикл деплоя\n+```\n+\n+**Использование:**\n+\n+```bash\n+# Показать текущий статус\n+./scripts/blue-green/switch.sh status\n+\n+# Переключить трафик на green\n+./scripts/blue-green/switch.sh green\n+\n+# Переключить на противоположный стек\n+./scripts/blue-green/switch.sh toggle\n+\n+# Полный цикл деплоя (запуск нового стека + переключение + остановка старого)\n+./scripts/blue-green/deploy.sh\n+\n+# Деплой без остановки старого стека\n+./scripts/blue-green/deploy.sh --skip-cleanup\n+```\n+\n+### 5.4 Механизм переключения трафика\n+\n+Nginx Edge использует симлинк для определения активного upstream. Мы используем подход с разными портами для разных цветов стека (Port-based Routing), обращаясь к ним через IP хоста Docker.\n+\n+```\n+/etc/nginx/conf.d/\n+├── 00-upstream.conf -> upstream-blue.conf    # Симлинк (источник правды)\n+├── upstream-blue.conf                        # upstream app_backend { server 127.0.0.1:8081; }\n+├── upstream-green.conf                       # upstream app_backend { server 127.0.0.1:8082; }\n+└── default.conf                              # Server блоки с proxy_pass http://app_backend\n+```\n+\n+**Переключение:**\n+\n+1. `ln -sf upstream-green.conf 00-upstream.conf` — атомарная смена симлинка\n+2. `nginx -s reload` — graceful перезагрузка (без прерывания соединений)\n+\n+### 5.5 GitHub Actions Workflow\n+\n+Файл: `.github/workflows/deploy-blue-green.yml`\n+\n+**Jobs:**\n+\n+| Job                     | Описание                                              | Когда запускается                  |\n+|-------------------------|-------------------------------------------------------|------------------------------------|\n+| `determine-environment` | Определяет окружение (production/staging/development) | Всегда                             |\n+| `build`                 | Собирает все Docker образы (Edge + App)               | Всегда                             |\n+| `test`                  | Запускает тесты                                       | Если не skip-tests                 |\n+| `release`               | Тегирует образы стабильным тегом                      | После успешных тестов, только push |\n+| `deploy-edge`           | Деплоит инфраструктуру (БД, Temporal, nginx-edge)     | Только при `deploy-edge: true`     |\n+| `deploy-app`            | **Blue-Green деплой** приложения                      | После release, автоматически       |\n+\n+**Workflow:**\n+\n+```\n+push to main/staging/development\n+        │\n+        ↓\n+┌───────────────────┐\n+│ determine-env     │\n+└───────────────────┘\n+     │\n+     ├──────────────────────────────────────────┐\n+     ▼                                          ▼\n+┌───────────────────┐                      ┌───────────────────┐\n+│ build-app         │ (ВСЕГДА)             │ build-edge        │ (РУЧНОЙ / CONDITIONAL)\n+│ (nginx-app, core) │                      │ (DB, Edge Nginx)  │\n+└───────────────────┘                      └───────────────────┘\n+     │                                          │\n+     ▼                                          ▼\n+┌───────────────────┐                      ┌───────────────────┐\n+│ test & release    │                      │ release-edge      │\n+└───────────────────┘                      └───────────────────┘\n+     │                                          │\n+     ▼                                          ▼\n+┌───────────────────┐                      ┌───────────────────┐\n+│ deploy-app        │                      │ deploy-edge       │",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2591014953",
      "id": 2591014953,
      "in_reply_to_id": null,
      "user": "Inviz"
    },
    {
      "body": "обьяснить что шаги деплоя запускаются через раннер на сервере, то есть это таргетированый запуск экшенов на нужном сервере. Код этих \"скриптов\" хранится напрямую в гитхаб экшенах, а не разбросан по файлам. Кроме того этот код не зависим от приложения, не надо спуливать чтоб иметь доступ к scripts/switch.sh и т д",
      "created_at": "2025-12-05T00:24:02Z",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2591017469",
      "id": 2591017469,
      "in_reply_to_id": 2591014953,
      "user": "Inviz"
    }
  ],
  [
    {
      "body": "6.4 Раннер на сервере",
      "created_at": "2025-12-05T00:28:43Z",
      "diff_hunk": "@@ -3,70 +3,359 @@\n Этот документ является **главным архитектурным документом** для системы деплоя. Он описывает целевое состояние инфраструктуры и процессов поставки кода.\n Документ должен поддерживаться в актуальном состоянии (\"Evergreen\") и отражать текущий статус реализации компонентов.\n \n+---\n+\n+## Введение\n+\n+Наша система деплоя построена на Docker Compose. Архитектура разделена на два уровня стабильности:\n+\n+1.  **Application Services** (бизнес-логика): Обновляются часто, используют **стратегию Blue-Green Deployment** для обеспечения **Zero Downtime**.\n+2.  **Infrastructure Services** (Edge/DB): Обновляются редко, используют стратегию **Recreate**. Их обновление требует планового технического окна (Maintenance Window), так как они являются точкой входа.\n+\n+**Что такое Blue-Green Deployment?** Это техника, при которой второй изолированный стек («Green») запускается и инициализируется параллельно с текущим рабочим стеком («Blue»). Трафик переключается на новую версию только после успешной проверки её работоспособности внутри сети.\n+\n+**Как работает деплой в нашей системе:**\n+\n+1.  GitHub Actions инициирует процесс (CI).\n+2.  Docker-образы приложения (app) собираются при каждом пуше. Образы инфраструктуры (edge) — только по требованию.\n+3.  **Запуск тестов:** Автоматически прогоняются тесты. Мы деплоим только те образы, которые успешно прошли проверку.\n+4.  **Docker Registry:** Протестированные образы пушатся в приватный регистр. Это гарантирует, что на сервере будет запущен ровно тот же код (по хешу образа), что и был протестирован.\n+5.  Self-hosted Runner на сервере скачивает эти готовые образы из Registry.\n+6.  Для Application-сервисов запускается новый \"цветной\" стек.\n+7.  Edge Nginx переключает проксирование на хостнейм нового активного стека.\n+\n+---\n+\n ## 1. Философия и Цели\n \n-*   **Zero Downtime:** Деплой никогда не должен прерывать обслуживание пользователей.\n-*   **Immutability & Integrity:** Мы деплоим *только* те Docker-образы, которые были собраны и протестированы на CI. Образ, прошедший тесты — это тот же образ, который летит в продакшн.\n-*   **Atomic Deployment:** Запуск новой версии приложения — атомарная операция. Либо запускается *всё* и проходят *все* проверки, либо не запускается *ничего*.\n-*   **Docker Compose Native:** Вся логика оркестрации, зависимостей и health-check'ов инкапсулирована в Docker Compose. GitHub Actions выступает только как триггер и поставщик секретов, не содержа бизнес-логики запуска.\n+- **Zero Downtime (для App):** Деплой бизнес-логики не должен прерывать обслуживание пользователей.\n+- **Стабильность Edge:** Инфраструктурный слой (БД, входной Nginx) меняется редко и консервативно, чтобы минимизировать риски глобальных сбоев.\n+- **Неизменность (Immutability):** Мы деплоим _только_ те Docker-образы, которые были собраны и протестированы на CI.\n+- **Нативность Docker Compose:** Вся логика оркестрации инкапсулирована в Compose. GitHub Actions выступает только как триггер.\n+- **Runner-driven Execution:** Деплой-процесс не требует входящего SSH-доступа. GitHub Runner на сервере выполняет команды локально. SSH используется исключительно для ручного администрирования и отладки, но не для автоматической доставки кода.\n+- **Централизованная конфигурация:** Единый источник истины для секретов и параметров стека (включая порты и имена) — GitHub Actions. Никаких `.env` файлов на диске сервера.\n+- **Минимальный Bootstrap:** Инициализация нового сервера требует только установки Docker и регистрации GitHub Runner. Вся дальнейшая настройка (конфигурация, скрипты, структуры папок) выполняется автоматически через GitHub Actions.\n+\n+## 2. Инварианты Docker Compose\n \n-## 2. Разделение Экосистемы (Edge vs App)\n+Правила, которые являются обязательными для нашей системы деплоя:\n+\n+1.  **Конфигурация через ENV:** Все параметры, отличающие окружения (dev/prod) и цвета (blue/green), передаются через переменные окружения (`COLOR`, `APP_ENV`).\n+2.  **Изоляция стеков:** Мы используем **Project Name** (`-p`) в формате `${STACK_NAME}-${COLOR}` для логического разделения стеков. Это создает уникальные префиксы для имен контейнеров (напр. `app-green-...`) и позволяет запускать параллельно не только Blue/Green версии, но и разные окружения (development/staging/production) на одном сервере.\n+3.  **Только Compose:** Все операции с образами (pull, up, down) выполняются только через `docker compose`.\n+4.  **Профили (Profiles):** Включение опциональных сервисов (например, `acme-sh` для SSL) управляется через `--profile`.\n+5.  **Максимальный параллелизм:** Сборка и пуш образов выполняются параллельно для ускорения CI.\n+\n+## 3. Разделение Экосистемы (Edge vs App)\n \n Система четко разделена на два контура жизненного цикла.\n \n-### A. Infrastructure Services (Edge)\n-Сервисы, которые меняются крайне редко, хранят состояние (Stateful) или являются инфраструктурным фундаментом. Они **не** участвуют в Blue-Green деплое и обновляются отдельно (Maintenance Window).\n+### A. Инфраструктурные сервисы (Infrastructure Services / Edge)\n+\n+**Файл:** `docker-compose.edge.yml`\n+\n+Фундамент системы. Не участвуют в Blue-Green. Обновление требует кратковременной остановки трафика (reload или restart nginx-edge).\n+\n+_Характеристика обновлений: Редкие, ручные, плановые (Maintenance Window)._\n+_Примечание: Отсутствие Zero Downtime для инфраструктуры — это осознанный компромисс на текущем этапе. Наш приоритет — бесшовное обновление бизнес-логики (App), которая меняется часто._\n+\n+- **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL.\n+- **SSL Certs** (`acme-sh`): Управление сертификатами (см. Приложение A).\n+- **Database**:\n+    - **TimescaleDB** (Postgres с расширениями).\n+    - **PgBouncer** (пулер соединений).\n+    - **Vectorizer** (AI vector embeddings).\n+- **Temporal Platform**:\n+    - **Temporal Server**.\n+    - **Temporal UI**.\n+    - **Temporal Admin Tools**.\n+- **Health Check** (health-check): Сервис для внешнего мониторинга доступности компонентов.\n \n-*Статус: Стабильные контейнеры*\n+### B. Сервисы приложения (App / Blue-Green)\n \n-*   **Edge Nginx** (`nginx-edge`): Входная точка, терминация SSL, сертификаты (Acme.sh).\n-*   **Database**:\n-    *   **TimescaleDB** (Postgres с расширениями).\n-    *   **PgBouncer**.\n-    *   **Vectorizer**.\n-*   **Temporal Platform**:\n-    *   Temporal Server.\n-    *   Temporal UI.\n-    *   Temporal Admin Tools.\n-*   **Monitoring**: Общие сервисы проверки здоровья (если вынесены отдельно).\n+**Файл:** `docker-compose.app.yml`\n \n-### B. Application Services (App / Blue-Green)\n Бизнес-сервисы, которые нужно передеплоивать часто и без даунтайма. Они Stateless (насколько это возможно). Именно они являются объектом **Blue-Green Deployment**.\n \n-*Статус: Динамические контейнеры*\n+_Характеристика обновлений: Частые, автоматические, без простоя._\n \n-*   **Internal Nginx** (`nginx-app`): Маршрутизатор внутри \"цветного\" (Blue/Green) контура.\n-*   **Poker Runtime** (`poker-runtime`): Игровой движок.\n-*   Любые другие микросервисы из Monorepo.\n+- **Internal Nginx** (`nginx-app-${COLOR}`): Внутренний роутер цветного стека.\n+- **Poker Runtime** (`poker-runtime-${COLOR}`): Игровой движок.\n \n ---\n \n-## 3. Стратегия Blue-Green Deployment\n+## 4. Стратегия Blue-Green Deployment\n \n-Процесс обновления **Application Services** выглядит так:\n+Процесс обновления **Application Services**:\n \n-1.  **Start Green:** Рядом с работающей \"Blue\" (текущей) версией запускается полная копия \"Green\" версии (новый стек Internal сервисов).\n-2.  **Health Check Validation:**\n-    *   Команда `docker compose up --wait` ожидает `healthy` статуса от всех контейнеров и **отваливается целиком**, если хотя бы один сервис не прошел проверку.\n-    *   Мы не проверяем каждый сервис отдельно — Docker Compose сам гарантирует атомарность: либо весь стек стартовал, либо команда завершилась с ошибкой. Деплой отменяется, трафик не переключается.\n-3.  **Traffic Switch:** Только после 100% готовности \"Green\" стека, происходит атомарное переключение трафика (через Edge Nginx или сервисный меш).\n-4.  **Cleanup:** После успешного переключения и стабилизации, \"Blue\" стек останавливается и удаляется.\n+1.  **Запуск Green:** Рядом с `nginx-app-blue` запускается `nginx-app-green`.\n+2.  **Сетевая изоляция:** Каждый стек (Blue/Green) запускается в своей собственной изолированной Docker-сети (`default` network проекта). Стеки не видят друг друга и не пересекаются по DNS-именам. Связь с Edge осуществляется через проброс портов на хост.\n+3.  **Проверка готовности:** `docker compose up --wait` гарантирует, что все сервисы Green-стека в состоянии `healthy`.\n+4.  **Переключение (Switch):** Edge Nginx обновляет конфигурацию upstream, переключая трафик на порт хоста (`STACK_PORT`), соответствующий новому стеку (Port-based Routing).\n+5.  **Очистка:** Старый Blue стек останавливается.\n \n-## 4. План Реализации (Roadmap & Status)\n+## 5. План реализации и статус\n \n Используйте эту таблицу для отслеживания прогресса внедрения видения.\n \n-| Компонент / Задача              | Статус          | Примечание                                                                    |\n-|:--------------------------------|:----------------|:------------------------------------------------------------------------------|\n-| **Artifact Building**           | 🟡 В процессе   | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n-| **Separation: Edge Services**  | 🔴 Не начато    | Выделение БД, Temporal и Edge Nginx в отдельный docker-compose.edge.yml.      |\n-| **Separation: App Services**   | 🔴 Не начато    | Poker Runtime и Internal Nginx в docker-compose.app.yml для атомарного запуска. |\n-| **Docker Compose Health Checks**| ⚪ Запланировано | Настройка строгих `depends_on` и `healthcheck` условий.                       |\n-| **Blue-Green Switch Logic**     | ⚪ Запланировано | Логика переключения через симлинки и nginx reload.                            |\n-| **GitHub Actions Deployment**   | ⚪ Запланировано | Реализация Blue/Green логики в GitHub Actions через SSH.                      |\n+| Компонент / Задача                    | Статус        | Примечание                                                                    |\n+|:--------------------------------------|:--------------|:------------------------------------------------------------------------------|\n+| **Сборка артефактов**                 | 🟡 В процессе | Сборка имиджей есть, нужно гарантировать использование тех же хешей в деплое. |\n+| **Разделение: Edge сервисы**          | ✅ Готово      | `docker-compose.edge.yml` + `docker-compose.edge.deploy.yml` (9 сервисов)     |\n+| **Разделение: App сервисы**           | ✅ Готово      | `docker-compose.app.yml` + `docker-compose.app.deploy.yml` (2 сервиса)        |\n+| **Проверки здоровья (Health Checks)** | 🟡 В процессе | Добавлены healthcheck в nginx-app и poker-runtime. Нужно протестировать.      |\n+| **Логика переключения Blue-Green**    | ✅ Готово      | `scripts/blue-green/switch.sh` + `deploy.sh`, nginx upstream симлинки.        |\n+| **Деплой через GitHub Actions**       | ✅ Готово      | `.github/workflows/deploy-blue-green.yml` с раздельным Edge/App деплоем.      |\n+\n+### 5.1 Структура файлов и наслаивание конфигураций\n+\n+Docker Compose поддерживает **наслаивание (merge) нескольких YAML-файлов**. Каждый следующий файл в цепочке `-f` переопределяет или дополняет предыдущий.\n+\n+**Файлы проекта:**\n+\n+```\n+docker-compose.edge.yml        # Базовая конфигурация Edge (9 сервисов)\n+docker-compose.edge.deploy.yml # Override: production-образы для Edge\n+docker-compose.app.yml         # Базовая конфигурация App (2 сервиса)\n+docker-compose.app.deploy.yml  # Override: production-образы для App\n+```\n+\n+**Как работает наслаивание:**\n+\n+- **Локальная разработка:** Используется команда `docker compose -f docker-compose.app.yml up`. Используется только базовый файл. Переменные окружения берутся из `.env` файла автоматически.\n+- **Production деплой:** Используется цепочка файлов. Файл `.deploy.yml` переопределяет `image:` на готовые образы из Registry. Переменные передаются через environment shell (GitHub Secrets).\n+\n+---\n+\n+### 5.2 Анатомия команды деплоя\n+\n+Это ключевой раздел, объясняющий, как мы консолидируем разные задачи в один вызов команды Docker Compose.\n+\n+**Пример команды запуска Green стека в Production:**\n+\n+```bash\n+# 1. ENV VARIABLES (Secrets & Config)\n+STACK_NAME=app\n+COLOR=green\n+STACK_PORT=8082\n+OPENAI_API_KEY=sk-...\n+# 2. COMMAND\n+docker compose \\\n+  # 3. LAYERING\n+  -f docker-compose.app.yml \\         # База (структура сервисов)\n+  -f docker-compose.app.deploy.yml \\  # Prod Override (образы из registry)\n+  # 4. ISOLATION\n+  -p ${STACK_NAME}-${COLOR} \\         # Project Name (напр. app-green)\n+  # 5. ACTION\n+  up -d --wait\n+```\n+\n+**Разбор компонентов:**\n+\n+1.  **ENV VARIABLES:**\n+    - Передаются **перед** командой или через экспорт в shell.\n+    - `STACK_NAME` и `COLOR` определяют имя проекта.\n+    - `STACK_PORT` задает внешний порт для Nginx Internal текущего цвета.\n+    - Внутри `docker-compose.yml` переменные подставляются в секции `environment:` и `ports:`.\n+\n+2.  **LAYERING (`-f ...`):**\n+    - Мы собираем итоговый конфиг из кусочков.\n+    - `app.deploy.yml` заменяет `build: .` на `image: registry/...`.\n+\n+3.  **ISOLATION (`-p ...`):**\n+    - Задает **Project Name** в формате `${STACK_NAME}-${COLOR}`.\n+    - Все контейнеры получат соответствующий префикс (например, `app-green-`).\n+    - Это критично для Blue-Green: позволяет запустить _вторую_ копию тех же самых сервисов параллельно с первой (`app-blue`), не вызывая конфликта имен.\n+\n+4.  **ACTION (`up -d --wait`):**\n+    - `--wait`: Самый важный флаг для Atomic Deployment. Compose ждет, пока ВСЕ healthcheck'и пройдут (станут `healthy`).\n+    - Если хоть один сервис не взлетел — команда возвращает exit code 1. CI останавливает деплой. Трафик не переключается.\n+\n+---\n+\n+### 5.3 Blue-Green скрипты\n+\n+```\n+scripts/blue-green/\n+├── switch.sh   # Переключение трафика между blue/green\n+└── deploy.sh   # Полный цикл деплоя\n+```\n+\n+**Использование:**\n+\n+```bash\n+# Показать текущий статус\n+./scripts/blue-green/switch.sh status\n+\n+# Переключить трафик на green\n+./scripts/blue-green/switch.sh green\n+\n+# Переключить на противоположный стек\n+./scripts/blue-green/switch.sh toggle\n+\n+# Полный цикл деплоя (запуск нового стека + переключение + остановка старого)\n+./scripts/blue-green/deploy.sh\n+\n+# Деплой без остановки старого стека\n+./scripts/blue-green/deploy.sh --skip-cleanup\n+```\n+\n+### 5.4 Механизм переключения трафика\n+\n+Nginx Edge использует симлинк для определения активного upstream. Мы используем подход с разными портами для разных цветов стека (Port-based Routing), обращаясь к ним через IP хоста Docker.\n+\n+```\n+/etc/nginx/conf.d/\n+├── 00-upstream.conf -> upstream-blue.conf    # Симлинк (источник правды)\n+├── upstream-blue.conf                        # upstream app_backend { server 127.0.0.1:8081; }\n+├── upstream-green.conf                       # upstream app_backend { server 127.0.0.1:8082; }\n+└── default.conf                              # Server блоки с proxy_pass http://app_backend\n+```\n+\n+**Переключение:**\n+\n+1. `ln -sf upstream-green.conf 00-upstream.conf` — атомарная смена симлинка\n+2. `nginx -s reload` — graceful перезагрузка (без прерывания соединений)\n+\n+### 5.5 GitHub Actions Workflow\n+\n+Файл: `.github/workflows/deploy-blue-green.yml`\n+\n+**Jobs:**\n+\n+| Job                     | Описание                                              | Когда запускается                  |\n+|-------------------------|-------------------------------------------------------|------------------------------------|\n+| `determine-environment` | Определяет окружение (production/staging/development) | Всегда                             |\n+| `build`                 | Собирает все Docker образы (Edge + App)               | Всегда                             |\n+| `test`                  | Запускает тесты                                       | Если не skip-tests                 |\n+| `release`               | Тегирует образы стабильным тегом                      | После успешных тестов, только push |\n+| `deploy-edge`           | Деплоит инфраструктуру (БД, Temporal, nginx-edge)     | Только при `deploy-edge: true`     |\n+| `deploy-app`            | **Blue-Green деплой** приложения                      | После release, автоматически       |\n+\n+**Workflow:**\n+\n+```\n+push to main/staging/development\n+        │\n+        ↓\n+┌───────────────────┐\n+│ determine-env     │\n+└───────────────────┘\n+     │\n+     ├──────────────────────────────────────────┐\n+     ▼                                          ▼\n+┌───────────────────┐                      ┌───────────────────┐\n+│ build-app         │ (ВСЕГДА)             │ build-edge        │ (РУЧНОЙ / CONDITIONAL)\n+│ (nginx-app, core) │                      │ (DB, Edge Nginx)  │\n+└───────────────────┘                      └───────────────────┘\n+     │                                          │\n+     ▼                                          ▼\n+┌───────────────────┐                      ┌───────────────────┐\n+│ test & release    │                      │ release-edge      │\n+└───────────────────┘                      └───────────────────┘\n+     │                                          │\n+     ▼                                          ▼\n+┌───────────────────┐                      ┌───────────────────┐\n+│ deploy-app        │                      │ deploy-edge       │\n+│ (Blue-Green)      │                      │ (Recreate)        │\n+└───────────────────┘                      └───────────────────┘\n+```\n+\n+- **deploy-app:** Запускается автоматически после успешных тестов. Выполняет `scripts/blue-green/deploy.sh`.\n+- **deploy-edge:** Запускается **только** если был изменен код в папках инфраструктуры или по ручному триггеру (`workflow_dispatch`).\n+\n+---\n+\n+## 6. Технические Детали\n+\n+### 6.1 Управление переменными окружения\n+\n+Секреты передаются строго в памяти процесса (`Secrets in Memory`). GitHub Runner инжектит их в процесс `docker compose` в момент запуска. На диске сервера секреты никогда не сохраняются.\n+\n+1.  **Локальная разработка:**\n+    - Docker Compose автоматически считывает файл `.env` в корне проекта.\n+    - Это удобно для разработчика, но **недопустимо** для продакшена.\n+\n+2.  **Production / Staging:**\n+    - Мы **НЕ создаем** `.env` файлы на сервере.\n+    - Все секреты хранятся в **GitHub Repo Secrets**.\n+    - GitHub Runner передает их как переменные окружения процессу `docker compose`.\n+    - Это гарантирует, что секреты не останутся на диске в открытом виде и их нельзя будет случайно прочитать или скопировать.\n+\n+**Почему так:**\n+\n+- Безопасность (нет файлов с паролями).\n+- Единая точка управления (GitHub).\n+- Аудит изменений.\n+\n+### 6.2 Docker Registry (хранилище образов)\n+\n+Мы используем **приватный Docker Registry** для хранения Docker-образов. Это платный сервис, который обеспечивает надёжное хранение и быструю доставку образов на сервера.\n+\n+**Как это работает:**\n+\n+1.  **CI собирает образы** → `docker compose build`\n+2.  **CI пушит образы** → `docker compose push`\n+3.  **После тестов** образ тегируется для окружения\n+4.  **Деплой скачивает** готовые образы → `docker compose pull`\n+\n+**Важно:**\n+\n+- **Деплой никогда не собирает код** — только скачивает готовые образы\n+- Образ, прошедший тесты на CI, идентичен образу в production (тот же SHA)\n+- Credentials для Registry передаются через GitHub Secrets\n+\n+### 6.3 Окружения (Environments)\n+\n+Система поддерживает несколько окружений. Конфигурация определяется комбинацией файлов (слоёв) и профилей.\n+\n+| Окружение       | Ветка         | Тег образов   | Слои (Compose Files)     | Профили      | Назначение               |\n+|:----------------|:--------------|:--------------|:-------------------------|:-------------|:-------------------------|\n+| **Local**       | -             | `local`       | `*.yml`                  | `local`      | Локальная разработка     |\n+| **Development** | `development` | `development` | `*.yml` + `*.deploy.yml` | `production` | Разработка, эксперименты |\n+| **Staging**     | `staging`     | `staging`     | `*.yml` + `*.deploy.yml` | `production` | Предпродакшн             |\n+| **Production**  | `main`        | `production`  | `*.yml` + `*.deploy.yml` | `production` | Боевой сервер            |\n+\n+**Как определяется окружение:**\n+\n+Job `determine-environment` в GitHub Actions анализирует имя ветки:\n+\n+```yaml\n+- if: github.ref == 'refs/heads/main'\n+  run: echo \"environment=production\" >> $GITHUB_OUTPUT\n+- if: github.ref == 'refs/heads/staging'\n+  run: echo \"environment=staging\" >> $GITHUB_OUTPUT\n+- if: github.ref == 'refs/heads/development'\n+  run: echo \"environment=development\" >> $GITHUB_OUTPUT\n+```\n+\n+---\n+\n+## Приложения",
      "html_url": "https://github.com/idealic-ai/platform/pull/65#discussion_r2591024393",
      "id": 2591024393,
      "in_reply_to_id": null,
      "user": "Inviz"
    }
  ]
]
