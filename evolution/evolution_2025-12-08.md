# Evolution Draft: 2025-12-08

> Status: Draft
> Source: https://github.com/idealic-ai/platform/pull/65

## Обзор

В рамках ревью PR #65 («Blue-Green Deployment Architecture») была проведена работа по уточнению архитектуры деплоя. Основной фокус сместился с использования SSH-доступа на модель **Runner-Driven Execution**, где деплой выполняется локально агентом GitHub Actions внутри периметра безопасности.

1.  **Чего хотел ревьюер:**
    - Полностью исключить ручное управление суффиксами контейнеров, возложив это на `project_name` и нативную изоляцию Docker Compose.
    - Внедрить жесткое разделение сетей (Network Isolation) между Blue и Green стеками, используя `host` порт-маппинг для маршрутизации трафика через Edge Nginx.
    - Стандартизировать передачу конфигурации через ENV-переменные (разделение переменных сборки и переменных контейнера).
    - Добавить обоснование выбора Docker Compose («Почему Compose?») и шаг тестирования как обязательный этап пайплайна.

2.  **С чем согласился автор:**
    - Переход на модель Pull-деплоя через Self-hosted Runner (без SSH).
    - Использование `project_name` (`${STACK_NAME}-${COLOR}`) для автоматического именования ресурсов.
    - Реализация изоляции сетей и переключения трафика через смену upstream портов в Nginx.
    - Стилистические правки (удаление «мы/вы», латинизмов).

3.  **Общий контекст:**
    - Подтверждено видение **Immutable Infrastructure**: образы собираются один раз, тестируются и пушатся в Registry. В продакшн идет тот же самый хеш образа.
    - Принято решение о разделении `Environment` переменных на те, что нужны для _оркестрации_ (в `docker-compose.yml`), и те, что нужны _внутри_ контейнера.

4.  **Недопонимания (если есть):**
    - Изначально было смешение понятий «сервер» и «раннер», но это разрешилось переходом на Runner-Driven модель.

## Список Намерений

### 1. Неизменность и Тестирование (Immutability & Testing)

- **Намерение:** Гарантировать, что деплоится именно тот код, который прошел тесты, и закрепить это в документации.
- **Обоснование:** Без явного шага тестирования и использования Registry есть риск собрать и задеплоить непроверенный код ("с места в карьер"). Деплой должен оперировать неизменяемыми артефактами.
- **Действие:** Добавить разделы «Запуск тестов» и «Docker Registry». Указать, что деплой использует хеши образов.
- **Статус:** Согласовано
- **Результат:** Документация обновлена, добавлен флоу сборки и тестирования перед деплоем.
- **Контекст:**
  > [Inviz](https://github.com/idealic-ai/platform/pull/65#discussion_r2586965160): "тут неплохо все-таки добавить шаг про тестирование... образы хранятся в регистри докера."
  >
  > [vyprik](https://github.com/idealic-ai/platform/pull/65#discussion_r2589827054): "Добавил: Запуск тестов... Docker Registry."

### 2. Модель исполнения (Runner-Driven Execution)

- **Намерение:** Отказаться от входящего SSH для деплоя в пользу Pull-модели через GitHub Runner.
- **Обоснование:** Повышение безопасности и упрощение архитектуры. Сервер не должен открывать порты. Раннер внутри сети сам забирает задачи и выполняет команды локально.
- **Действие:** Переписать раздел о механике деплоя, указав роль Self-hosted Runner. Уточнить, что SSH — только для ручной отладки.
- **Статус:** Согласовано
- **Результат:** Видение изменено на Runner-Driven.
- **Контекст:**
  > [Inviz](https://github.com/idealic-ai/platform/pull/65#discussion_r2586973615): "у нас поменялось видение и можем больше не заходить по ssh... Типа задеплоеный сервер - это ранер?"
  >
  > [vyprik](https://github.com/idealic-ai/platform/pull/65#discussion_r2589827464): "Добавил явное уточнение... GitHub Runner на сервере выполняет команды локально."

### 3. Автоматическая изоляция (Project Name & Naming)

- **Намерение:** Использовать встроенные механизмы Docker Compose (`project_name`) для генерации имен контейнеров вместо ручного прописывания суффиксов.
- **Обоснование:** Ручное управление именами (`poker-runtime-green`) порождает ошибки и дублирование. Флаг `-p` (project name) автоматически создает пространство имен (namespace) для всех ресурсов стека.
- **Действие:** Заменить примеры с ручными суффиксами на использование `-p ${STACK_NAME}-${COLOR}`.
- **Статус:** Согласовано
- **Результат:** Конфигурация упрощена, перенесена ответственность на Docker Compose.
- **Контекст:**
  > [Inviz](https://github.com/idealic-ai/platform/pull/65#discussion_r2586976595): "суффиксы мы не задаем вручную. Project name задает префиксы автоматически"
  >
  > [vyprik](https://github.com/idealic-ai/platform/pull/65#discussion_r2589827706): "Заменил на: Изоляция стеков: Мы используем Project Name..."

### 4. Сетевая изоляция (Network Isolation)

- **Намерение:** Полностью изолировать сети Blue и Green стеков друг от друга.
- **Обоснование:** Безопасность и предотвращение конфликтов имен. Стеки не должны «видеть» друг друга по DNS. Взаимодействие с внешним миром (Edge) должно идти через четко определенный интерфейс (порты хоста).
- **Действие:** Указать, что каждый стек запускается в своей сети. Маршрутизация осуществляется через разные порты на хосте (Port-based Routing).
- **Статус:** Согласовано
- **Результат:** Внедрена архитектура с изолированными сетями.
- **Контекст:**
  > [Inviz](https://github.com/idealic-ai/platform/pull/65#discussion_r2586999729): "Если разьединить то будет более гибко и безопасно... А блю-грин переключался бы по порту на хост машине"
  >
  > [vyprik](https://github.com/idealic-ai/platform/pull/65#discussion_r2589830368): "Обновил: Сетевая изоляция... Стеки не видят друг друга."

### 5. Конфигурация и Переменные (ENV Strategy)

- **Намерение:** Стандартизировать передачу конфигурации через ENV-переменные и обеспечить консистентность.
- **Обоснование:** Необходимо четко разделять переменные, нужные для `docker-compose` (например, порты, имена), и переменные, пробрасываемые внутрь контейнера. Использовать `-e` для явной передачи.
- **Действие:** Внедрить переменные `STACK_NAME`, `COLOR`, `STACK_PORT`. Разделить scope переменных.
- **Статус:** Согласовано
- **Результат:** Принята схема с явным пробросом ENV через Runner.
- **Контекст:**
  > [Inviz](https://github.com/idealic-ai/platform/pull/65#discussion_r2586988838): "стоит юзать -e APP_HOST=idealic-green-poker-runtime для консистентности?"
  >
  > [Inviz](https://github.com/idealic-ai/platform/pull/65#discussion_r2590993337): "Надо определить какие переменные нам необходимы внутри файла докер-композ, а какие только внутри контейнеров"

### 6. Философия Docker Compose

- **Намерение:** Явно задокументировать причины выбора Docker Compose.
- **Обоснование:** Необходимо объяснить команде и будущим разработчикам, почему выбран этот инструмент (изоляция, повторяемость, простота, индустриальный стандарт), чтобы избежать вопросов «почему не K8s».
- **Действие:** Добавить раздел с перечислением преимуществ (15 пунктов от ревьюера).
- **Статус:** Согласовано
- **Результат:** Добавлен раздел мотивации.
- **Контекст:**
  > [Inviz](https://github.com/idealic-ai/platform/pull/65#discussion_r2590953448): "неплохо бы тоже обьяснить почему докер композ юзаем... 1) ... 15)"

### 7. Стиль и Терминология

- **Намерение:** Привести документ к безличному, профессиональному стилю.
- **Обоснование:** Удаление личных местоимений («мы», «вы») делает документ более формальным и долговечным. Латинизмы (типа «Port-based Routing») следует заменять на понятные описания, если они не являются строгими терминами.
- **Действие:** Рефакторинг текста, удаление «мы», упрощение терминов.
- **Статус:** Согласовано
- **Результат:** Стиль документа скорректирован.
- **Контекст:**
  > [Inviz](https://github.com/idealic-ai/platform/pull/65#discussion_r2590957042): "предлагаю убрать мы, вы, ты. Оставить безлично и технологично."
  >
  > [Inviz](https://github.com/idealic-ai/platform/pull/65#discussion_r2591008758): "Port-based Routing тут ничего не добавляет. Убрать латинизмы ненужные"

### 8. Оптимизация Сборки (Build Flags)

- **Намерение:** Оптимизировать процесс сборки и запуска на продакшене.
- **Обоснование:** Использование `--parallel` ускоряет операции. На продакшене сборка не нужна (`--no-build`), так как используются готовые образы. Для локальной разработки нужен `--build`. Кеширование (`cache_from`) критично для скорости CI.
- **Действие:** Указать соответствующие флаги для разных окружений.
- **Статус:** Согласовано
- **Результат:** Уточнены команды запуска.
- **Контекст:**
  > [Inviz](https://github.com/idealic-ai/platform/pull/65#discussion_r2591001465): "ИМХО легче воспользоваться флагом docker compose up --no-build чтоб не билдить на продакшене"
  >
  > [Inviz](https://github.com/idealic-ai/platform/pull/65#discussion_r2591003984): "надо указывать еще build.cache_from для кеширования"

---

## Отчет о валидации

| Comment ID   | Title (Summary)                | Intent # | Status                    |
| ------------ | ------------------------------ | -------- | ------------------------- |
| [2586965160] | Добавить шаг тестирования      | 1        | Included                  |
| [2586968186] | Образы в Registry              | 1        | Included                  |
| [2586973615] | Runner вместо SSH              | 2        | Included                  |
| [2586976595] | Project Name для имен          | 3        | Included                  |
| [2586978345] | Примечание про Edge Downtime   | -        | Skipped (Minor text edit) |
| [2586979900] | Суффиксы vs Префиксы           | 3        | Included                  |
| [2586980570] | Уточнение стратегии Blue-Green | 4        | Included                  |
| [2586981544] | Изоляция сетей                 | 4        | Included                  |
| [2586999729] | Разъединение сетей и порты     | 4        | Included                  |
| [2586984019] | Переменные ENV и слои          | 5        | Included                  |
| [2586988838] | Пример команды деплоя          | 5        | Included                  |
| [2590953448] | Почему Docker Compose (список) | 6        | Included                  |
| [2590957042] | Стиль (безлично)               | 7        | Included                  |
| [2590983708] | Пример переменных STACK\_\*    | 5        | Included                  |
| [2591001465] | Флаг --no-build                | 8        | Included                  |
| [2591003984] | Cache_from                     | 8        | Included                  |
| [2591017469] | Скрипты через Runner           | 2        | Included                  |

[2586965160]: https://github.com/idealic-ai/platform/pull/65#discussion_r2586965160
[2586968186]: https://github.com/idealic-ai/platform/pull/65#discussion_r2586968186
[2586973615]: https://github.com/idealic-ai/platform/pull/65#discussion_r2586973615
[2586976595]: https://github.com/idealic-ai/platform/pull/65#discussion_r2586976595
[2586978345]: https://github.com/idealic-ai/platform/pull/65#discussion_r2586978345
[2586979900]: https://github.com/idealic-ai/platform/pull/65#discussion_r2586979900
[2586980570]: https://github.com/idealic-ai/platform/pull/65#discussion_r2586980570
[2586981544]: https://github.com/idealic-ai/platform/pull/65#discussion_r2586981544
[2586999729]: https://github.com/idealic-ai/platform/pull/65#discussion_r2586999729
[2586984019]: https://github.com/idealic-ai/platform/pull/65#discussion_r2586984019
[2586988838]: https://github.com/idealic-ai/platform/pull/65#discussion_r2586988838
[2590953448]: https://github.com/idealic-ai/platform/pull/65#discussion_r2590953448
[2590957042]: https://github.com/idealic-ai/platform/pull/65#discussion_r2590957042
[2590983708]: https://github.com/idealic-ai/platform/pull/65#discussion_r2590983708
[2591001465]: https://github.com/idealic-ai/platform/pull/65#discussion_r2591001465
[2591003984]: https://github.com/idealic-ai/platform/pull/65#discussion_r2591003984
[2591017469]: https://github.com/idealic-ai/platform/pull/65#discussion_r2591017469
